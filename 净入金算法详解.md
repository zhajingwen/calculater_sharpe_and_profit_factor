# Hyperliquid å‡€å…¥é‡‘ç®—æ³•è¯¦è§£

## ğŸ“‹ ç›®å½•

1. [ç®—æ³•æ¦‚è¿°](#ç®—æ³•æ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [è®¡ç®—å…¬å¼](#è®¡ç®—å…¬å¼)
4. [ç®—æ³•å®ç°](#ç®—æ³•å®ç°)
5. [äº¤æ˜“ç±»å‹åˆ†ç±»](#äº¤æ˜“ç±»å‹åˆ†ç±»)
6. [åº”ç”¨åœºæ™¯](#åº”ç”¨åœºæ™¯)
7. [å®Œæ•´ä»£ç ç¤ºä¾‹](#å®Œæ•´ä»£ç ç¤ºä¾‹)
8. [æµ‹è¯•ç”¨ä¾‹](#æµ‹è¯•ç”¨ä¾‹)

---

## ç®—æ³•æ¦‚è¿°

### ä»€ä¹ˆæ˜¯å‡€å…¥é‡‘ï¼ˆTrue Capitalï¼‰ï¼Ÿ

**å‡€å…¥é‡‘**æ˜¯æŒ‡ç”¨æˆ·å®é™…æŠ•å…¥åˆ°äº¤æ˜“è´¦æˆ·çš„å‡€èµ„é‡‘é‡ï¼Œæ’é™¤äº†äº¤æ˜“ç›ˆäºçš„å½±å“ï¼Œåªè®¡ç®—çº¯ç²¹çš„èµ„é‡‘æµå…¥å’Œæµå‡ºã€‚

### ä¸ºä»€ä¹ˆéœ€è¦è®¡ç®—å‡€å…¥é‡‘ï¼Ÿ

åœ¨é‡åŒ–äº¤æ˜“åˆ†æä¸­ï¼Œå‡†ç¡®è®¡ç®—æ”¶ç›Šç‡ã€å¤æ™®æ¯”ç‡ã€æœ€å¤§å›æ’¤ç­‰æŒ‡æ ‡æ—¶ï¼Œå¿…é¡»ä½¿ç”¨**çœŸå®æœ¬é‡‘**ä½œä¸ºåŸºå‡†ï¼Œè€Œä¸æ˜¯è´¦æˆ·ä½™é¢ã€‚

**é—®é¢˜ç¤ºä¾‹**ï¼š
- ç”¨æˆ·å……å€¼ $10,000
- äº¤æ˜“ç›ˆåˆ© $5,000ï¼ˆè´¦æˆ·ä½™é¢ $15,000ï¼‰
- æç° $8,000ï¼ˆè´¦æˆ·ä½™é¢ $7,000ï¼‰
- æ­¤æ—¶ç´¯è®¡æ”¶ç›Šç‡åº”è¯¥æ˜¯å¤šå°‘ï¼Ÿ

**âŒ é”™è¯¯è®¡ç®—**ï¼šåŸºäºè´¦æˆ·ä½™é¢
```
å‡€åˆ©æ¶¦ = $7,000 - $10,000 = -$3,000
æ”¶ç›Šç‡ = -30%ï¼ˆé”™è¯¯ï¼ï¼‰
```

**âœ… æ­£ç¡®è®¡ç®—**ï¼šåŸºäºå‡€å…¥é‡‘
```
å‡€å…¥é‡‘ = $10,000 - $8,000 = $2,000
äº¤æ˜“ç›ˆäº = $5,000
å½“å‰ä½™é¢ = $7,000
æ”¶ç›Šç‡ = $5,000 / $2,000 = 250%ï¼ˆæ­£ç¡®ï¼ï¼‰
```

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. èµ„é‡‘æµåŠ¨ç±»å‹

| ç±»å‹ | è‹±æ–‡ | å½±å“å‡€å…¥é‡‘ | è¯´æ˜ |
|------|------|-----------|------|
| **å……å€¼** | Deposit | âœ… å¢åŠ  | ä»å¤–éƒ¨é’±åŒ…å……å€¼åˆ°äº¤æ˜“è´¦æˆ· |
| **æç°** | Withdraw | âœ… å‡å°‘ | ä»äº¤æ˜“è´¦æˆ·æç°åˆ°å¤–éƒ¨é’±åŒ… |
| **å¤–éƒ¨è½¬å…¥** | External In | âœ… å¢åŠ  | åˆ«äººé€šè¿‡ send è½¬ç»™æˆ‘çš„èµ„é‡‘ |
| **å¤–éƒ¨è½¬å‡º** | External Out | âœ… å‡å°‘ | æˆ‘é€šè¿‡ send è½¬ç»™åˆ«äººçš„èµ„é‡‘ |
| **å†…éƒ¨è½¬è´¦** | Internal Transfer | âŒ ä¸å½±å“ | Perp â†” Spot è´¦æˆ·ä¹‹é—´çš„è½¬è´¦ |

### 2. Hyperliquid è´¦æˆ·ç»“æ„

Hyperliquid äº¤æ˜“æ‰€æœ‰ä¸¤ä¸ªå­è´¦æˆ·ï¼š
- **Perpï¼ˆæ°¸ç»­åˆçº¦è´¦æˆ·ï¼‰**ï¼šç”¨äºæ æ†äº¤æ˜“
- **Spotï¼ˆç°è´§è´¦æˆ·ï¼‰**ï¼šç”¨äºç°è´§äº¤æ˜“

ç”¨æˆ·å¯ä»¥åœ¨è¿™ä¸¤ä¸ªè´¦æˆ·ä¹‹é—´è‡ªç”±è½¬è´¦ï¼Œä½†è¿™**ä¸å½±å“æ€»èµ„é‡‘é‡**ã€‚

---

## è®¡ç®—å…¬å¼

### æ ¸å¿ƒå…¬å¼

```python
true_capital = deposits - withdrawals + external_to_spot - external_out
```

### å…¬å¼è¯¦è§£

```
å‡€å…¥é‡‘ = æ€»å……å€¼ - æ€»æç° + å¤–éƒ¨è½¬å…¥ - å¤–éƒ¨è½¬å‡º
```

| ç¬¦å· | å«ä¹‰ | ç¤ºä¾‹ |
|------|------|------|
| `deposits` | ç”¨æˆ·å……å€¼æ€»é¢ | +$10,000 |
| `withdrawals` | ç”¨æˆ·æç°æ€»é¢ | -$5,000 |
| `external_to_spot` | åˆ«äººè½¬å…¥çš„é‡‘é¢ | +$1,000 |
| `external_out` | è½¬ç»™åˆ«äººçš„é‡‘é¢ | -$500 |
| **`true_capital`** | **å‡€å…¥é‡‘** | **$5,500** |

---

## ç®—æ³•å®ç°

### æ ¸å¿ƒå‡½æ•°ï¼š`calculate_true_capital()`

```python
def calculate_true_capital(self, user_address: str, ledger_records: List[Dict]) -> Dict[str, float]:
    """
    è®¡ç®—çœŸå®æœ¬é‡‘ï¼ˆç®—æ³•å®Œæ•´ç‰ˆï¼‰

    è®¡ç®—å…¬å¼:
    true_capital = deposits - withdrawals + external_to_spot - external_out

    è€ƒè™‘å› ç´ :
    1. âœ… å……å€¼å’Œæç°ï¼ˆdeposit/withdrawï¼‰
    2. âœ… å¤–éƒ¨è½¬å…¥åˆ° Spotï¼ˆåˆ«äººé€šè¿‡ send è½¬ç»™æˆ‘çš„ï¼‰
    3. âœ… å¤–éƒ¨è½¬å‡ºï¼ˆæˆ‘é€šè¿‡ send è½¬ç»™åˆ«äººçš„ï¼‰
    4. âŒ æ’é™¤å†…éƒ¨ Perp â†” Spot è½¬è´¦ï¼ˆä¸å½±å“æ€»èµ„é‡‘ï¼‰

    å‚æ•°ï¼š
        user_address: ç”¨æˆ·åœ°å€ï¼ˆä¾‹å¦‚ï¼š0x7717a7a245d9f950e586822b8c9b46863ed7bd7eï¼‰
        ledger_records: è´¦æœ¬è®°å½•åˆ—è¡¨

    è¿”å›ï¼š
        å­—å…¸ï¼ŒåŒ…å«ï¼š
        - total_deposits: æ€»å……å€¼
        - total_withdrawals: æ€»æç°
        - external_to_spot: å¤–éƒ¨è½¬å…¥ Spot
        - external_out: å¤–éƒ¨è½¬å‡º
        - true_capital: çœŸå®æœ¬é‡‘
    """
    # åˆå§‹åŒ–å„é¡¹ç»Ÿè®¡
    total_deposits = 0.0
    total_withdrawals = 0.0
    external_to_spot = 0.0
    external_out = 0.0

    # è½¬æ¢åœ°å€ä¸ºå°å†™ï¼ˆç”¨äºæ¯”è¾ƒï¼‰
    addr_lower = user_address.lower()

    # éå†æ‰€æœ‰è´¦æœ¬è®°å½•
    for record in ledger_records:
        delta = record.get('delta', {})
        delta_type = delta.get('type', '')

        # ==================== ç±»å‹ A: å……å€¼ ====================
        if delta_type == 'deposit':
            amount = safe_float(delta.get('usdc', 0))
            total_deposits += amount
            print(f"  [å……å€¼] +${amount:.2f}")

        # ==================== ç±»å‹ B: æç° ====================
        elif delta_type == 'withdraw':
            amount = safe_float(delta.get('usdc', 0))
            total_withdrawals += abs(amount)  # æç°å¯èƒ½æ˜¯è´Ÿæ•°ï¼Œå–ç»å¯¹å€¼
            print(f"  [æç°] -${abs(amount):.2f}")

        # ==================== ç±»å‹ C: è½¬è´¦ï¼ˆæœ€å¤æ‚ï¼‰ ====================
        elif delta_type == 'send':
            amount = safe_float(delta.get('amount', 0))
            user = delta.get('user', '').lower()
            dest = delta.get('destination', '').lower()
            source_dex = delta.get('sourceDex', '')
            dest_dex = delta.get('destinationDex', '')

            # ---------- C1: å†…éƒ¨è½¬è´¦ï¼ˆPerp â†” Spotï¼‰----------
            is_internal_transfer = (user == addr_lower and dest == addr_lower)

            if is_internal_transfer:
                # å†…éƒ¨è½¬è´¦ï¼Œä¸å½±å“æ€»èµ„é‡‘ï¼Œè·³è¿‡
                print(f"  [å†…éƒ¨è½¬è´¦] {source_dex} â†’ {dest_dex} ${amount:.2f} (ä¸è®¡å…¥)")
                continue

            # ---------- C2: å¤–éƒ¨è½¬å…¥åˆ° Spot ----------
            if user != addr_lower and dest == addr_lower and dest_dex == 'spot':
                external_to_spot += amount
                print(f"  [å¤–éƒ¨è½¬å…¥] +${amount:.2f} (from {user[:10]}...)")

            # ---------- C3: å¤–éƒ¨è½¬å‡º ----------
            elif user == addr_lower and dest != addr_lower:
                external_out += amount
                print(f"  [å¤–éƒ¨è½¬å‡º] -${amount:.2f} (to {dest[:10]}...)")

    # è®¡ç®—å‡€å…¥é‡‘
    true_capital = (
        total_deposits - total_withdrawals +
        external_to_spot - external_out
    )

    # è¿”å›è¯¦ç»†ç»“æœ
    return {
        "total_deposits": total_deposits,
        "total_withdrawals": total_withdrawals,
        "external_to_spot": external_to_spot,
        "external_out": external_out,
        "true_capital": true_capital
    }
```

### è¾…åŠ©å‡½æ•°ï¼š`safe_float()`

```python
def safe_float(value: Any, default: float = 0.0) -> float:
    """
    å®‰å…¨åœ°å°†å€¼è½¬æ¢ä¸ºæµ®ç‚¹æ•°

    å‚æ•°ï¼š
        value: ä»»æ„ç±»å‹çš„å€¼
        default: è½¬æ¢å¤±è´¥æ—¶çš„é»˜è®¤å€¼

    è¿”å›ï¼š
        float: è½¬æ¢åçš„æµ®ç‚¹æ•°
    """
    try:
        if value is None:
            return default
        if isinstance(value, str):
            return float(value) if value.strip() else default
        return float(value)
    except (ValueError, TypeError):
        return default
```

---

## äº¤æ˜“ç±»å‹åˆ†ç±»

### ç±»å‹ Aï¼šå……å€¼ï¼ˆDepositï¼‰

#### æ•°æ®ç»“æ„ç¤ºä¾‹
```json
{
    "delta": {
        "type": "deposit",
        "usdc": "10000.5"
    }
}
```

#### å¤„ç†é€»è¾‘
```python
if delta_type == 'deposit':
    amount = safe_float(delta.get('usdc', 0))
    total_deposits += amount  # âœ… å¢åŠ å‡€å…¥é‡‘
```

#### ä¸šåŠ¡å«ä¹‰
- ç”¨æˆ·ä»å¤–éƒ¨é’±åŒ…ï¼ˆå¦‚ MetaMaskï¼‰å‘ Hyperliquid äº¤æ˜“è´¦æˆ·å……å€¼
- **å¢åŠ å‡€å…¥é‡‘**

---

### ç±»å‹ Bï¼šæç°ï¼ˆWithdrawï¼‰

#### æ•°æ®ç»“æ„ç¤ºä¾‹
```json
{
    "delta": {
        "type": "withdraw",
        "usdc": "-5000.0"
    }
}
```

#### å¤„ç†é€»è¾‘
```python
elif delta_type == 'withdraw':
    amount = safe_float(delta.get('usdc', 0))
    total_withdrawals += abs(amount)  # âœ… å‡å°‘å‡€å…¥é‡‘ï¼ˆå–ç»å¯¹å€¼ï¼‰
```

#### ä¸šåŠ¡å«ä¹‰
- ç”¨æˆ·ä» Hyperliquid äº¤æ˜“è´¦æˆ·æç°åˆ°å¤–éƒ¨é’±åŒ…
- **å‡å°‘å‡€å…¥é‡‘**
- **æ³¨æ„**ï¼šæç°é‡‘é¢å¯èƒ½æ˜¯è´Ÿæ•°ï¼Œéœ€ä½¿ç”¨ `abs()` å–ç»å¯¹å€¼

---

### ç±»å‹ Cï¼šè½¬è´¦ï¼ˆSendï¼‰- æœ€å¤æ‚çš„æƒ…å†µ

#### æ•°æ®ç»“æ„ç¤ºä¾‹
```json
{
    "delta": {
        "type": "send",
        "amount": "1000.0",
        "user": "0xabc...123",
        "destination": "0xdef...456",
        "sourceDex": "perp",
        "destinationDex": "spot"
    }
}
```

#### å­—æ®µè¯´æ˜
- `amount`: è½¬è´¦é‡‘é¢
- `user`: è½¬å‡ºæ–¹åœ°å€
- `destination`: è½¬å…¥æ–¹åœ°å€
- `sourceDex`: æ¥æºè´¦æˆ·ç±»å‹ï¼ˆ`perp` æˆ– `spot`ï¼‰
- `destinationDex`: ç›®æ ‡è´¦æˆ·ç±»å‹ï¼ˆ`perp` æˆ– `spot`ï¼‰

---

### C1ï¼šå†…éƒ¨è½¬è´¦ï¼ˆPerp â†” Spotï¼‰

#### åˆ¤æ–­æ¡ä»¶
```python
is_internal_transfer = (user == addr_lower and dest == addr_lower)
```

**æ¡ä»¶è§£é‡Š**ï¼š
- è½¬å‡ºæ–¹æ˜¯è‡ªå·± **ä¸”** è½¬å…¥æ–¹æ˜¯è‡ªå·±
- å³ï¼šåŒä¸€ä¸ªç”¨æˆ·åœ¨ Perp å’Œ Spot è´¦æˆ·ä¹‹é—´è½¬è´¦

#### å¤„ç†é€»è¾‘
```python
if is_internal_transfer:
    # âŒ ä¸å½±å“æ€»èµ„é‡‘ï¼Œè·³è¿‡
    continue
```

#### ç¤ºä¾‹åœºæ™¯
```
ç”¨æˆ·åœ°å€: 0x7717...bd7e

æ“ä½œï¼šä» Perp è½¬ 1000 USDC åˆ° Spot
æ•°æ®ï¼š
  user: 0x7717...bd7e
  destination: 0x7717...bd7e
  amount: 1000

åˆ¤æ–­ï¼šuser == destination == æˆ‘çš„åœ°å€
ç»“æœï¼šå†…éƒ¨è½¬è´¦ï¼Œä¸è®¡å…¥å‡€å…¥é‡‘
```

---

### C2ï¼šå¤–éƒ¨è½¬å…¥ Spot

#### åˆ¤æ–­æ¡ä»¶
```python
if user != addr_lower and dest == addr_lower and dest_dex == 'spot':
    external_to_spot += amount  # âœ… å¢åŠ å‡€å…¥é‡‘
```

**æ¡ä»¶è§£é‡Š**ï¼š
- è½¬å‡ºæ–¹**ä¸æ˜¯**è‡ªå·±ï¼ˆåˆ«äººè½¬ç»™æˆ‘ï¼‰
- è½¬å…¥æ–¹**æ˜¯**è‡ªå·±
- ç›®æ ‡è´¦æˆ·ç±»å‹æ˜¯ `spot`

#### å¤„ç†é€»è¾‘
```python
external_to_spot += amount  # å¢åŠ å‡€å…¥é‡‘
```

#### ç¤ºä¾‹åœºæ™¯
```
æˆ‘çš„åœ°å€: 0x7717...bd7e
æœ‹å‹åœ°å€: 0xabc...123

æ“ä½œï¼šæœ‹å‹é€šè¿‡ send è½¬ 500 USDC ç»™æˆ‘çš„ Spot è´¦æˆ·
æ•°æ®ï¼š
  user: 0xabc...123 (æœ‹å‹)
  destination: 0x7717...bd7e (æˆ‘)
  destinationDex: spot
  amount: 500

åˆ¤æ–­ï¼šuser â‰  æˆ‘çš„åœ°å€ && destination == æˆ‘çš„åœ°å€ && destinationDex == 'spot'
ç»“æœï¼šå¤–éƒ¨è½¬å…¥ï¼Œå¢åŠ å‡€å…¥é‡‘ +$500
```

---

### C3ï¼šå¤–éƒ¨è½¬å‡º

#### åˆ¤æ–­æ¡ä»¶
```python
elif user == addr_lower and dest != addr_lower:
    external_out += amount  # âœ… å‡å°‘å‡€å…¥é‡‘
```

**æ¡ä»¶è§£é‡Š**ï¼š
- è½¬å‡ºæ–¹**æ˜¯**è‡ªå·±
- è½¬å…¥æ–¹**ä¸æ˜¯**è‡ªå·±ï¼ˆæˆ‘è½¬ç»™åˆ«äººï¼‰

#### å¤„ç†é€»è¾‘
```python
external_out += amount  # å‡å°‘å‡€å…¥é‡‘
```

#### ç¤ºä¾‹åœºæ™¯
```
æˆ‘çš„åœ°å€: 0x7717...bd7e
æœ‹å‹åœ°å€: 0xdef...456

æ“ä½œï¼šæˆ‘é€šè¿‡ send è½¬ 300 USDC ç»™æœ‹å‹
æ•°æ®ï¼š
  user: 0x7717...bd7e (æˆ‘)
  destination: 0xdef...456 (æœ‹å‹)
  amount: 300

åˆ¤æ–­ï¼šuser == æˆ‘çš„åœ°å€ && destination â‰  æˆ‘çš„åœ°å€
ç»“æœï¼šå¤–éƒ¨è½¬å‡ºï¼Œå‡å°‘å‡€å…¥é‡‘ -$300
```

---

## åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šè®¡ç®—ç´¯è®¡æ”¶ç›Šç‡

**ä»£ç ä½ç½®**ï¼š`apex_fork.py:822-891`

```python
def calculate_return_metrics(
    self,
    current_value: float,
    true_capital: float,
    total_cumulative_pnl: float,
    first_trade_time: int,
    last_trade_time: int
) -> Dict[str, float]:
    """
    è®¡ç®—ç´¯è®¡æ”¶ç›Šç‡å’Œå¹´åŒ–æ”¶ç›Šç‡

    ä½¿ç”¨å‡€å…¥é‡‘ä½œä¸ºåŸºå‡†ï¼Œç¡®ä¿æ”¶ç›Šç‡è®¡ç®—å‡†ç¡®
    """
    # è®¡ç®—ç´¯è®¡æ”¶ç›Šç‡
    if true_capital > 0:
        cumulative_return = (total_cumulative_pnl / true_capital) * 100
    else:
        cumulative_return = 0.0

    return {
        "cumulative_return": cumulative_return,
        "annualized_return": annualized_return,
        "net_profit_trading": total_cumulative_pnl,
        "trading_days": trading_days
    }
```

**ä¸ºä»€ä¹ˆéœ€è¦å‡€å…¥é‡‘ï¼Ÿ**

| åœºæ™¯ | åŸºäºè´¦æˆ·ä½™é¢ï¼ˆâŒ é”™è¯¯ï¼‰ | åŸºäºå‡€å…¥é‡‘ï¼ˆâœ… æ­£ç¡®ï¼‰ |
|------|----------------------|---------------------|
| å……å€¼ $10,000 | - | - |
| ç›ˆåˆ© $2,000 | è´¦æˆ·ä½™é¢ $12,000 | - |
| æç° $5,000 | è´¦æˆ·ä½™é¢ $7,000 | å‡€å…¥é‡‘ $5,000 |
| **æ”¶ç›Šç‡** | $2,000 / $12,000 = 16.7% | $2,000 / $5,000 = 40% |

---

### åœºæ™¯ 2ï¼šè®¡ç®—å¤æ™®æ¯”ç‡ï¼ˆSharpe Ratioï¼‰

**ä»£ç ä½ç½®**ï¼š`apex_fork.py:952-1065`

```python
def calculate_sharpe_ratio_on_capital(
    self,
    fills: List[Dict],
    true_capital: float,
    risk_free_rate: float = 0.03
) -> Dict[str, float]:
    """
    åŸºäºçœŸå®æœ¬é‡‘è®¡ç®—å¤æ™®æ¯”ç‡

    ä¼˜åŠ¿ï¼š
    - âœ… ä¸å—æ æ†å½±å“
    - âœ… çœŸå®åæ˜ é£é™©æ”¶ç›Šæ¯”
    - âœ… ä¸ç´¯è®¡æ”¶ç›Šç‡è®¡ç®—é€»è¾‘ä¸€è‡´
    """
    trade_returns = []

    for fill in fills:
        closed_pnl = float(fill.get('closedPnl', 0))

        if closed_pnl == 0:
            continue

        # âœ… ä½¿ç”¨å‡€å…¥é‡‘è®¡ç®—æ”¶ç›Šç‡
        trade_return = closed_pnl / true_capital
        trade_returns.append(trade_return)

    # è®¡ç®—å¤æ™®æ¯”ç‡
    mean_return = sum(trade_returns) / len(trade_returns)
    std_dev = calculate_std_dev(trade_returns)
    sharpe_ratio = (mean_return - risk_free_rate) / std_dev

    return {
        "sharpe_ratio": sharpe_ratio,
        "annualized_sharpe": sharpe_ratio * math.sqrt(trades_per_year)
    }
```

**ä¸ºä»€ä¹ˆä½¿ç”¨å‡€å…¥é‡‘ï¼Ÿ**

```
å‡è®¾ï¼š
- æŠ•å…¥æœ¬é‡‘: $1,000
- ä½¿ç”¨ 10 å€æ æ†
- æŒä»“ä»·å€¼: $10,000

äº¤æ˜“äºæŸ $500ï¼š
  âŒ åŸºäºæŒä»“ä»·å€¼: -$500 / $10,000 = -5%ï¼ˆä¸¥é‡ä½ä¼°é£é™©ï¼‰
  âœ… åŸºäºå‡€å…¥é‡‘: -$500 / $1,000 = -50%ï¼ˆçœŸå®é£é™©ï¼‰
```

---

### åœºæ™¯ 3ï¼šè®¡ç®—æœ€å¤§å›æ’¤ï¼ˆMax Drawdownï¼‰

**ä»£ç ä½ç½®**ï¼š`apex_fork.py:1067-1205`

```python
def calculate_max_drawdown_on_capital(
    self,
    fills: List[Dict],
    true_capital: float
) -> Dict[str, float]:
    """
    åŸºäºçœŸå®æœ¬é‡‘è®¡ç®—æœ€å¤§å›æ’¤

    å…³é”®æ”¹è¿›ï¼šä½¿ç”¨å‡€å…¥é‡‘è€ŒéæŒä»“ä»·å€¼ï¼Œä¸å—æ æ†å½±å“
    """
    trade_returns = []

    for fill in fills:
        closed_pnl = float(fill.get('closedPnl', 0))

        if closed_pnl == 0:
            continue

        # âœ… ä½¿ç”¨å‡€å…¥é‡‘è®¡ç®—æ”¶ç›Šç‡
        trade_return = closed_pnl / true_capital

        # é™åˆ¶å•ç¬”æ”¶ç›Šç‡èŒƒå›´ï¼š[-0.99, 10.0]
        trade_return = max(-0.99, min(trade_return, 10.0))
        trade_returns.append(trade_return)

    # æ„å»ºç´¯è®¡æ”¶ç›Šç‡åºåˆ—
    cumulative_returns = []
    cumulative = 1.0

    for ret in trade_returns:
        cumulative *= (1 + ret)
        cumulative_returns.append(cumulative)

    # è®¡ç®—æœ€å¤§å›æ’¤
    peak = cumulative_returns[0]
    max_drawdown = 0

    for value in cumulative_returns:
        if value > peak:
            peak = value

        drawdown = (peak - value) / peak * 100

        if drawdown > max_drawdown:
            max_drawdown = drawdown

    return {
        "max_drawdown_pct": max_drawdown,
        "peak_return": (peak - 1) * 100,
        "total_trades": len(trade_returns)
    }
```

**æ æ†å¯¹å›æ’¤è®¡ç®—çš„å½±å“**ï¼š

| åœºæ™¯ | 10å€æ æ† | åŸºäºæŒä»“ä»·å€¼ï¼ˆâŒï¼‰ | åŸºäºå‡€å…¥é‡‘ï¼ˆâœ…ï¼‰ |
|------|---------|-------------------|-----------------|
| æŠ•å…¥æœ¬é‡‘ | $100 | - | - |
| æŒä»“ä»·å€¼ | $1,000 | - | - |
| äºæŸé‡‘é¢ | $50 | - | - |
| **å›æ’¤ç‡** | - | -50/1000 = **-5%** | -50/100 = **-50%** |

---

## å®Œæ•´ä»£ç ç¤ºä¾‹

### ä¸»ç¨‹åºç¤ºä¾‹

```python
from typing import List, Dict, Any
from decimal import Decimal

def safe_float(value: Any, default: float = 0.0) -> float:
    """å®‰å…¨åœ°å°†å€¼è½¬æ¢ä¸ºæµ®ç‚¹æ•°"""
    try:
        if value is None:
            return default
        if isinstance(value, str):
            return float(value) if value.strip() else default
        return float(value)
    except (ValueError, TypeError):
        return default


class TrueCapitalCalculator:
    """å‡€å…¥é‡‘è®¡ç®—å™¨"""

    def calculate_true_capital(
        self,
        user_address: str,
        ledger_records: List[Dict]
    ) -> Dict[str, float]:
        """
        è®¡ç®—çœŸå®æœ¬é‡‘

        å‚æ•°ï¼š
            user_address: ç”¨æˆ·åœ°å€
            ledger_records: è´¦æœ¬è®°å½•åˆ—è¡¨

        è¿”å›ï¼š
            åŒ…å«å‡€å…¥é‡‘è¯¦æƒ…çš„å­—å…¸
        """
        total_deposits = 0.0
        total_withdrawals = 0.0
        external_to_spot = 0.0
        external_out = 0.0

        addr_lower = user_address.lower()

        print(f"\nåˆ†æåœ°å€: {user_address}")
        print("=" * 60)

        for record in ledger_records:
            delta = record.get('delta', {})
            delta_type = delta.get('type', '')

            if delta_type == 'deposit':
                amount = safe_float(delta.get('usdc', 0))
                total_deposits += amount
                print(f"  [å……å€¼] +${amount:,.2f}")

            elif delta_type == 'withdraw':
                amount = safe_float(delta.get('usdc', 0))
                total_withdrawals += abs(amount)
                print(f"  [æç°] -${abs(amount):,.2f}")

            elif delta_type == 'send':
                amount = safe_float(delta.get('amount', 0))
                user = delta.get('user', '').lower()
                dest = delta.get('destination', '').lower()
                source_dex = delta.get('sourceDex', '')
                dest_dex = delta.get('destinationDex', '')

                is_internal_transfer = (user == addr_lower and dest == addr_lower)

                if is_internal_transfer:
                    print(f"  [å†…éƒ¨è½¬è´¦] {source_dex} â†’ {dest_dex} ${amount:,.2f} (ä¸è®¡å…¥)")
                    continue

                if user != addr_lower and dest == addr_lower and dest_dex == 'spot':
                    external_to_spot += amount
                    print(f"  [å¤–éƒ¨è½¬å…¥] +${amount:,.2f}")

                elif user == addr_lower and dest != addr_lower:
                    external_out += amount
                    print(f"  [å¤–éƒ¨è½¬å‡º] -${amount:,.2f}")

        true_capital = (
            total_deposits - total_withdrawals +
            external_to_spot - external_out
        )

        print("=" * 60)
        print(f"\nğŸ“Š ç»Ÿè®¡ç»“æœ:")
        print(f"  æ€»å……å€¼:     +${total_deposits:,.2f}")
        print(f"  æ€»æç°:     -${total_withdrawals:,.2f}")
        print(f"  å¤–éƒ¨è½¬å…¥:   +${external_to_spot:,.2f}")
        print(f"  å¤–éƒ¨è½¬å‡º:   -${external_out:,.2f}")
        print(f"  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        print(f"  å‡€å…¥é‡‘:     ${true_capital:,.2f}")

        return {
            "total_deposits": total_deposits,
            "total_withdrawals": total_withdrawals,
            "external_to_spot": external_to_spot,
            "external_out": external_out,
            "true_capital": true_capital
        }


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    calculator = TrueCapitalCalculator()

    # æ¨¡æ‹Ÿè´¦æœ¬è®°å½•
    ledger_records = [
        {"delta": {"type": "deposit", "usdc": "10000"}},
        {"delta": {"type": "withdraw", "usdc": "-3000"}},
        {
            "delta": {
                "type": "send",
                "amount": "1000",
                "user": "0x7717a7a245d9f950e586822b8c9b46863ed7bd7e",
                "destination": "0x7717a7a245d9f950e586822b8c9b46863ed7bd7e",
                "sourceDex": "perp",
                "destinationDex": "spot"
            }
        },
        {
            "delta": {
                "type": "send",
                "amount": "500",
                "user": "0xabc123",
                "destination": "0x7717a7a245d9f950e586822b8c9b46863ed7bd7e",
                "destinationDex": "spot"
            }
        },
        {
            "delta": {
                "type": "send",
                "amount": "200",
                "user": "0x7717a7a245d9f950e586822b8c9b46863ed7bd7e",
                "destination": "0xdef456"
            }
        }
    ]

    result = calculator.calculate_true_capital(
        user_address="0x7717a7a245d9f950e586822b8c9b46863ed7bd7e",
        ledger_records=ledger_records
    )
```

### è¿è¡Œç»“æœç¤ºä¾‹

```
åˆ†æåœ°å€: 0x7717a7a245d9f950e586822b8c9b46863ed7bd7e
============================================================
  [å……å€¼] +$10,000.00
  [æç°] -$3,000.00
  [å†…éƒ¨è½¬è´¦] perp â†’ spot $1,000.00 (ä¸è®¡å…¥)
  [å¤–éƒ¨è½¬å…¥] +$500.00
  [å¤–éƒ¨è½¬å‡º] -$200.00
============================================================

ğŸ“Š ç»Ÿè®¡ç»“æœ:
  æ€»å……å€¼:     +$10,000.00
  æ€»æç°:     -$3,000.00
  å¤–éƒ¨è½¬å…¥:   +$500.00
  å¤–éƒ¨è½¬å‡º:   -$200.00
  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  å‡€å…¥é‡‘:     $7,300.00
```

---

## æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•ç”¨ä¾‹ 1ï¼šçº¯å……å€¼æç°

```python
def test_case_1():
    """æµ‹è¯•ç”¨ä¾‹ 1: åªæœ‰å……å€¼å’Œæç°"""
    ledger_records = [
        {"delta": {"type": "deposit", "usdc": "10000"}},
        {"delta": {"type": "deposit", "usdc": "5000"}},
        {"delta": {"type": "withdraw", "usdc": "-3000"}},
    ]

    calculator = TrueCapitalCalculator()
    result = calculator.calculate_true_capital(
        user_address="0x7717a7a245d9f950e586822b8c9b46863ed7bd7e",
        ledger_records=ledger_records
    )

    # é¢„æœŸç»“æœ
    expected_true_capital = 10000 + 5000 - 3000  # = 12000

    assert result['true_capital'] == expected_true_capital
    print("âœ… æµ‹è¯•ç”¨ä¾‹ 1 é€šè¿‡")
```

### æµ‹è¯•ç”¨ä¾‹ 2ï¼šå†…éƒ¨è½¬è´¦ä¸å½±å“å‡€å…¥é‡‘

```python
def test_case_2():
    """æµ‹è¯•ç”¨ä¾‹ 2: å†…éƒ¨è½¬è´¦ï¼ˆPerp â†” Spotï¼‰"""
    my_address = "0x7717a7a245d9f950e586822b8c9b46863ed7bd7e"

    ledger_records = [
        {"delta": {"type": "deposit", "usdc": "10000"}},
        {
            "delta": {
                "type": "send",
                "amount": "5000",
                "user": my_address,
                "destination": my_address,
                "sourceDex": "perp",
                "destinationDex": "spot"
            }
        },
        {
            "delta": {
                "type": "send",
                "amount": "2000",
                "user": my_address,
                "destination": my_address,
                "sourceDex": "spot",
                "destinationDex": "perp"
            }
        }
    ]

    calculator = TrueCapitalCalculator()
    result = calculator.calculate_true_capital(
        user_address=my_address,
        ledger_records=ledger_records
    )

    # é¢„æœŸç»“æœï¼šå†…éƒ¨è½¬è´¦ä¸å½±å“å‡€å…¥é‡‘
    expected_true_capital = 10000  # åªæœ‰å……å€¼

    assert result['true_capital'] == expected_true_capital
    print("âœ… æµ‹è¯•ç”¨ä¾‹ 2 é€šè¿‡")
```

### æµ‹è¯•ç”¨ä¾‹ 3ï¼šå¤–éƒ¨è½¬å…¥è½¬å‡º

```python
def test_case_3():
    """æµ‹è¯•ç”¨ä¾‹ 3: å¤–éƒ¨è½¬å…¥å’Œè½¬å‡º"""
    my_address = "0x7717a7a245d9f950e586822b8c9b46863ed7bd7e"
    friend_address = "0xabc123"

    ledger_records = [
        {"delta": {"type": "deposit", "usdc": "10000"}},
        {
            "delta": {
                "type": "send",
                "amount": "1000",
                "user": friend_address,
                "destination": my_address,
                "destinationDex": "spot"
            }
        },
        {
            "delta": {
                "type": "send",
                "amount": "500",
                "user": my_address,
                "destination": friend_address
            }
        }
    ]

    calculator = TrueCapitalCalculator()
    result = calculator.calculate_true_capital(
        user_address=my_address,
        ledger_records=ledger_records
    )

    # é¢„æœŸç»“æœ
    expected_true_capital = 10000 + 1000 - 500  # = 10500

    assert result['true_capital'] == expected_true_capital
    print("âœ… æµ‹è¯•ç”¨ä¾‹ 3 é€šè¿‡")
```

### æµ‹è¯•ç”¨ä¾‹ 4ï¼šç»¼åˆåœºæ™¯

```python
def test_case_4():
    """æµ‹è¯•ç”¨ä¾‹ 4: ç»¼åˆåœºæ™¯"""
    my_address = "0x7717a7a245d9f950e586822b8c9b46863ed7bd7e"
    friend_address = "0xabc123"

    ledger_records = [
        {"delta": {"type": "deposit", "usdc": "10000"}},      # +10000
        {"delta": {"type": "withdraw", "usdc": "-2000"}},     # -2000
        {
            "delta": {
                "type": "send",
                "amount": "3000",
                "user": my_address,
                "destination": my_address,
                "sourceDex": "perp",
                "destinationDex": "spot"
            }
        },  # å†…éƒ¨è½¬è´¦ï¼Œä¸è®¡å…¥
        {
            "delta": {
                "type": "send",
                "amount": "1500",
                "user": friend_address,
                "destination": my_address,
                "destinationDex": "spot"
            }
        },  # +1500
        {
            "delta": {
                "type": "send",
                "amount": "800",
                "user": my_address,
                "destination": friend_address
            }
        },  # -800
        {"delta": {"type": "deposit", "usdc": "5000"}},       # +5000
    ]

    calculator = TrueCapitalCalculator()
    result = calculator.calculate_true_capital(
        user_address=my_address,
        ledger_records=ledger_records
    )

    # é¢„æœŸç»“æœ
    expected_true_capital = (
        10000 + 5000  # å……å€¼
        - 2000        # æç°
        + 1500        # å¤–éƒ¨è½¬å…¥
        - 800         # å¤–éƒ¨è½¬å‡º
    )  # = 13700

    assert result['true_capital'] == expected_true_capital
    assert result['total_deposits'] == 15000
    assert result['total_withdrawals'] == 2000
    assert result['external_to_spot'] == 1500
    assert result['external_out'] == 800

    print("âœ… æµ‹è¯•ç”¨ä¾‹ 4 é€šè¿‡")
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```python
if __name__ == "__main__":
    print("å¼€å§‹è¿è¡Œæµ‹è¯•ç”¨ä¾‹...\n")

    test_case_1()
    test_case_2()
    test_case_3()
    test_case_4()

    print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡ï¼")
```

---

## ç®—æ³•ä¼˜åŠ¿æ€»ç»“

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| âœ… **å‡†ç¡®æ€§** | æ’é™¤äº¤æ˜“ç›ˆäºï¼Œåªè®¡ç®—èµ„é‡‘æµå…¥æµå‡º |
| âœ… **å®Œæ•´æ€§** | è€ƒè™‘å……å€¼ã€æç°ã€è½¬è´¦ç­‰æ‰€æœ‰èµ„é‡‘æµåŠ¨ |
| âœ… **æ™ºèƒ½è¿‡æ»¤** | è‡ªåŠ¨è¯†åˆ«å¹¶æ’é™¤å†…éƒ¨è½¬è´¦ï¼ˆPerp â†” Spotï¼‰ |
| âœ… **çœŸå®åæ˜ ** | å‡†ç¡®åæ˜ ç”¨æˆ·çš„èµ„é‡‘ä½¿ç”¨æ•ˆç‡ |
| âœ… **ä¸å—æ æ†å½±å“** | åŸºäºçœŸå®æœ¬é‡‘è®¡ç®—ï¼Œä¸å—æ æ†å€æ•°å½±å“ |
| âœ… **å¤šåœºæ™¯åº”ç”¨** | æ”¯æŒæ”¶ç›Šç‡ã€å¤æ™®æ¯”ç‡ã€æœ€å¤§å›æ’¤ç­‰å¤šæŒ‡æ ‡è®¡ç®— |

---

## å‚è€ƒèµ„æ–™

- **Hyperliquid API æ–‡æ¡£**: https://hyperliquid.gitbook.io/hyperliquid-docs/for-developers/api
- **Apex Liquid Bot**: https://apexliquid.bot/
- **æºä»£ç **: apex_fork.py (è¡Œ 739-820)

---

## ç‰ˆæœ¬å†å²

- **v1.0** (2026-02-03): åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´å®ç°å‡€å…¥é‡‘ç®—æ³•
- æ”¯æŒå……å€¼ã€æç°ã€å¤–éƒ¨è½¬å…¥ã€å¤–éƒ¨è½¬å‡º
- æ™ºèƒ½è¯†åˆ«å†…éƒ¨è½¬è´¦ï¼ˆPerp â†” Spotï¼‰

---

## è®¸å¯è¯

MIT License

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-02-03
**ä½œè€…**: Apex Calculator Team
**è”ç³»æ–¹å¼**: support@apexcalculator.com
