# ç›ˆäºå› å­ï¼ˆProfit Factorï¼‰ç®—æ³•è¯¦è§£

## ğŸ“‹ ç›®å½•

1. [ç®—æ³•æ¦‚è¿°](#ç®—æ³•æ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [è®¡ç®—å…¬å¼](#è®¡ç®—å…¬å¼)
4. [ç®—æ³•å®ç°](#ç®—æ³•å®ç°)
5. [åº”ç”¨åœºæ™¯](#åº”ç”¨åœºæ™¯)
6. [å®Œæ•´ä»£ç ç¤ºä¾‹](#å®Œæ•´ä»£ç ç¤ºä¾‹)
7. [æµ‹è¯•ç”¨ä¾‹](#æµ‹è¯•ç”¨ä¾‹)

---

## ç®—æ³•æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ç›ˆäºå› å­ï¼ˆProfit Factorï¼‰ï¼Ÿ

**ç›ˆäºå› å­**æ˜¯è¡¡é‡äº¤æ˜“ç­–ç•¥ç›ˆåˆ©èƒ½åŠ›çš„å…³é”®æŒ‡æ ‡ï¼Œè¡¨ç¤º**æ€»ç›ˆåˆ©ä¸æ€»äºæŸçš„æ¯”ç‡**ã€‚

### æŒ‡æ ‡æ„ä¹‰

- **Profit Factor > 1**: ç­–ç•¥ç›ˆåˆ©ï¼ˆç›ˆåˆ©å¤§äºäºæŸï¼‰
- **Profit Factor = 1**: ç­–ç•¥ç›ˆäºå¹³è¡¡
- **Profit Factor < 1**: ç­–ç•¥äºæŸï¼ˆäºæŸå¤§äºç›ˆåˆ©ï¼‰
- **Profit Factor = "1000+"**: åªæœ‰ç›ˆåˆ©æ²¡æœ‰äºæŸ

### ä¸ºä»€ä¹ˆéœ€è¦ç›ˆäºå› å­ï¼Ÿ

ç›ˆäºå› å­æ˜¯è¯„ä¼°äº¤æ˜“ç³»ç»Ÿæœ€ç›´è§‚çš„æŒ‡æ ‡ä¹‹ä¸€ï¼š

| ç›ˆäºå› å­ | è¯„çº§ | è¯´æ˜ |
|---------|------|------|
| < 1.0 | âŒ ä¸å¯æ¥å— | äºæŸç­–ç•¥ï¼Œéœ€è¦æ”¹è¿› |
| 1.0 - 1.5 | âš ï¸ å‹‰å¼ºå¯æ¥å— | ç›ˆåˆ©å¾®è–„ï¼Œé£é™©è¾ƒé«˜ |
| 1.5 - 2.0 | âœ… è‰¯å¥½ | ç¨³å®šç›ˆåˆ©ï¼Œé£é™©å¯æ§ |
| 2.0 - 3.0 | ğŸŒŸ ä¼˜ç§€ | å¼ºç›ˆåˆ©èƒ½åŠ› |
| > 3.0 | ğŸ† å“è¶Š | é¡¶çº§ç­–ç•¥è¡¨ç° |

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. å·²å®ç°ç›ˆäºï¼ˆRealized PnLï¼‰

æ¥è‡ª**å·²å¹³ä»“äº¤æ˜“**çš„ç›ˆäºï¼Œè®°å½•åœ¨æˆäº¤è®°å½•ï¼ˆfillsï¼‰ä¸­ã€‚

```python
closed_pnl = fill.get('closedPnl', 0)
```

**ç¤ºä¾‹**ï¼š
- å¼€å¤š BTC @ $40,000
- å¹³å¤š BTC @ $42,000
- **å·²å®ç°ç›ˆäº**: +$2,000 âœ…

### 2. æœªå®ç°ç›ˆäºï¼ˆUnrealized PnLï¼‰

æ¥è‡ª**å½“å‰æŒä»“**çš„æµ®åŠ¨ç›ˆäºï¼Œè®°å½•åœ¨æŒä»“æ•°æ®ï¼ˆpositionsï¼‰ä¸­ã€‚

```python
unrealized_pnl = position.get('position', {}).get('unrealizedPnl', 0)
```

**ç¤ºä¾‹**ï¼š
- å¼€å¤š ETH @ $2,000ï¼ˆä»æŒä»“ï¼‰
- å½“å‰ä»·æ ¼ @ $2,100
- **æœªå®ç°ç›ˆäº**: +$100 ğŸ“Š

### 3. æ€»ç›ˆåˆ©ä¸æ€»äºæŸ

- **æ€»ç›ˆåˆ©ï¼ˆTotal Gainsï¼‰**: æ‰€æœ‰æ­£ç›ˆäºçš„ç´¯åŠ 
- **æ€»äºæŸï¼ˆTotal Lossesï¼‰**: æ‰€æœ‰è´Ÿç›ˆäºçš„ç»å¯¹å€¼ç´¯åŠ 

---

## è®¡ç®—å…¬å¼

### æ ¸å¿ƒå…¬å¼

```python
profit_factor = total_gains / total_losses
```

### å…¬å¼è¯¦è§£

```
ç›ˆäºå› å­ = æ€»ç›ˆåˆ© / æ€»äºæŸ

å…¶ä¸­ï¼š
- æ€»ç›ˆåˆ© = Î£(æ­£ç›ˆäº) = æ‰€æœ‰ PnL > 0 çš„äº¤æ˜“ç´¯åŠ 
- æ€»äºæŸ = Î£|è´Ÿç›ˆäº| = æ‰€æœ‰ PnL < 0 çš„äº¤æ˜“ç»å¯¹å€¼ç´¯åŠ 
```

### ç‰¹æ®Šæƒ…å†µå¤„ç†

| æƒ…å†µ | æ€»ç›ˆåˆ© | æ€»äºæŸ | è¿”å›å€¼ | è¯´æ˜ |
|------|-------|-------|--------|------|
| **åªæœ‰ç›ˆåˆ©** | > 0 | = 0 | "1000+" | å®Œç¾ç­–ç•¥ |
| **åªæœ‰äºæŸ** | = 0 | > 0 | 0 | éœ€è¦æ”¹è¿› |
| **æ— äº¤æ˜“** | = 0 | = 0 | 0 | æ— æ•°æ® |
| **æ­£å¸¸æƒ…å†µ** | > 0 | > 0 | gains/losses | æ­£å¸¸è®¡ç®— |

---

## ç®—æ³•å®ç°

### æ ¸å¿ƒå‡½æ•°ï¼š`calculate_profit_factor()`

**ä»£ç ä½ç½®**: `apex_fork.py:234-283`

```python
from typing import List, Dict, Union, Optional
from decimal import Decimal, getcontext

# è®¾ç½®é«˜ç²¾åº¦è®¡ç®—ï¼ˆ50ä½ç²¾åº¦ï¼‰
getcontext().prec = 50


def calculate_profit_factor(
    fills: List[Dict],
    asset_positions: Optional[List[Dict]] = None
) -> Union[float, str]:
    """
    è®¡ç®—ç›ˆäºå› å­ï¼ˆåŸºäºApex Liquid Botç®—æ³•ï¼‰

    ç›ˆäºå› å­ = æ€»ç›ˆåˆ© / æ€»äºæŸ
    è¯¥æŒ‡æ ‡åæ˜ äº†äº¤æ˜“ç­–ç•¥çš„ç›ˆåˆ©èƒ½åŠ›ï¼Œå¤§äº1è¡¨ç¤ºç›ˆåˆ©ï¼Œå°äº1è¡¨ç¤ºäºæŸ

    å‚æ•°ï¼š
        fills: æˆäº¤è®°å½•åˆ—è¡¨ï¼ŒåŒ…å«'closedPnl'å­—æ®µï¼ˆå·²å®ç°ç›ˆäºï¼‰
        asset_positions: å¯é€‰çš„å½“å‰æŒä»“åˆ—è¡¨ï¼ŒåŒ…å«'unrealizedPnl'å­—æ®µï¼ˆæœªå®ç°ç›ˆäºï¼‰

    è¿”å›ï¼š
        - float: ç›ˆäºå› å­æ•°å€¼
        - "1000+": åªæœ‰ç›ˆåˆ©æ²¡æœ‰äºæŸæ—¶
        - 0: æ— äº¤æ˜“è®°å½•æ—¶

    ç®—æ³•è¯´æ˜ï¼š
        1. ç´¯è®¡æ‰€æœ‰å·²å®ç°ç›ˆäºï¼ˆæ¥è‡ªfillsï¼‰
        2. ç´¯è®¡æ‰€æœ‰æœªå®ç°ç›ˆäºï¼ˆæ¥è‡ªå½“å‰æŒä»“ï¼‰
        3. è®¡ç®—æ€»ç›ˆåˆ©å’Œæ€»äºæŸçš„æ¯”å€¼
    """
    # è¾¹ç•Œæ¡ä»¶ï¼šæ— æ•°æ®æ—¶è¿”å›0
    if not fills and not asset_positions:
        return 0

    # åˆå§‹åŒ–ç´¯è®¡å€¼ï¼ˆä½¿ç”¨é«˜ç²¾åº¦Decimalï¼‰
    total_gains = Decimal('0')
    total_losses = Decimal('0')

    # ==================== æ­¥éª¤1: å¤„ç†å·²å®ç°ç›ˆäº ====================
    for fill in fills:
        closed_pnl = Decimal(str(fill.get('closedPnl', 0)))

        if closed_pnl > 0:
            # ç›ˆåˆ©äº¤æ˜“ï¼šç´¯åŠ åˆ°æ€»ç›ˆåˆ©
            total_gains += closed_pnl
        elif closed_pnl < 0:
            # äºæŸäº¤æ˜“ï¼šå–ç»å¯¹å€¼åç´¯åŠ åˆ°æ€»äºæŸ
            total_losses += abs(closed_pnl)

    # ==================== æ­¥éª¤2: å¤„ç†æœªå®ç°ç›ˆäº ====================
    if asset_positions:
        for position in asset_positions:
            unrealized_pnl = Decimal(str(
                position.get('position', {}).get('unrealizedPnl', 0)
            ))

            if unrealized_pnl > 0:
                # æµ®ç›ˆï¼šç´¯åŠ åˆ°æ€»ç›ˆåˆ©
                total_gains += unrealized_pnl
            elif unrealized_pnl < 0:
                # æµ®äºï¼šå–ç»å¯¹å€¼åç´¯åŠ åˆ°æ€»äºæŸ
                total_losses += abs(unrealized_pnl)

    # ==================== æ­¥éª¤3: è®¡ç®—ç›ˆäºå› å­ ====================
    if total_losses == 0:
        # ç‰¹æ®Šæƒ…å†µï¼šæ²¡æœ‰äºæŸ
        return "1000+" if total_gains > 0 else 0

    # æ­£å¸¸è®¡ç®—ï¼šæ€»ç›ˆåˆ© / æ€»äºæŸ
    profit_factor = total_gains / total_losses

    return float(profit_factor)
```

### ç®—æ³•æµç¨‹å›¾

```
å¼€å§‹
  â†“
æ£€æŸ¥æ•°æ®æ˜¯å¦ä¸ºç©ºï¼Ÿ
  â†“ æ˜¯
è¿”å› 0
  â†“ å¦
åˆå§‹åŒ– total_gains = 0, total_losses = 0
  â†“
éå†æˆäº¤è®°å½•ï¼ˆfillsï¼‰
  â†“
å¯¹æ¯æ¡è®°å½•ï¼š
  - è·å– closedPnl
  - å¦‚æœ > 0 â†’ total_gains += closedPnl
  - å¦‚æœ < 0 â†’ total_losses += |closedPnl|
  â†“
æ˜¯å¦æœ‰æŒä»“æ•°æ®ï¼Ÿ
  â†“ æ˜¯
éå†æŒä»“ï¼ˆpositionsï¼‰
  â†“
å¯¹æ¯ä¸ªæŒä»“ï¼š
  - è·å– unrealizedPnl
  - å¦‚æœ > 0 â†’ total_gains += unrealizedPnl
  - å¦‚æœ < 0 â†’ total_losses += |unrealizedPnl|
  â†“
total_losses == 0ï¼Ÿ
  â†“ æ˜¯
è¿”å› "1000+"ï¼ˆå¦‚æœ total_gains > 0ï¼‰æˆ– 0
  â†“ å¦
è¿”å› total_gains / total_losses
  â†“
ç»“æŸ
```

---

## åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šè¯„ä¼°äº¤æ˜“ç­–ç•¥è¡¨ç°

```python
# è·å–ç”¨æˆ·äº¤æ˜“æ•°æ®
fills = api_client.get_user_fills(user_address)
positions = api_client.get_user_asset_positions(user_address)

# è®¡ç®—ç›ˆäºå› å­
profit_factor = calculate_profit_factor(fills, positions)

# è¯„ä¼°ç­–ç•¥
if profit_factor == "1000+":
    print("ğŸ† å®Œç¾ç­–ç•¥ï¼šåªç›ˆä¸äº")
elif profit_factor > 3.0:
    print("ğŸŒŸ å“è¶Šç­–ç•¥ï¼šå¼ºç›ˆåˆ©èƒ½åŠ›")
elif profit_factor > 2.0:
    print("âœ… ä¼˜ç§€ç­–ç•¥ï¼šç¨³å®šç›ˆåˆ©")
elif profit_factor > 1.5:
    print("âœ… è‰¯å¥½ç­–ç•¥ï¼šå¯æŒç»­ç›ˆåˆ©")
elif profit_factor > 1.0:
    print("âš ï¸ å‹‰å¼ºå¯æ¥å—ï¼šéœ€è¦ä¼˜åŒ–")
else:
    print("âŒ äºæŸç­–ç•¥ï¼šéœ€è¦æ”¹è¿›")
```

### åœºæ™¯ 2ï¼šç­–ç•¥å¯¹æ¯”

```python
# å¯¹æ¯”ä¸¤ä¸ªç­–ç•¥
strategy_a_pf = calculate_profit_factor(fills_a, positions_a)
strategy_b_pf = calculate_profit_factor(fills_b, positions_b)

print(f"ç­–ç•¥ A ç›ˆäºå› å­: {strategy_a_pf}")
print(f"ç­–ç•¥ B ç›ˆäºå› å­: {strategy_b_pf}")

if strategy_a_pf > strategy_b_pf:
    improvement = (strategy_a_pf - strategy_b_pf) / strategy_b_pf * 100
    print(f"ç­–ç•¥ A ä¼˜äºç­–ç•¥ Bï¼Œæå‡ {improvement:.2f}%")
```

### åœºæ™¯ 3ï¼šé£é™©ç®¡ç†

```python
# æ ¹æ®ç›ˆäºå› å­è°ƒæ•´ä»“ä½
def adjust_position_size(profit_factor: float, base_size: float) -> float:
    """æ ¹æ®ç›ˆäºå› å­è°ƒæ•´ä»“ä½å¤§å°"""
    if profit_factor > 3.0:
        return base_size * 1.5  # ç­–ç•¥è¡¨ç°ä¼˜ç§€ï¼Œå¢åŠ ä»“ä½
    elif profit_factor > 2.0:
        return base_size * 1.2
    elif profit_factor > 1.5:
        return base_size
    elif profit_factor > 1.0:
        return base_size * 0.7  # ç­–ç•¥è¡¨ç°ä¸€èˆ¬ï¼Œå‡å°ä»“ä½
    else:
        return base_size * 0.3  # ç­–ç•¥äºæŸï¼Œå¤§å¹…å‡ä»“
```

---

## å®Œæ•´ä»£ç ç¤ºä¾‹

### ä¸»ç¨‹åºç¤ºä¾‹

```python
from typing import List, Dict, Union, Optional
from decimal import Decimal, getcontext

getcontext().prec = 50


class ProfitFactorCalculator:
    """ç›ˆäºå› å­è®¡ç®—å™¨"""

    def calculate_profit_factor(
        self,
        fills: List[Dict],
        asset_positions: Optional[List[Dict]] = None
    ) -> Union[float, str]:
        """è®¡ç®—ç›ˆäºå› å­"""
        if not fills and not asset_positions:
            return 0

        total_gains = Decimal('0')
        total_losses = Decimal('0')

        # å¤„ç†å·²å®ç°ç›ˆäº
        print("\nğŸ“Š å·²å®ç°ç›ˆäºåˆ†æ:")
        print("=" * 60)

        for i, fill in enumerate(fills, 1):
            closed_pnl = Decimal(str(fill.get('closedPnl', 0)))

            if closed_pnl > 0:
                total_gains += closed_pnl
                print(f"  äº¤æ˜“ {i}: +${float(closed_pnl):,.2f} âœ…")
            elif closed_pnl < 0:
                total_losses += abs(closed_pnl)
                print(f"  äº¤æ˜“ {i}: -${float(abs(closed_pnl)):,.2f} âŒ")

        # å¤„ç†æœªå®ç°ç›ˆäº
        if asset_positions:
            print("\nğŸ“ˆ æœªå®ç°ç›ˆäºåˆ†æ:")
            print("=" * 60)

            for position in asset_positions:
                pos_data = position.get('position', {})
                coin = position.get('coin', 'Unknown')
                unrealized_pnl = Decimal(str(pos_data.get('unrealizedPnl', 0)))

                if unrealized_pnl > 0:
                    total_gains += unrealized_pnl
                    print(f"  {coin}: +${float(unrealized_pnl):,.2f} âœ… (æµ®ç›ˆ)")
                elif unrealized_pnl < 0:
                    total_losses += abs(unrealized_pnl)
                    print(f"  {coin}: -${float(abs(unrealized_pnl)):,.2f} âŒ (æµ®äº)")

        # è®¡ç®—ç»“æœ
        print("\n" + "=" * 60)
        print(f"æ€»ç›ˆåˆ©: ${float(total_gains):,.2f}")
        print(f"æ€»äºæŸ: ${float(total_losses):,.2f}")
        print("=" * 60)

        if total_losses == 0:
            result = "1000+" if total_gains > 0 else 0
            print(f"ç›ˆäºå› å­: {result} ğŸ†")
            return result

        profit_factor = total_gains / total_losses
        pf_value = float(profit_factor)

        # è¯„çº§
        if pf_value > 3.0:
            rating = "ğŸ† å“è¶Š"
        elif pf_value > 2.0:
            rating = "ğŸŒŸ ä¼˜ç§€"
        elif pf_value > 1.5:
            rating = "âœ… è‰¯å¥½"
        elif pf_value > 1.0:
            rating = "âš ï¸ å‹‰å¼ºå¯æ¥å—"
        else:
            rating = "âŒ éœ€è¦æ”¹è¿›"

        print(f"ç›ˆäºå› å­: {pf_value:.4f} {rating}")

        return pf_value

    def get_detailed_analysis(
        self,
        fills: List[Dict],
        asset_positions: Optional[List[Dict]] = None
    ) -> Dict:
        """è·å–è¯¦ç»†åˆ†ææŠ¥å‘Š"""
        profit_factor = self.calculate_profit_factor(fills, asset_positions)

        # ç»Ÿè®¡äº¤æ˜“æ¬¡æ•°
        winning_trades = sum(1 for f in fills if float(f.get('closedPnl', 0)) > 0)
        losing_trades = sum(1 for f in fills if float(f.get('closedPnl', 0)) < 0)
        total_trades = len(fills)

        # è®¡ç®—æ€»ç›ˆäº
        total_gains = sum(
            float(f.get('closedPnl', 0))
            for f in fills
            if float(f.get('closedPnl', 0)) > 0
        )
        total_losses = sum(
            abs(float(f.get('closedPnl', 0)))
            for f in fills
            if float(f.get('closedPnl', 0)) < 0
        )

        # æ·»åŠ æœªå®ç°ç›ˆäº
        if asset_positions:
            for position in asset_positions:
                unrealized = float(position.get('position', {}).get('unrealizedPnl', 0))
                if unrealized > 0:
                    total_gains += unrealized
                else:
                    total_losses += abs(unrealized)

        return {
            "profit_factor": profit_factor,
            "total_gains": total_gains,
            "total_losses": total_losses,
            "net_profit": total_gains - total_losses,
            "winning_trades": winning_trades,
            "losing_trades": losing_trades,
            "total_trades": total_trades,
            "win_rate": (winning_trades / total_trades * 100) if total_trades > 0 else 0
        }


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    calculator = ProfitFactorCalculator()

    # æ¨¡æ‹Ÿäº¤æ˜“æ•°æ®
    fills = [
        {"closedPnl": "500"},    # ç›ˆåˆ© $500
        {"closedPnl": "-200"},   # äºæŸ $200
        {"closedPnl": "300"},    # ç›ˆåˆ© $300
        {"closedPnl": "-100"},   # äºæŸ $100
        {"closedPnl": "800"},    # ç›ˆåˆ© $800
        {"closedPnl": "-150"},   # äºæŸ $150
    ]

    # æ¨¡æ‹ŸæŒä»“æ•°æ®
    positions = [
        {
            "coin": "BTC",
            "position": {"unrealizedPnl": "200"}  # æµ®ç›ˆ $200
        },
        {
            "coin": "ETH",
            "position": {"unrealizedPnl": "-50"}  # æµ®äº $50
        }
    ]

    # è®¡ç®—ç›ˆäºå› å­
    profit_factor = calculator.calculate_profit_factor(fills, positions)

    # è·å–è¯¦ç»†åˆ†æ
    print("\n" + "=" * 60)
    print("è¯¦ç»†åˆ†ææŠ¥å‘Š")
    print("=" * 60)

    analysis = calculator.get_detailed_analysis(fills, positions)

    for key, value in analysis.items():
        if isinstance(value, float):
            if "rate" in key:
                print(f"{key}: {value:.2f}%")
            elif "factor" in key:
                print(f"{key}: {value}")
            else:
                print(f"{key}: ${value:,.2f}")
        else:
            print(f"{key}: {value}")
```

### è¿è¡Œç»“æœç¤ºä¾‹

```
ğŸ“Š å·²å®ç°ç›ˆäºåˆ†æ:
============================================================
  äº¤æ˜“ 1: +$500.00 âœ…
  äº¤æ˜“ 2: -$200.00 âŒ
  äº¤æ˜“ 3: +$300.00 âœ…
  äº¤æ˜“ 4: -$100.00 âŒ
  äº¤æ˜“ 5: +$800.00 âœ…
  äº¤æ˜“ 6: -$150.00 âŒ

ğŸ“ˆ æœªå®ç°ç›ˆäºåˆ†æ:
============================================================
  BTC: +$200.00 âœ… (æµ®ç›ˆ)
  ETH: -$50.00 âŒ (æµ®äº)

============================================================
æ€»ç›ˆåˆ©: $1,800.00
æ€»äºæŸ: $500.00
============================================================
ç›ˆäºå› å­: 3.6000 ğŸ† å“è¶Š

============================================================
è¯¦ç»†åˆ†ææŠ¥å‘Š
============================================================
profit_factor: 3.6
total_gains: $1,800.00
total_losses: $500.00
net_profit: $1,300.00
winning_trades: 3
losing_trades: 3
total_trades: 6
win_rate: 50.00%
```

---

## æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•ç”¨ä¾‹ 1ï¼šåªæœ‰ç›ˆåˆ©

```python
def test_only_profits():
    """æµ‹è¯•ç”¨ä¾‹ 1: åªæœ‰ç›ˆåˆ©äº¤æ˜“"""
    calculator = ProfitFactorCalculator()

    fills = [
        {"closedPnl": "100"},
        {"closedPnl": "200"},
        {"closedPnl": "300"},
    ]

    result = calculator.calculate_profit_factor(fills)

    assert result == "1000+", "åªæœ‰ç›ˆåˆ©åº”è¿”å› '1000+'"
    print("âœ… æµ‹è¯•ç”¨ä¾‹ 1 é€šè¿‡ï¼šåªæœ‰ç›ˆåˆ©")
```

### æµ‹è¯•ç”¨ä¾‹ 2ï¼šåªæœ‰äºæŸ

```python
def test_only_losses():
    """æµ‹è¯•ç”¨ä¾‹ 2: åªæœ‰äºæŸäº¤æ˜“"""
    calculator = ProfitFactorCalculator()

    fills = [
        {"closedPnl": "-100"},
        {"closedPnl": "-200"},
        {"closedPnl": "-300"},
    ]

    result = calculator.calculate_profit_factor(fills)

    assert result == 0, "åªæœ‰äºæŸåº”è¿”å› 0"
    print("âœ… æµ‹è¯•ç”¨ä¾‹ 2 é€šè¿‡ï¼šåªæœ‰äºæŸ")
```

### æµ‹è¯•ç”¨ä¾‹ 3ï¼šç›ˆäºæ··åˆ

```python
def test_mixed_trades():
    """æµ‹è¯•ç”¨ä¾‹ 3: ç›ˆäºæ··åˆäº¤æ˜“"""
    calculator = ProfitFactorCalculator()

    fills = [
        {"closedPnl": "1000"},  # ç›ˆåˆ©
        {"closedPnl": "-500"},  # äºæŸ
        {"closedPnl": "500"},   # ç›ˆåˆ©
        {"closedPnl": "-200"},  # äºæŸ
    ]

    # é¢„æœŸï¼šæ€»ç›ˆåˆ© = 1500, æ€»äºæŸ = 700
    # ç›ˆäºå› å­ = 1500 / 700 â‰ˆ 2.14

    result = calculator.calculate_profit_factor(fills)

    expected = 1500.0 / 700.0
    assert abs(result - expected) < 0.01, f"é¢„æœŸ {expected}ï¼Œå®é™… {result}"
    print(f"âœ… æµ‹è¯•ç”¨ä¾‹ 3 é€šè¿‡ï¼šç›ˆäºå› å­ = {result:.4f}")
```

### æµ‹è¯•ç”¨ä¾‹ 4ï¼šåŒ…å«æœªå®ç°ç›ˆäº

```python
def test_with_unrealized_pnl():
    """æµ‹è¯•ç”¨ä¾‹ 4: åŒ…å«æœªå®ç°ç›ˆäº"""
    calculator = ProfitFactorCalculator()

    fills = [
        {"closedPnl": "500"},   # å·²å®ç°ç›ˆåˆ©
        {"closedPnl": "-200"},  # å·²å®ç°äºæŸ
    ]

    positions = [
        {"position": {"unrealizedPnl": "300"}},   # æœªå®ç°ç›ˆåˆ©
        {"position": {"unrealizedPnl": "-100"}},  # æœªå®ç°äºæŸ
    ]

    # é¢„æœŸï¼š
    # æ€»ç›ˆåˆ© = 500 + 300 = 800
    # æ€»äºæŸ = 200 + 100 = 300
    # ç›ˆäºå› å­ = 800 / 300 â‰ˆ 2.67

    result = calculator.calculate_profit_factor(fills, positions)

    expected = 800.0 / 300.0
    assert abs(result - expected) < 0.01, f"é¢„æœŸ {expected}ï¼Œå®é™… {result}"
    print(f"âœ… æµ‹è¯•ç”¨ä¾‹ 4 é€šè¿‡ï¼šç›ˆäºå› å­ = {result:.4f}")
```

### æµ‹è¯•ç”¨ä¾‹ 5ï¼šæ— äº¤æ˜“æ•°æ®

```python
def test_no_data():
    """æµ‹è¯•ç”¨ä¾‹ 5: æ— äº¤æ˜“æ•°æ®"""
    calculator = ProfitFactorCalculator()

    fills = []
    positions = []

    result = calculator.calculate_profit_factor(fills, positions)

    assert result == 0, "æ— æ•°æ®åº”è¿”å› 0"
    print("âœ… æµ‹è¯•ç”¨ä¾‹ 5 é€šè¿‡ï¼šæ— äº¤æ˜“æ•°æ®")
```

### æµ‹è¯•ç”¨ä¾‹ 6ï¼šé«˜ç²¾åº¦è®¡ç®—

```python
def test_high_precision():
    """æµ‹è¯•ç”¨ä¾‹ 6: é«˜ç²¾åº¦è®¡ç®—"""
    calculator = ProfitFactorCalculator()

    fills = [
        {"closedPnl": "123.456789"},
        {"closedPnl": "-45.123456"},
        {"closedPnl": "67.891234"},
    ]

    # é¢„æœŸï¼š
    # æ€»ç›ˆåˆ© = 123.456789 + 67.891234 = 191.348023
    # æ€»äºæŸ = 45.123456
    # ç›ˆäºå› å­ = 191.348023 / 45.123456 â‰ˆ 4.2408

    result = calculator.calculate_profit_factor(fills)

    expected = 191.348023 / 45.123456
    assert abs(result - expected) < 0.0001, f"é¢„æœŸ {expected}ï¼Œå®é™… {result}"
    print(f"âœ… æµ‹è¯•ç”¨ä¾‹ 6 é€šè¿‡ï¼šé«˜ç²¾åº¦ç›ˆäºå› å­ = {result:.6f}")
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```python
if __name__ == "__main__":
    print("å¼€å§‹è¿è¡Œç›ˆäºå› å­æµ‹è¯•ç”¨ä¾‹...\n")

    test_only_profits()
    test_only_losses()
    test_mixed_trades()
    test_with_unrealized_pnl()
    test_no_data()
    test_high_precision()

    print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡ï¼")
```

---

## ç®—æ³•ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| âœ… **ç›´è§‚æ˜“æ‡‚** | ç®€å•çš„æ¯”ç‡ï¼Œæ˜“äºç†è§£å’Œæ²Ÿé€š |
| âœ… **å…¨é¢è¯„ä¼°** | åŒæ—¶è€ƒè™‘å·²å®ç°å’Œæœªå®ç°ç›ˆäº |
| âœ… **é«˜ç²¾åº¦è®¡ç®—** | ä½¿ç”¨ Decimal ç¡®ä¿ 50 ä½ç²¾åº¦ |
| âœ… **ç‰¹æ®Šå¤„ç†** | æ­£ç¡®å¤„ç†æ— äºæŸã€æ— ç›ˆåˆ©ç­‰è¾¹ç•Œæƒ…å†µ |
| âœ… **å®æ—¶åæ˜ ** | åŒ…å«å½“å‰æŒä»“ï¼Œåæ˜ æœ€æ–°è¡¨ç° |

---

## ä¸å…¶ä»–æŒ‡æ ‡å¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **ç›ˆäºå› å­** | ç›´è§‚ã€æ˜“æ‡‚ | ä¸è€ƒè™‘äº¤æ˜“é¢‘ç‡ | å¿«é€Ÿè¯„ä¼°ç­–ç•¥ç›ˆåˆ©èƒ½åŠ› |
| **èƒœç‡** | åæ˜ æˆåŠŸç‡ | ä¸è€ƒè™‘ç›ˆäºé‡‘é¢ | è¯„ä¼°äº¤æ˜“å‡†ç¡®æ€§ |
| **å¤æ™®æ¯”ç‡** | è€ƒè™‘é£é™© | è®¡ç®—å¤æ‚ | é£é™©è°ƒæ•´åçš„æ”¶ç›Šè¯„ä¼° |
| **æœ€å¤§å›æ’¤** | åæ˜ é£é™© | ä¸åæ˜ ç›ˆåˆ© | é£é™©æ§åˆ¶è¯„ä¼° |

---

## å‚è€ƒèµ„æ–™

- **Hyperliquid API æ–‡æ¡£**: https://hyperliquid.gitbook.io/hyperliquid-docs/for-developers/api
- **Apex Liquid Bot**: https://apexliquid.bot/
- **æºä»£ç **: apex_fork.py (è¡Œ 234-283)

---

## ç‰ˆæœ¬å†å²

- **v1.0** (2026-02-03): åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´å®ç°ç›ˆäºå› å­ç®—æ³•
- æ”¯æŒå·²å®ç°å’Œæœªå®ç°ç›ˆäº
- é«˜ç²¾åº¦è®¡ç®—ï¼ˆ50ä½ç²¾åº¦ï¼‰
- å®Œå–„çš„è¾¹ç•Œæ¡ä»¶å¤„ç†

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-02-03
**ä½œè€…**: Apex Calculator Team
