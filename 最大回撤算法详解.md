# æœ€å¤§å›æ’¤ï¼ˆMax Drawdownï¼‰ç®—æ³•è¯¦è§£

## ğŸ“‹ ç›®å½•

1. [ç®—æ³•æ¦‚è¿°](#ç®—æ³•æ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [è®¡ç®—å…¬å¼](#è®¡ç®—å…¬å¼)
4. [ç®—æ³•å®ç°](#ç®—æ³•å®ç°)
5. [åº”ç”¨åœºæ™¯](#åº”ç”¨åœºæ™¯)
6. [å®Œæ•´ä»£ç ç¤ºä¾‹](#å®Œæ•´ä»£ç ç¤ºä¾‹)
7. [æµ‹è¯•ç”¨ä¾‹](#æµ‹è¯•ç”¨ä¾‹)

---

## ç®—æ³•æ¦‚è¿°

### ä»€ä¹ˆæ˜¯æœ€å¤§å›æ’¤ï¼ˆMax Drawdownï¼‰ï¼Ÿ

**æœ€å¤§å›æ’¤**æ˜¯æŒ‡åœ¨é€‰å®šå‘¨æœŸå†…ï¼ŒæŠ•èµ„ç»„åˆ**ä»å³°å€¼åˆ°è°·åº•çš„æœ€å¤§è·Œå¹…**ï¼Œæ˜¯è¡¡é‡æŠ•èµ„é£é™©çš„æ ¸å¿ƒæŒ‡æ ‡ã€‚

### æŒ‡æ ‡æ„ä¹‰

- **MDD = 20%**: è´¦æˆ·ä»å†å²æœ€é«˜ç‚¹ä¸‹è·Œäº† 20%
- **MDD = 50%**: è´¦æˆ·ä»å†å²æœ€é«˜ç‚¹æŸå¤±äº†ä¸€åŠ
- **MDD = 80%**: è´¦æˆ·å‡ ä¹å…¨éƒ¨äºæŸï¼Œé£é™©æé«˜

### ä¸ºä»€ä¹ˆéœ€è¦æœ€å¤§å›æ’¤ï¼Ÿ

æœ€å¤§å›æ’¤ç›´è§‚åæ˜ äº†**æœ€åæƒ…å†µä¸‹çš„æŸå¤±å¹…åº¦**ï¼š

| æœ€å¤§å›æ’¤ | è¯„çº§ | æ¢å¤éš¾åº¦ |
|---------|------|---------|
| < 10% | ğŸ† ä¼˜ç§€ | éœ€è¦ç›ˆåˆ© 11% æ¢å¤ |
| 10% - 20% | âœ… è‰¯å¥½ | éœ€è¦ç›ˆåˆ© 25% æ¢å¤ |
| 20% - 30% | âš ï¸ å¯æ¥å— | éœ€è¦ç›ˆåˆ© 43% æ¢å¤ |
| 30% - 50% | âŒ é«˜é£é™© | éœ€è¦ç›ˆåˆ© 100% æ¢å¤ |
| > 50% | ğŸš¨ æé«˜é£é™© | éœ€è¦ç›ˆåˆ© 200%+ æ¢å¤ |

**æ¢å¤å…¬å¼**ï¼š
```
æ¢å¤æ‰€éœ€æ”¶ç›Šç‡ = 1 / (1 - å›æ’¤ç‡) - 1

ç¤ºä¾‹ï¼š
- å›æ’¤ 20% â†’ éœ€è¦ç›ˆåˆ© 25% æ¢å¤
- å›æ’¤ 50% â†’ éœ€è¦ç›ˆåˆ© 100% æ¢å¤
- å›æ’¤ 80% â†’ éœ€è¦ç›ˆåˆ© 400% æ¢å¤
```

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. ä¼ ç»Ÿæœ€å¤§å›æ’¤è®¡ç®—

```python
å›æ’¤ = (å³°å€¼ - å½“å‰å€¼) / å³°å€¼ Ã— 100%
æœ€å¤§å›æ’¤ = max(æ‰€æœ‰å›æ’¤)
```

### 2. åŸºäºçœŸå®æœ¬é‡‘çš„æ”¹è¿›ç®—æ³•

**ä¼ ç»Ÿæ–¹æ³•çš„é—®é¢˜**ï¼š
- åŸºäºè´¦æˆ·ä»·å€¼æˆ–æŒä»“ä»·å€¼
- å—æ æ†å½±å“ä¸¥é‡
- ä¸èƒ½çœŸå®åæ˜ é£é™©

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
```python
æ¯ç¬”äº¤æ˜“æ”¶ç›Šç‡ = closedPnl / true_capital
ç´¯è®¡æ”¶ç›Šç‡ = Î (1 + æ¯ç¬”æ”¶ç›Šç‡)
å›æ’¤ = (å³°å€¼æ”¶ç›Šç‡ - å½“å‰æ”¶ç›Šç‡) / å³°å€¼æ”¶ç›Šç‡
```

**ä¸ºä»€ä¹ˆä½¿ç”¨çœŸå®æœ¬é‡‘ï¼Ÿ**

| åœºæ™¯ | 10å€æ æ† | åŸºäºæŒä»“ä»·å€¼ï¼ˆâŒï¼‰ | åŸºäºçœŸå®æœ¬é‡‘ï¼ˆâœ…ï¼‰ |
|------|---------|-------------------|-----------------|
| æŠ•å…¥æœ¬é‡‘ | $100 | - | - |
| æŒä»“ä»·å€¼ | $1,000 | - | - |
| äºæŸé‡‘é¢ | $50 | - | - |
| **å›æ’¤ç‡** | - | -50/1000 = **-5%** | -50/100 = **-50%** |

---

## è®¡ç®—å…¬å¼

### æ ¸å¿ƒå…¬å¼

#### 1. æ¯ç¬”äº¤æ˜“æ”¶ç›Šç‡

```python
trade_return_i = closedPnl_i / true_capital

# é™åˆ¶èŒƒå›´é˜²æ­¢æç«¯å€¼
trade_return_i = max(-0.99, min(trade_return_i, 10.0))
```

#### 2. ç´¯è®¡æ”¶ç›Šç‡åºåˆ—ï¼ˆå¤åˆ©è®¡ç®—ï¼‰

```python
cumulative_return_i = Î (1 + trade_return_j) for j in [0, i]

# ä»1.0å¼€å§‹ï¼ˆä»£è¡¨100%æœ¬é‡‘ï¼‰
# å¸¦ä¸Šé™ä¿æŠ¤ï¼Œé˜²æ­¢æº¢å‡º
cumulative_return_i = min(cumulative_return_i, 10000.0)
```

#### 3. å›æ’¤è®¡ç®—

```python
peak = max(cumulative_return_0, ..., cumulative_return_i)
drawdown_i = (peak - cumulative_return_i) / peak Ã— 100%
```

#### 4. æœ€å¤§å›æ’¤

```python
max_drawdown = max(drawdown_0, drawdown_1, ..., drawdown_n)

# é™åˆ¶ä¸è¶…è¿‡100%
max_drawdown = min(max_drawdown, 100.0)
```

### å…¬å¼æ¨å¯¼

#### ç´¯è®¡æ”¶ç›Šç‡å¤åˆ©è®¡ç®—ç¤ºä¾‹

```
å‡è®¾äº¤æ˜“åºåˆ—ï¼š
  äº¤æ˜“1: +5% â†’ ç´¯è®¡ = 1.0 Ã— 1.05 = 1.05
  äº¤æ˜“2: -3% â†’ ç´¯è®¡ = 1.05 Ã— 0.97 = 1.0185
  äº¤æ˜“3: +10% â†’ ç´¯è®¡ = 1.0185 Ã— 1.10 = 1.12035
  äº¤æ˜“4: -8% â†’ ç´¯è®¡ = 1.12035 Ã— 0.92 = 1.030722

æœ€å¤§å›æ’¤è®¡ç®—ï¼š
  å³°å€¼ = 1.12035ï¼ˆç¬¬3ç¬”åï¼‰
  è°·åº• = 1.030722ï¼ˆç¬¬4ç¬”åï¼‰
  å›æ’¤ = (1.12035 - 1.030722) / 1.12035 = 8.00%
```

---

## ç®—æ³•å®ç°

### æ ¸å¿ƒå‡½æ•°ï¼š`calculate_max_drawdown_on_capital()`

**ä»£ç ä½ç½®**: `apex_fork.py:1067-1205`

```python
from typing import List, Dict
from datetime import datetime


def calculate_max_drawdown_on_capital(
    fills: List[Dict],
    true_capital: float
) -> Dict[str, float]:
    """
    åŸºäºçœŸå®æœ¬é‡‘è®¡ç®—æœ€å¤§å›æ’¤ï¼ˆæ¨èæ–¹æ³•ï¼‰

    å…³é”®æ”¹è¿›ï¼šä½¿ç”¨çœŸå®æœ¬é‡‘è€ŒéæŒä»“ä»·å€¼è®¡ç®—æ”¶ç›Šç‡ï¼Œå®Œå…¨ä¸å—æ æ†å½±å“

    å‚æ•°ï¼š
        fills: æˆäº¤è®°å½•åˆ—è¡¨
        true_capital: çœŸå®æœ¬é‡‘ï¼ˆå……å€¼ - æç° + å¤–éƒ¨è½¬å…¥ - å¤–éƒ¨è½¬å‡ºï¼‰

    è¿”å›ï¼š
        å­—å…¸ï¼ŒåŒ…å«ï¼š
        - max_drawdown_pct: æœ€å¤§å›æ’¤ç™¾åˆ†æ¯”
        - peak_return: å³°å€¼ç´¯è®¡æ”¶ç›Šç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
        - trough_return: è°·åº•ç´¯è®¡æ”¶ç›Šç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
        - peak_date: å³°å€¼å‘ç”Ÿæ—¥æœŸ
        - trough_date: è°·åº•å‘ç”Ÿæ—¥æœŸ
        - total_trades: åˆ†æçš„äº¤æ˜“æ•°é‡

    ç®—æ³•è¯´æ˜ï¼š
        1. æ¯ç¬”äº¤æ˜“æ”¶ç›Šç‡ = closedPnL / true_capitalï¼ˆä¸æ˜¯ position_valueï¼‰
        2. æ„å»ºç´¯è®¡æ”¶ç›Šç‡åºåˆ—ï¼ˆå¤åˆ©è®¡ç®—ï¼‰
        3. è¿½è¸ªå³°å€¼ï¼Œè®¡ç®—æ¯ä¸ªç‚¹ç›¸å¯¹å³°å€¼çš„å›æ’¤
        4. è®°å½•æœ€å¤§å›æ’¤åŠå¯¹åº”çš„å³°å€¼å’Œè°·åº•

    ä¼˜åŠ¿ï¼š
        - âœ… ä¸å—æ æ†å½±å“ï¼ŒçœŸå®åæ˜ é£é™©
        - âœ… ä¸ Sharpe Ratio è®¡ç®—é€»è¾‘ä¸€è‡´
        - âœ… ä¸å—å‡ºå…¥é‡‘å½±å“
        - âœ… åæ˜ çœŸå®çš„èµ„é‡‘ä½¿ç”¨æ•ˆç‡

    ä¸ºä»€ä¹ˆä½¿ç”¨çœŸå®æœ¬é‡‘ï¼Ÿ
        - 10å€æ æ†ï¼šæŠ•å…¥ $100ï¼ŒæŒä»“ä»·å€¼ $1000
        - äºæŸ $50ï¼š
          * æ—§ç®—æ³•ï¼š-50/1000 = -5%ï¼ˆâŒ ä¸¥é‡ä½ä¼°ï¼‰
          * æ–°ç®—æ³•ï¼š-50/100 = -50%ï¼ˆâœ… çœŸå®é£é™©ï¼‰
    """
    # è¾¹ç•Œæ¡ä»¶æ£€æŸ¥
    if true_capital <= 0:
        return {
            "max_drawdown_pct": 0,
            "peak_return": 0,
            "trough_return": 0,
            "peak_date": "N/A",
            "trough_date": "N/A",
            "total_trades": 0
        }

    trade_returns = []
    trade_times = []  # è®°å½•æ¯ç¬”äº¤æ˜“çš„æ—¶é—´æˆ³

    # ==================== æ­¥éª¤1: æå–äº¤æ˜“æ”¶ç›Šç‡ ====================

    for fill in fills:
        closed_pnl = float(fill.get('closedPnl', 0))

        # åªåˆ†æå¹³ä»“äº¤æ˜“
        if closed_pnl == 0:
            continue

        # âœ… å…³é”®æ”¹è¿›ï¼šä½¿ç”¨çœŸå®æœ¬é‡‘è®¡ç®—æ”¶ç›Šç‡
        trade_return = closed_pnl / true_capital

        # é™åˆ¶å•ç¬”æ”¶ç›Šç‡èŒƒå›´ï¼š[-0.99, 10.0]ï¼ˆé˜²æ­¢æç«¯å€¼ï¼‰
        # -0.99 = -99%ï¼ˆæœ€å¤šäºå®Œï¼‰
        # 10.0 = 1000%ï¼ˆåˆç†çš„æœ€å¤§ç›ˆåˆ©ä¸Šé™ï¼‰
        trade_return = max(-0.99, min(trade_return, 10.0))

        trade_returns.append(trade_return)
        trade_times.append(fill.get('time', 0))  # è®°å½•æ—¶é—´æˆ³

    # æ•°æ®ä¸è¶³æ—¶è¿”å›é›¶å€¼
    if len(trade_returns) < 2:
        return {
            "max_drawdown_pct": 0,
            "peak_return": 0,
            "trough_return": 0,
            "peak_date": "N/A",
            "trough_date": "N/A",
            "total_trades": len(trade_returns)
        }

    # ==================== æ­¥éª¤2: æ„å»ºç´¯è®¡æ”¶ç›Šç‡åºåˆ— ====================

    cumulative_returns = []
    cumulative = 1.0  # ä»1.0å¼€å§‹ï¼ˆä»£è¡¨100%æœ¬é‡‘ï¼‰
    MAX_CUMULATIVE = 10000.0  # æœ€å¤§ç´¯è®¡æ”¶ç›Šå€æ•°ï¼ˆ10000å€ = 1000000%ï¼‰

    for ret in trade_returns:
        cumulative *= (1 + ret)  # å¤åˆ©ç´¯ç§¯
        # é˜²æ­¢æ•°å€¼æº¢å‡ºï¼šé™åˆ¶ç´¯è®¡æ”¶ç›Šä¸Šé™
        cumulative = min(cumulative, MAX_CUMULATIVE)
        cumulative_returns.append(cumulative)

    # ==================== æ­¥éª¤3: è®¡ç®—æœ€å¤§å›æ’¤ ====================

    peak = cumulative_returns[0]  # åˆå§‹å³°å€¼
    peak_index = 0  # å³°å€¼ä½ç½®
    max_drawdown = 0  # æœ€å¤§å›æ’¤
    trough_value = peak  # è°·åº•å€¼
    trough_index = 0  # è°·åº•ä½ç½®

    for i, value in enumerate(cumulative_returns):
        # æ›´æ–°å³°å€¼
        if value > peak:
            peak = value
            peak_index = i

        # è®¡ç®—å½“å‰å›æ’¤ = (å³°å€¼ - å½“å‰å€¼) / å³°å€¼
        drawdown = (peak - value) / peak * 100 if peak > 0 else 0

        # æ›´æ–°æœ€å¤§å›æ’¤å’Œè°·åº•
        if drawdown > max_drawdown:
            max_drawdown = drawdown
            trough_value = value
            trough_index = i

    # é™åˆ¶æœ€å¤§å›æ’¤ä¸è¶…è¿‡100%
    max_drawdown = min(max_drawdown, 100.0)

    # ==================== æ­¥éª¤4: æ ¼å¼åŒ–æ—¥æœŸ ====================

    def format_date(timestamp_ms: int) -> str:
        """å°†æ¯«ç§’æ—¶é—´æˆ³è½¬æ¢ä¸ºæ—¥æœŸå­—ç¬¦ä¸²"""
        if timestamp_ms > 0:
            try:
                dt = datetime.fromtimestamp(timestamp_ms / 1000)
                return dt.strftime('%Y-%m-%d')
            except:
                return "N/A"
        return "N/A"

    peak_date = format_date(trade_times[peak_index])
    trough_date = format_date(trade_times[trough_index])

    return {
        "max_drawdown_pct": max_drawdown,
        "peak_return": (peak - 1) * 100,  # è½¬æ¢ä¸ºç™¾åˆ†æ¯”
        "trough_return": (trough_value - 1) * 100,
        "peak_date": peak_date,
        "trough_date": trough_date,
        "total_trades": len(trade_returns)
    }
```

### ç®—æ³•æµç¨‹å›¾

```
å¼€å§‹
  â†“
æ£€æŸ¥ true_capital > 0ï¼Ÿ
  â†“ å¦
è¿”å›é›¶å€¼ç»“æœ
  â†“ æ˜¯
åˆå§‹åŒ– trade_returns = [], trade_times = []
  â†“
éå†æˆäº¤è®°å½•ï¼ˆfillsï¼‰
  â†“
å¯¹æ¯æ¡è®°å½•ï¼š
  - è·å– closedPnl
  - å¦‚æœ = 0 â†’ è·³è¿‡ï¼ˆå¼€ä»“äº¤æ˜“ï¼‰
  - è®¡ç®—æ”¶ç›Šç‡ = closedPnl / true_capital
  - é™åˆ¶èŒƒå›´ [-0.99, 10.0]
  - æ·»åŠ åˆ° trade_returns å’Œ trade_times
  â†“
trade_returns é•¿åº¦ < 2ï¼Ÿ
  â†“ æ˜¯
è¿”å›é›¶å€¼ç»“æœ
  â†“ å¦
æ„å»ºç´¯è®¡æ”¶ç›Šç‡åºåˆ—
  â†“
åˆå§‹åŒ–ï¼š
  - cumulative = 1.0
  - cumulative_returns = []
  â†“
å¯¹æ¯ç¬”æ”¶ç›Šç‡ï¼š
  - cumulative *= (1 + trade_return)
  - é™åˆ¶ä¸Šé™ min(cumulative, 10000.0)
  - æ·»åŠ åˆ° cumulative_returns
  â†“
è®¡ç®—æœ€å¤§å›æ’¤
  â†“
åˆå§‹åŒ–ï¼š
  - peak = cumulative_returns[0]
  - max_drawdown = 0
  - trough_value = peak
  â†“
å¯¹æ¯ä¸ªç´¯è®¡æ”¶ç›Šç‡ï¼š
  - å¦‚æœ > peak â†’ æ›´æ–° peak
  - è®¡ç®—å›æ’¤ = (peak - value) / peak Ã— 100
  - å¦‚æœå›æ’¤ > max_drawdown â†’ æ›´æ–° max_drawdown å’Œ trough_value
  â†“
é™åˆ¶ max_drawdown â‰¤ 100%
  â†“
æ ¼å¼åŒ–å³°å€¼å’Œè°·åº•æ—¥æœŸ
  â†“
è¿”å›å®Œæ•´ç»“æœ
  â†“
ç»“æŸ
```

---

## åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šé£é™©è¯„ä¼°

```python
# è®¡ç®—æœ€å¤§å›æ’¤
dd_result = calculate_max_drawdown_on_capital(fills, true_capital)

print(f"æœ€å¤§å›æ’¤: {dd_result['max_drawdown_pct']:.2f}%")
print(f"å³°å€¼æ”¶ç›Šç‡: {dd_result['peak_return']:.2f}%")
print(f"è°·åº•æ”¶ç›Šç‡: {dd_result['trough_return']:.2f}%")
print(f"å³°å€¼æ—¥æœŸ: {dd_result['peak_date']}")
print(f"è°·åº•æ—¥æœŸ: {dd_result['trough_date']}")

# è¯„ä¼°é£é™©
if dd_result['max_drawdown_pct'] < 10:
    print("ğŸ† ä½é£é™©ç­–ç•¥")
elif dd_result['max_drawdown_pct'] < 20:
    print("âœ… ä¸­ä½é£é™©ç­–ç•¥")
elif dd_result['max_drawdown_pct'] < 30:
    print("âš ï¸ ä¸­ç­‰é£é™©ç­–ç•¥")
else:
    print("ğŸš¨ é«˜é£é™©ç­–ç•¥")
```

### åœºæ™¯ 2ï¼šè®¡ç®—æ¢å¤éš¾åº¦

```python
def calculate_recovery_needed(max_drawdown_pct: float) -> float:
    """è®¡ç®—æ¢å¤åˆ°å³°å€¼æ‰€éœ€çš„æ”¶ç›Šç‡"""
    if max_drawdown_pct >= 100:
        return float('inf')  # å®Œå…¨äºæŸï¼Œæ— æ³•æ¢å¤

    recovery_rate = 1 / (1 - max_drawdown_pct / 100) - 1
    return recovery_rate * 100


# ç¤ºä¾‹
mdd = dd_result['max_drawdown_pct']
recovery = calculate_recovery_needed(mdd)

print(f"\næ¢å¤åˆ†æ:")
print(f"æœ€å¤§å›æ’¤: {mdd:.2f}%")
print(f"æ¢å¤éœ€è¦ç›ˆåˆ©: {recovery:.2f}%")
```

### åœºæ™¯ 3ï¼šé£é™©è°ƒæ•´åçš„ç­–ç•¥é€‰æ‹©

```python
def calculate_calmar_ratio(annualized_return: float, max_drawdown: float) -> float:
    """
    è®¡ç®—å¡ç›æ¯”ç‡ï¼ˆCalmar Ratioï¼‰
    = å¹´åŒ–æ”¶ç›Šç‡ / æœ€å¤§å›æ’¤

    è¶Šé«˜è¶Šå¥½ï¼Œåæ˜ å•ä½å›æ’¤çš„æ”¶ç›Šèƒ½åŠ›
    """
    if max_drawdown == 0:
        return float('inf') if annualized_return > 0 else 0

    return annualized_return / max_drawdown


# å¯¹æ¯”ç­–ç•¥
strategies = {
    "ä¿å®ˆç­–ç•¥": {
        "annualized_return": 15.0,
        "max_drawdown": 8.0
    },
    "æ¿€è¿›ç­–ç•¥": {
        "annualized_return": 45.0,
        "max_drawdown": 35.0
    },
    "å¹³è¡¡ç­–ç•¥": {
        "annualized_return": 25.0,
        "max_drawdown": 15.0
    }
}

print("\nç­–ç•¥å¯¹æ¯”ï¼ˆå¡ç›æ¯”ç‡ï¼‰:")
for name, metrics in strategies.items():
    calmar = calculate_calmar_ratio(
        metrics['annualized_return'],
        metrics['max_drawdown']
    )
    print(f"{name}: {calmar:.2f}")
```

---

## å®Œæ•´ä»£ç ç¤ºä¾‹

### ä¸»ç¨‹åºç¤ºä¾‹

```python
from typing import List, Dict
from datetime import datetime


class MaxDrawdownCalculator:
    """æœ€å¤§å›æ’¤è®¡ç®—å™¨"""

    def calculate_max_drawdown_on_capital(
        self,
        fills: List[Dict],
        true_capital: float
    ) -> Dict[str, float]:
        """è®¡ç®—åŸºäºçœŸå®æœ¬é‡‘çš„æœ€å¤§å›æ’¤"""

        if true_capital <= 0:
            return self._zero_result()

        trade_returns = []
        trade_times = []

        print("\nğŸ“Š äº¤æ˜“æ”¶ç›Šç‡åºåˆ—:")
        print("=" * 90)
        print(f"{'åºå·':<6} {'æ—¥æœŸ':<12} {'ç›ˆäº ($)':<15} {'æ”¶ç›Šç‡ (%)':<15} {'ç´¯è®¡æ”¶ç›Šç‡'}")
        print("=" * 90)

        cumulative = 1.0
        for i, fill in enumerate(fills, 1):
            closed_pnl = float(fill.get('closedPnl', 0))

            if closed_pnl == 0:
                continue

            # è®¡ç®—äº¤æ˜“æ”¶ç›Šç‡
            trade_return = closed_pnl / true_capital
            trade_return = max(-0.99, min(trade_return, 10.0))
            trade_returns.append(trade_return)

            # è®°å½•æ—¶é—´
            timestamp = fill.get('time', 0)
            trade_times.append(timestamp)
            date_str = self._format_date(timestamp)

            # è®¡ç®—ç´¯è®¡æ”¶ç›Šç‡
            cumulative *= (1 + trade_return)
            cumulative = min(cumulative, 10000.0)

            # æ‰“å°è¯¦æƒ…
            return_pct = trade_return * 100
            cumulative_pct = (cumulative - 1) * 100
            status = "âœ…" if closed_pnl > 0 else "âŒ"

            print(f"{i:<6} {date_str:<12} ${closed_pnl:<14,.2f} "
                  f"{return_pct:<14.4f}% {cumulative_pct:>10.2f}% {status}")

        print("=" * 90)

        if len(trade_returns) < 2:
            print("âš ï¸ æ•°æ®ä¸è¶³ï¼Œæ— æ³•è®¡ç®—æœ€å¤§å›æ’¤ï¼ˆéœ€è¦è‡³å°‘2ç¬”äº¤æ˜“ï¼‰")
            return self._zero_result(len(trade_returns))

        # æ„å»ºç´¯è®¡æ”¶ç›Šç‡åºåˆ—
        cumulative_returns = []
        cumulative = 1.0

        for ret in trade_returns:
            cumulative *= (1 + ret)
            cumulative = min(cumulative, 10000.0)
            cumulative_returns.append(cumulative)

        # è®¡ç®—æœ€å¤§å›æ’¤
        peak = cumulative_returns[0]
        peak_index = 0
        max_drawdown = 0
        trough_value = peak
        trough_index = 0

        print("\nğŸ“ˆ å›æ’¤åˆ†æ:")
        print("=" * 90)
        print(f"{'æ—¶ç‚¹':<6} {'ç´¯è®¡æ”¶ç›Šç‡':<15} {'å½“å‰å³°å€¼':<15} {'å›æ’¤':<15} {'çŠ¶æ€'}")
        print("=" * 90)

        for i, value in enumerate(cumulative_returns):
            # æ›´æ–°å³°å€¼
            if value > peak:
                peak = value
                peak_index = i

            # è®¡ç®—å›æ’¤
            drawdown = (peak - value) / peak * 100 if peak > 0 else 0

            # æ›´æ–°æœ€å¤§å›æ’¤
            if drawdown > max_drawdown:
                max_drawdown = drawdown
                trough_value = value
                trough_index = i

            # æ‰“å°å…³é”®æ—¶ç‚¹
            if drawdown > 0 or i == peak_index:
                cumulative_pct = (value - 1) * 100
                peak_pct = (peak - 1) * 100
                status = "ğŸ“ å³°å€¼" if i == peak_index else f"ğŸ“‰ -{drawdown:.2f}%"
                print(f"{i+1:<6} {cumulative_pct:<14.2f}% {peak_pct:<14.2f}% "
                      f"{drawdown:<14.2f}% {status}")

        print("=" * 90)

        # é™åˆ¶æœ€å¤§å›æ’¤
        max_drawdown = min(max_drawdown, 100.0)

        # æ ¼å¼åŒ–æ—¥æœŸ
        peak_date = self._format_date(trade_times[peak_index])
        trough_date = self._format_date(trade_times[trough_index])

        # æ‰“å°ç»“æœ
        print(f"\nğŸ¯ æœ€å¤§å›æ’¤ç»“æœ:")
        print("=" * 90)
        print(f"æœ€å¤§å›æ’¤: {max_drawdown:.2f}%")
        print(f"å³°å€¼æ”¶ç›Šç‡: {(peak - 1) * 100:.2f}% (æ—¥æœŸ: {peak_date})")
        print(f"è°·åº•æ”¶ç›Šç‡: {(trough_value - 1) * 100:.2f}% (æ—¥æœŸ: {trough_date})")
        print(f"åˆ†æäº¤æ˜“æ•°: {len(trade_returns)}")

        # è¯„çº§
        if max_drawdown < 10:
            rating = "ğŸ† ä¼˜ç§€"
        elif max_drawdown < 20:
            rating = "âœ… è‰¯å¥½"
        elif max_drawdown < 30:
            rating = "âš ï¸ å¯æ¥å—"
        else:
            rating = "ğŸš¨ é«˜é£é™©"

        print(f"é£é™©è¯„çº§: {rating}")

        # æ¢å¤éš¾åº¦
        if max_drawdown < 100:
            recovery_needed = 1 / (1 - max_drawdown / 100) - 1
            print(f"æ¢å¤éœ€è¦ç›ˆåˆ©: {recovery_needed * 100:.2f}%")

        return {
            "max_drawdown_pct": max_drawdown,
            "peak_return": (peak - 1) * 100,
            "trough_return": (trough_value - 1) * 100,
            "peak_date": peak_date,
            "trough_date": trough_date,
            "total_trades": len(trade_returns)
        }

    def _format_date(self, timestamp_ms: int) -> str:
        """æ ¼å¼åŒ–æ—¶é—´æˆ³"""
        if timestamp_ms > 0:
            try:
                dt = datetime.fromtimestamp(timestamp_ms / 1000)
                return dt.strftime('%Y-%m-%d')
            except:
                return "N/A"
        return "N/A"

    def _zero_result(self, total_trades: int = 0) -> Dict[str, float]:
        """è¿”å›é›¶å€¼ç»“æœ"""
        return {
            "max_drawdown_pct": 0,
            "peak_return": 0,
            "trough_return": 0,
            "peak_date": "N/A",
            "trough_date": "N/A",
            "total_trades": total_trades
        }


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    calculator = MaxDrawdownCalculator()

    # æ¨¡æ‹Ÿäº¤æ˜“æ•°æ®ï¼ˆåŒ…å«ä¸€æ¬¡å¤§å¹…å›æ’¤ï¼‰
    import time
    current_time = int(time.time() * 1000)

    fills = [
        {"closedPnl": "500", "time": current_time - 86400000 * 20},
        {"closedPnl": "300", "time": current_time - 86400000 * 18},
        {"closedPnl": "800", "time": current_time - 86400000 * 16},
        {"closedPnl": "400", "time": current_time - 86400000 * 14},  # å³°å€¼
        {"closedPnl": "-600", "time": current_time - 86400000 * 12}, # å¼€å§‹å›æ’¤
        {"closedPnl": "-400", "time": current_time - 86400000 * 10}, # ç»§ç»­å›æ’¤
        {"closedPnl": "-300", "time": current_time - 86400000 * 8},  # è°·åº•
        {"closedPnl": "200", "time": current_time - 86400000 * 6},   # å¼€å§‹æ¢å¤
        {"closedPnl": "350", "time": current_time - 86400000 * 4},
        {"closedPnl": "450", "time": current_time - 86400000 * 2},
    ]

    # çœŸå®æœ¬é‡‘
    true_capital = 10000.0

    # è®¡ç®—æœ€å¤§å›æ’¤
    result = calculator.calculate_max_drawdown_on_capital(fills, true_capital)
```

### è¿è¡Œç»“æœç¤ºä¾‹

```
ğŸ“Š äº¤æ˜“æ”¶ç›Šç‡åºåˆ—:
==========================================================================================
åºå·   æ—¥æœŸ         ç›ˆäº ($)        æ”¶ç›Šç‡ (%)      ç´¯è®¡æ”¶ç›Šç‡
==========================================================================================
1      2026-01-14   $500.00         5.0000%         5.00% âœ…
2      2026-01-16   $300.00         3.0000%         8.15% âœ…
3      2026-01-18   $800.00         8.0000%        16.81% âœ…
4      2026-01-20   $400.00         4.0000%        21.48% âœ…
5      2026-01-22   $-600.00        -6.0000%       14.19% âŒ
6      2026-01-24   $-400.00        -4.0000%        9.62% âŒ
7      2026-01-26   $-300.00        -3.0000%        6.34% âŒ
8      2026-01-28   $200.00         2.0000%         8.46% âœ…
9      2026-01-30   $350.00         3.5000%        12.26% âœ…
10     2026-02-01   $450.00         4.5000%        17.31% âœ…
==========================================================================================

ğŸ“ˆ å›æ’¤åˆ†æ:
==========================================================================================
æ—¶ç‚¹   ç´¯è®¡æ”¶ç›Šç‡      å½“å‰å³°å€¼        å›æ’¤            çŠ¶æ€
==========================================================================================
4      21.48%          21.48%          0.00%           ğŸ“ å³°å€¼
5      14.19%          21.48%          6.00%           ğŸ“‰ -6.00%
6      9.62%           21.48%          9.76%           ğŸ“‰ -9.76%
7      6.34%           21.48%          12.47%          ğŸ“‰ -12.47%
==========================================================================================

ğŸ¯ æœ€å¤§å›æ’¤ç»“æœ:
==========================================================================================
æœ€å¤§å›æ’¤: 12.47%
å³°å€¼æ”¶ç›Šç‡: 21.48% (æ—¥æœŸ: 2026-01-20)
è°·åº•æ”¶ç›Šç‡: 6.34% (æ—¥æœŸ: 2026-01-26)
åˆ†æäº¤æ˜“æ•°: 10
é£é™©è¯„çº§: âœ… è‰¯å¥½
æ¢å¤éœ€è¦ç›ˆåˆ©: 14.25%
```

---

## æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•ç”¨ä¾‹ 1ï¼šæ­£å¸¸å›æ’¤

```python
def test_normal_drawdown():
    """æµ‹è¯•ç”¨ä¾‹ 1: æ­£å¸¸å›æ’¤åœºæ™¯"""
    calculator = MaxDrawdownCalculator()

    fills = [
        {"closedPnl": "100", "time": 1000000},  # +10%
        {"closedPnl": "200", "time": 2000000},  # +20%ï¼Œå³°å€¼
        {"closedPnl": "-150", "time": 3000000}, # -15%ï¼Œå›æ’¤
        {"closedPnl": "100", "time": 4000000},  # +10%ï¼Œæ¢å¤
    ]

    result = calculator.calculate_max_drawdown_on_capital(fills, 1000)

    assert result['max_drawdown_pct'] > 0
    assert result['max_drawdown_pct'] < 100
    print(f"âœ… æµ‹è¯•ç”¨ä¾‹ 1 é€šè¿‡ï¼šæœ€å¤§å›æ’¤ = {result['max_drawdown_pct']:.2f}%")
```

### æµ‹è¯•ç”¨ä¾‹ 2ï¼šæŒç»­ä¸Šæ¶¨æ— å›æ’¤

```python
def test_no_drawdown():
    """æµ‹è¯•ç”¨ä¾‹ 2: æŒç»­ä¸Šæ¶¨ï¼Œæ— å›æ’¤"""
    calculator = MaxDrawdownCalculator()

    fills = [
        {"closedPnl": "100", "time": 1000000},
        {"closedPnl": "200", "time": 2000000},
        {"closedPnl": "150", "time": 3000000},
        {"closedPnl": "300", "time": 4000000},
    ]

    result = calculator.calculate_max_drawdown_on_capital(fills, 1000)

    # æŒç»­ä¸Šæ¶¨ï¼Œæœ€å¤§å›æ’¤åº”è¯¥éå¸¸å°ï¼ˆæ¥è¿‘0ï¼‰
    assert result['max_drawdown_pct'] < 1
    print(f"âœ… æµ‹è¯•ç”¨ä¾‹ 2 é€šè¿‡ï¼šæ— å›æ’¤åœºæ™¯")
```

### æµ‹è¯•ç”¨ä¾‹ 3ï¼šæç«¯å›æ’¤

```python
def test_extreme_drawdown():
    """æµ‹è¯•ç”¨ä¾‹ 3: æç«¯å›æ’¤åœºæ™¯"""
    calculator = MaxDrawdownCalculator()

    fills = [
        {"closedPnl": "500", "time": 1000000},  # +50%
        {"closedPnl": "-800", "time": 2000000}, # -80%ï¼Œå·¨å¤§å›æ’¤
        {"closedPnl": "200", "time": 3000000},  # å°è¯•æ¢å¤
    ]

    result = calculator.calculate_max_drawdown_on_capital(fills, 1000)

    assert result['max_drawdown_pct'] > 50  # åº”è¯¥æ˜¯è¾ƒå¤§å›æ’¤
    print(f"âœ… æµ‹è¯•ç”¨ä¾‹ 3 é€šè¿‡ï¼šæç«¯å›æ’¤ = {result['max_drawdown_pct']:.2f}%")
```

### æµ‹è¯•ç”¨ä¾‹ 4ï¼šæ æ†å½±å“å¯¹æ¯”

```python
def test_leverage_impact():
    """æµ‹è¯•ç”¨ä¾‹ 4: æ æ†å¯¹å›æ’¤çš„å½±å“"""
    calculator = MaxDrawdownCalculator()

    fills = [
        {"closedPnl": "1000", "time": 1000000},  # ç›ˆåˆ©
        {"closedPnl": "-500", "time": 2000000},  # å›æ’¤
    ]

    # åœºæ™¯1: æ— æ æ†ï¼Œæœ¬é‡‘ $10,000
    result_no_leverage = calculator.calculate_max_drawdown_on_capital(fills, 10000)

    # åœºæ™¯2: 10å€æ æ†ï¼Œæœ¬é‡‘ $1,000
    result_with_leverage = calculator.calculate_max_drawdown_on_capital(fills, 1000)

    print(f"âœ… æµ‹è¯•ç”¨ä¾‹ 4 é€šè¿‡:")
    print(f"  æ— æ æ†å›æ’¤: {result_no_leverage['max_drawdown_pct']:.2f}%")
    print(f"  é«˜æ æ†å›æ’¤: {result_with_leverage['max_drawdown_pct']:.2f}%")
    print(f"  å·®å¼‚å€æ•°: {result_with_leverage['max_drawdown_pct'] / result_no_leverage['max_drawdown_pct']:.2f}x")
```

### æµ‹è¯•ç”¨ä¾‹ 5ï¼šæ•°æ®ä¸è¶³

```python
def test_insufficient_data():
    """æµ‹è¯•ç”¨ä¾‹ 5: æ•°æ®ä¸è¶³åœºæ™¯"""
    calculator = MaxDrawdownCalculator()

    fills = [
        {"closedPnl": "100", "time": 1000000},
    ]

    result = calculator.calculate_max_drawdown_on_capital(fills, 1000)

    assert result['max_drawdown_pct'] == 0
    assert result['total_trades'] == 1
    print("âœ… æµ‹è¯•ç”¨ä¾‹ 5 é€šè¿‡ï¼šæ•°æ®ä¸è¶³å¤„ç†æ­£ç¡®")
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```python
if __name__ == "__main__":
    print("å¼€å§‹è¿è¡Œæœ€å¤§å›æ’¤æµ‹è¯•ç”¨ä¾‹...\n")

    test_normal_drawdown()
    test_no_drawdown()
    test_extreme_drawdown()
    test_leverage_impact()
    test_insufficient_data()

    print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡ï¼")
```

---

## ç®—æ³•ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| âœ… **ä¸å—æ æ†å½±å“** | åŸºäºçœŸå®æœ¬é‡‘ï¼ŒçœŸå®åæ˜ é£é™© |
| âœ… **ä¸å—å‡ºå…¥é‡‘å½±å“** | ä½¿ç”¨å‡€å…¥é‡‘ï¼Œé¿å…è®¡ç®—åå·® |
| âœ… **å¤åˆ©è®¡ç®—** | çœŸå®åæ˜ ç´¯è®¡æ”¶ç›Šå’Œå›æ’¤ |
| âœ… **æº¢å‡ºä¿æŠ¤** | é™åˆ¶æç«¯å€¼ï¼Œé˜²æ­¢è®¡ç®—é”™è¯¯ |
| âœ… **è¯¦ç»†è®°å½•** | è®°å½•å³°å€¼å’Œè°·åº•çš„æ—¶é—´å’Œæ•°å€¼ |

---

## å‚è€ƒèµ„æ–™

- **Hyperliquid API æ–‡æ¡£**: https://hyperliquid.gitbook.io/hyperliquid-docs/for-developers/api
- **Apex Liquid Bot**: https://apexliquid.bot/
- **æºä»£ç **: apex_fork.py (è¡Œ 1067-1205)

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-02-03
**ä½œè€…**: Apex Calculator Team
