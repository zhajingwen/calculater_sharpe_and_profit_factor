# ROEæŒ‡æ ‡å®æ–½æ€»ç»“

## å®æ–½æ—¶é—´

**å®Œæˆæ—¶é—´**: 2026-02-04
**å®æ–½è€—æ—¶**: çº¦2å°æ—¶

## å®æ–½æ¦‚è§ˆ

æˆåŠŸä¸ºHyperliquidäº¤æ˜“åˆ†æå·¥å…·æ·»åŠ 24å°æ—¶ROE (Return on Equity) æŒ‡æ ‡ï¼ŒåŸºäºHyperliquid Portfolio APIè®¡ç®—ã€‚

### æ ¸å¿ƒå…¬å¼

```python
24h ROE (%) = (day.pnlHistory[-1] / day.accountValueHistory[0]) Ã— 100
```

å…¶ä¸­ï¼š
- `pnlHistory[-1]`: 24å°æ—¶ç´¯è®¡PNLï¼ˆæœ€æ–°å€¼ï¼‰
- `accountValueHistory[0]`: 24å°æ—¶å‰çš„è´¦æˆ·æ€»æƒç›Šï¼ˆèµ·å§‹å€¼ï¼‰

## ä¿®æ”¹çš„æ–‡ä»¶

### 1. hyperliquid_api_client.py

**æ–°å¢æ–¹æ³•**: `get_user_portfolio(user_address: str) -> Dict[str, Any]`

**ä½ç½®**: ç¬¬379è¡Œä¹‹åï¼ˆ`get_user_ledger`æ–¹æ³•ä¹‹åï¼‰

**åŠŸèƒ½**:
- è°ƒç”¨Portfolio API (`{"type": "portfolio", "user": user_address}`)
- æå–"day"æ•°æ®ï¼ˆåŒ…å«pnlHistoryå’ŒaccountValueHistoryï¼‰
- éªŒè¯å“åº”æ ¼å¼å’Œå¿…éœ€å­—æ®µ
- å¤ç”¨ç°æœ‰çš„é‡è¯•æœºåˆ¶å’Œé”™è¯¯å¤„ç†ï¼ˆæœ€å¤š3æ¬¡é‡è¯•ï¼‰

**å…³é”®å®ç°**:
```python
def get_user_portfolio(self, user_address: str) -> Dict[str, Any]:
    payload = {"type": "portfolio", "user": user_address}
    response = self._make_request("/info", payload)

    # æå– "day" æ•°æ®
    for item in response:
        if isinstance(item, list) and item[0] == "day":
            return item[1]

    raise Exception("æœªæ‰¾åˆ°'day'æ•°æ®")
```

---

### 2. apex_fork.py

#### 2.1 æ–°å¢æ•°æ®ç±»ï¼šROEMetrics

**ä½ç½®**: ç¬¬30è¡Œä¹‹åï¼ˆimportè¯­å¥ä¹‹åï¼‰

**å±æ€§**:
- `roe_percent`: ROEç™¾åˆ†æ¯”
- `start_equity`: èµ·å§‹æƒç›Šï¼ˆ24hå‰ï¼‰
- `current_equity`: å½“å‰æƒç›Š
- `pnl_24h`: 24å°æ—¶PNL
- `start_time`: 24hå‰æ—¶é—´ç‚¹
- `end_time`: å½“å‰æ—¶é—´ç‚¹
- `is_valid`: æ•°æ®æ˜¯å¦æœ‰æ•ˆ
- `error_message`: é”™è¯¯ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
- `account_age_hours`: è´¦æˆ·å¹´é¾„ï¼ˆå¯é€‰ï¼‰
- `is_sufficient_history`: å†å²æ˜¯å¦å……è¶³

#### 2.2 æ–°å¢æ–¹æ³•ï¼šcalculate_24h_roe

**ä½ç½®**: ç¬¬262è¡Œä¹‹åï¼ˆ`get_user_margin_summary`æ–¹æ³•ä¹‹åï¼‰

**åŠŸèƒ½**:
1. è·å–Portfolioæ•°æ®ï¼ˆå¸¦ç¼“å­˜ï¼Œ5åˆ†é’ŸTTLï¼‰
2. æå–pnlHistoryå’ŒaccountValueHistory
3. è®¡ç®—ROE = (24h PNL / èµ·å§‹æƒç›Š) Ã— 100
4. è¾¹ç•Œå¤„ç†ï¼š
   - èµ·å§‹æƒç›Š â‰¤ 0 â†’ is_valid=False
   - pnlHistory/accountValueHistoryä¸ºç©º â†’ is_valid=False
   - è´¦æˆ·å†å² < 24h â†’ è­¦å‘Šä¿¡æ¯ï¼ŒåŸºäºå®é™…æ—¶é•¿è®¡ç®—
5. APIå¤±è´¥ â†’ è¿”å›æ— æ•ˆæ•°æ® + é”™è¯¯ä¿¡æ¯

**ç¼“å­˜æœºåˆ¶**:
- ç¼“å­˜é”®: `f"portfolio_{user_address}"`
- TTL: 5åˆ†é’Ÿï¼ˆä¸ç°æœ‰ç¼“å­˜ç­–ç•¥ä¸€è‡´ï¼‰
- æ”¯æŒforce_refreshå‚æ•°

#### 2.3 é›†æˆåˆ°analyze_user

**ä½ç½®**: ç¬¬846è¡Œï¼ˆreturn resultsä¹‹å‰ï¼‰

**æ–°å¢ä»£ç **:
```python
# æŒ‡æ ‡11: 24å°æ—¶ROEï¼ˆReturn on Equityï¼‰
roe_metrics = self.calculate_24h_roe(user_address, force_refresh)
results["roe_24h"] = {
    "roe_percent": roe_metrics.roe_percent,
    "start_equity": roe_metrics.start_equity,
    "current_equity": roe_metrics.current_equity,
    "pnl_24h": roe_metrics.pnl_24h,
    "is_valid": roe_metrics.is_valid,
    "error_message": roe_metrics.error_message,
    "account_age_hours": roe_metrics.account_age_hours,
    "is_sufficient_history": roe_metrics.is_sufficient_history,
    "start_time": roe_metrics.start_time.isoformat(),
    "end_time": roe_metrics.end_time.isoformat()
}
```

---

### 3. report_generator.py

**ä½ç½®**: ç¬¬86-87è¡Œä¹‹é—´ï¼ˆåœ¨"---"å’Œ"## ğŸ“ˆ æ ¸å¿ƒæŒ‡æ ‡"ä¹‹é—´ï¼‰

**æ–°å¢å†…å®¹**: ROEæŠ¥å‘Šéƒ¨åˆ†ï¼ˆçº¦70è¡Œï¼‰

**åŠŸèƒ½**:
- æå–roe_24hæ•°æ®
- ROEè¯„çº§ï¼š
  - â‰¥10%: ğŸ”¥ æä½³
  - â‰¥5%: âœ… ä¼˜ç§€
  - â‰¥0%: ğŸ“ˆ ç›ˆåˆ©
  - â‰¥-5%: âš ï¸ å°å¹…äºæŸ
  - <-5%: ğŸ“‰ è¾ƒå¤§äºæŸ
- è¡¨æ ¼åŒ–æ˜¾ç¤ºROEã€èµ·å§‹æƒç›Šã€å½“å‰æƒç›Šã€24h PNLã€æ›´æ–°æ—¶é—´
- è´¦æˆ·å†å²ä¸è¶³24hæ—¶æ˜¾ç¤ºè­¦å‘Š
- è®¡ç®—å…¬å¼è¯´æ˜
- å¤„ç†is_valid=Falseçš„æƒ…å†µ

**è¾“å‡ºç¤ºä¾‹**:

```markdown
## ğŸ“Š 24å°æ—¶ROEæŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| **24h ROE** | **-28.78%** | ğŸ“‰ è¾ƒå¤§äºæŸ |
| èµ·å§‹æƒç›Š (24hå‰) | $19,667.19 | è®¡ç®—åŸºå‡† |
| å½“å‰æƒç›Š | $14,006.40 | æœ€æ–°è´¦æˆ·ä»·å€¼ |
| 24h PNL | $-5,660.80 | æœŸé—´ç›ˆäº |
| æ›´æ–°æ—¶é—´ | 2026-02-04 13:57:50 | æ•°æ®æ—¶é—´æˆ³ |

**è®¡ç®—å…¬å¼**:
```
24h ROE (%) = (24hç´¯è®¡PNL / èµ·å§‹æƒç›Š) Ã— 100
           = (-5660.80 / 19667.19) Ã— 100
           = -28.78%
```
```

---

### 4. main.py

**ä½ç½®**: ç¬¬268è¡Œä¹‹åï¼ˆPNLç»Ÿè®¡æ˜¾ç¤ºå®Œæ¯•åï¼‰

**æ–°å¢å†…å®¹**: ROEæ˜¾ç¤ºéƒ¨åˆ†ï¼ˆçº¦60è¡Œï¼‰

**åŠŸèƒ½**:
- æå–roe_24hæ•°æ®
- ä½¿ç”¨ç°æœ‰çš„è¡¨æ ¼æ ¼å¼åŒ–å‡½æ•°ï¼ˆprint_table_rowã€print_table_separatorï¼‰
- ROEå›¾æ ‡ï¼šæ­£å€¼ğŸ“ˆï¼Œè´Ÿå€¼ğŸ“‰
- è¡¨æ ¼åŒ–æ˜¾ç¤ºæ‰€æœ‰ROEæŒ‡æ ‡
- è´¦æˆ·å†å²ä¸è¶³24hæ—¶æ˜¾ç¤ºè­¦å‘Š
- é”™è¯¯å¤„ç†ï¼ˆis_valid=Falseï¼‰

**è¾“å‡ºç¤ºä¾‹**:

```
  â”Œâ”€ 24å°æ—¶ROE ğŸ“‰
  â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  æŒ‡æ ‡                           â”‚ æ•°å€¼               â”‚ è¯´æ˜
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  24h ROE                      â”‚          -28.75% â”‚ ğŸ“‰ è¾ƒå¤§äºæŸ
  èµ·å§‹æƒç›Š (24hå‰)                  â”‚       $19,667.19 â”‚ è®¡ç®—åŸºå‡†
  å½“å‰æƒç›Š                         â”‚       $14,013.50 â”‚ æœ€æ–°è´¦æˆ·ä»·å€¼
  24h PNL                      â”‚       $-5,653.69 â”‚ æœŸé—´ç›ˆäº
  æ›´æ–°æ—¶é—´                         â”‚ 2026-02-04 13:57 â”‚ æ•°æ®æ—¶é—´æˆ³
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è¾¹ç•Œå¤„ç†ç­–ç•¥

### æ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥

| åœºæ™¯ | æ£€æµ‹ä½ç½® | å¤„ç†æ–¹å¼ | è¿”å›çŠ¶æ€ |
|------|---------|---------|---------|
| APIè¯·æ±‚å¤±è´¥ | API Client | é‡è¯•3æ¬¡ â†’ æŠ›å‡ºå¼‚å¸¸ | is_valid=False + error_message |
| å“åº”æ ¼å¼å¼‚å¸¸ | API Client | æŠ›å‡ºå¼‚å¸¸ | is_valid=False + error_message |
| pnlHistoryä¸ºç©º | Calculator | è¿”å›æ— æ•ˆæ•°æ® | is_valid=False + "pnlHistoryä¸ºç©º" |
| accountValueHistoryä¸ºç©º | Calculator | è¿”å›æ— æ•ˆæ•°æ® | is_valid=False + "accountValueHistoryä¸ºç©º" |
| èµ·å§‹æƒç›Š â‰¤ 0 | Calculator | è¿”å›æ— æ•ˆæ•°æ® | is_valid=False + "èµ·å§‹æƒç›Šâ‰¤0" |
| è´¦æˆ·å†å² < 24h | Calculator | è®¡ç®—å®é™…ROE + è­¦å‘Š | is_valid=True + warning_message |

### æ˜¾ç¤ºå±‚å¤„ç†

- **is_valid=True**: æ˜¾ç¤ºå®Œæ•´çš„ROEæŒ‡æ ‡è¡¨æ ¼
- **is_valid=False**: æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- **è´¦æˆ·å†å²ä¸è¶³**: æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯

---

## æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•

âœ… **æ­£å¸¸ROEè®¡ç®—**
- æµ‹è¯•åœ°å€: 0x3ca32dd3666ed1b69e86b86b420b058caa8c1aaf
- ROE: -28.79%
- èµ·å§‹æƒç›Š: $19,667.19
- 24h PNL: -$5,662.33

âœ… **ç¼“å­˜æœºåˆ¶**
- ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼šä»APIè·å–
- ç¬¬äºŒæ¬¡è°ƒç”¨ï¼šä½¿ç”¨ç¼“å­˜
- 5åˆ†é’Ÿå†…ç»“æœä¸€è‡´

âœ… **å¼ºåˆ¶åˆ·æ–°**
- force_refresh=Trueæ­£å¸¸å·¥ä½œ
- è·³è¿‡ç¼“å­˜é‡æ–°è·å–æ•°æ®

âœ… **æ•°æ®ç±»éªŒè¯**
- ROEMetricsåˆ›å»ºæˆåŠŸ
- æ‰€æœ‰å­—æ®µç±»å‹æ­£ç¡®

### é›†æˆæµ‹è¯•

âœ… **å®Œæ•´åˆ†ææµç¨‹**
```bash
python main.py 0x3ca32dd3666ed1b69e86b86b420b058caa8c1aaf
```
- ROEæ˜¾ç¤ºåœ¨CLIè¾“å‡ºä¸­
- æ•°æ®æ ¼å¼æ­£ç¡®
- è¡¨æ ¼ç¾è§‚æ˜“è¯»

âœ… **æŠ¥å‘Šç”Ÿæˆ**
```bash
python main.py 0x3ca32dd3666ed1b69e86b86b420b058caa8c1aaf -r
```
- ROEéƒ¨åˆ†å‡ºç°åœ¨MarkdownæŠ¥å‘Šä¸­
- è¡¨æ ¼æ ¼å¼æ­£ç¡®
- è®¡ç®—å…¬å¼æ¸…æ™°

âœ… **ç¼“å­˜æœºåˆ¶**
- ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼šAPIè¯·æ±‚
- 5åˆ†é’Ÿå†…ç¬¬äºŒæ¬¡è°ƒç”¨ï¼šä½¿ç”¨ç¼“å­˜
- force_refresh=Trueï¼šè·³è¿‡ç¼“å­˜

---

## ä»£ç é£æ ¼ä¸€è‡´æ€§

### éµå¾ªçš„æ¨¡å¼

âœ… **ç±»å‹æç¤º**: æ‰€æœ‰å‡½æ•°å‚æ•°å’Œè¿”å›å€¼ä½¿ç”¨ç±»å‹æç¤º

âœ… **Docstring**: ä½¿ç”¨Googleé£æ ¼æ–‡æ¡£å­—ç¬¦ä¸²

âœ… **é”™è¯¯å¤„ç†**: try-exceptåŒ…è£¹å…³é”®æ“ä½œ

âœ… **æ•°æ®ç±»**: ä½¿ç”¨@dataclassè£…é¥°å™¨

âœ… **å·¥å…·å‡½æ•°**: å¤ç”¨safe_float()ç­‰ç°æœ‰å·¥å…·

âœ… **ç¼“å­˜**: ä½¿ç”¨ç°æœ‰ç¼“å­˜æœºåˆ¶

âœ… **æ—¥å¿—**: ä½¿ç”¨printè¾“å‡ºçŠ¶æ€ä¿¡æ¯ï¼ˆâœ“ã€âœ—ã€âš ï¸ç­‰å›¾æ ‡ï¼‰

âœ… **æ ¼å¼åŒ–**: éµå¾ªç°æœ‰çš„è¡¨æ ¼æ˜¾ç¤ºæ ¼å¼

### å‘½åè§„èŒƒ

âœ… **æ–¹æ³•å**: snake_case (å¦‚: calculate_24h_roe)

âœ… **ç±»å**: PascalCase (å¦‚: ROEMetrics)

âœ… **å¸¸é‡**: UPPER_CASE

âœ… **ç§æœ‰æ–¹æ³•**: _leading_underscore

---

## ä¾èµ–å…³ç³»

### ä½¿ç”¨çš„ç°æœ‰ç»„ä»¶

- `HyperliquidAPIClient._make_request()` - APIè¯·æ±‚
- `safe_float()` - å­—ç¬¦ä¸²è½¬æµ®ç‚¹
- `ApexCalculator._get_cached_data()` - ç¼“å­˜è¯»å–
- `ApexCalculator._set_cache_data()` - ç¼“å­˜å†™å…¥
- `print_table_row()` - è¡¨æ ¼æ ¼å¼åŒ–
- `print_table_separator()` - è¡¨æ ¼åˆ†éš”çº¿
- `datetime` - æ—¶é—´å¤„ç†
- `dataclasses` - æ•°æ®ç±»

### æ— éœ€æ–°å¢ä¾èµ–

æ‰€æœ‰åŠŸèƒ½éƒ½åŸºäºç°æœ‰ä¾èµ–å®ç°ï¼Œæ— éœ€å®‰è£…æ–°çš„åŒ…ã€‚

---

## æˆåŠŸæ ‡å‡†éªŒè¯

### âœ… åŠŸèƒ½å®Œæ•´æ€§

- [x] ROEè®¡ç®—å‡†ç¡®ï¼ˆä¸æ‰‹å·¥è®¡ç®—ä¸€è‡´ï¼‰
- [x] æ‰€æœ‰è¾¹ç•Œæ¡ä»¶æ­£ç¡®å¤„ç†
- [x] é”™è¯¯å¤„ç†å¥å£®

### âœ… æ˜¾ç¤ºæ­£ç¡®æ€§

- [x] CLIè¾“å‡ºæ ¼å¼ç¾è§‚ã€ä¿¡æ¯å®Œæ•´
- [x] MarkdownæŠ¥å‘ŠåŒ…å«ROEéƒ¨åˆ†
- [x] è¯„çº§å’Œå›¾æ ‡æ˜¾ç¤ºæ­£ç¡®

### âœ… æ€§èƒ½ä¼˜åŒ–

- [x] ç¼“å­˜æœºåˆ¶å·¥ä½œæ­£å¸¸
- [x] APIè¯·æ±‚æ¬¡æ•°åˆç†ï¼ˆ5åˆ†é’Ÿç¼“å­˜ï¼‰
- [x] æ— æ€§èƒ½é€€åŒ–

### âœ… ä»£ç è´¨é‡

- [x] ä»£ç é£æ ¼ä¸ç°æœ‰é¡¹ç›®ä¸€è‡´
- [x] ç±»å‹æç¤ºå®Œæ•´
- [x] æ–‡æ¡£å­—ç¬¦ä¸²æ¸…æ™°
- [x] æ— å¼•å…¥æ–°çš„ä¾èµ–

### âœ… æµ‹è¯•è¦†ç›–

- [x] å•å…ƒæµ‹è¯•é€šè¿‡
- [x] é›†æˆæµ‹è¯•éªŒè¯é€šè¿‡
- [x] è¾¹ç•Œæ¡ä»¶æµ‹è¯•é€šè¿‡

---

## ä½¿ç”¨ç¤ºä¾‹

### CLIä½¿ç”¨

```bash
# åˆ†æç”¨æˆ·å¹¶æ˜¾ç¤ºROE
python main.py 0x3ca32dd3666ed1b69e86b86b420b058caa8c1aaf

# ç”ŸæˆåŒ…å«ROEçš„MarkdownæŠ¥å‘Š
python main.py 0x3ca32dd3666ed1b69e86b86b420b058caa8c1aaf -r
```

### Python APIä½¿ç”¨

```python
from apex_fork import ApexCalculator

calculator = ApexCalculator()

# è®¡ç®—ROE
roe_metrics = calculator.calculate_24h_roe(user_address)

if roe_metrics.is_valid:
    print(f"24h ROE: {roe_metrics.roe_percent:.2f}%")
    print(f"èµ·å§‹æƒç›Š: ${roe_metrics.start_equity:,.2f}")
    print(f"å½“å‰æƒç›Š: ${roe_metrics.current_equity:,.2f}")
    print(f"24h PNL: ${roe_metrics.pnl_24h:,.2f}")
else:
    print(f"é”™è¯¯: {roe_metrics.error_message}")
```

---

## æ½œåœ¨æ”¹è¿›æ–¹å‘

### çŸ­æœŸæ”¹è¿›

1. æ·»åŠ æ›´å¤šæ—¶é—´å‘¨æœŸçš„ROEï¼ˆ7å¤©ã€30å¤©ï¼‰
2. æ·»åŠ ROEè¶‹åŠ¿å›¾è¡¨
3. æ·»åŠ ROEå†å²è®°å½•

### é•¿æœŸæ”¹è¿›

1. æ”¯æŒè‡ªå®šä¹‰æ—¶é—´èŒƒå›´çš„ROEè®¡ç®—
2. ROEä¸å…¶ä»–æŒ‡æ ‡çš„ç›¸å…³æ€§åˆ†æ
3. åŸºäºROEçš„äº¤æ˜“ç­–ç•¥è¯„ä¼°

---

## æ€»ç»“

âœ… **æˆåŠŸå®ç°**: 24å°æ—¶ROEæŒ‡æ ‡å·²å®Œå…¨é›†æˆåˆ°Hyperliquidäº¤æ˜“åˆ†æå·¥å…·ä¸­

âœ… **è´¨é‡ä¿è¯**: ä»£ç è´¨é‡é«˜ï¼Œè¾¹ç•Œå¤„ç†å®Œå–„ï¼Œæµ‹è¯•è¦†ç›–å……åˆ†

âœ… **ç”¨æˆ·ä½“éªŒ**: CLIå’ŒMarkdownæŠ¥å‘Šéƒ½æœ‰æ¸…æ™°ç¾è§‚çš„ROEå±•ç¤º

âœ… **å¯ç»´æŠ¤æ€§**: ä»£ç é£æ ¼ä¸€è‡´ï¼Œæ–‡æ¡£å®Œæ•´ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤

âœ… **æ€§èƒ½ä¼˜åŒ–**: ç¼“å­˜æœºåˆ¶å‡å°‘APIè¯·æ±‚ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

---

**å®æ–½è€…**: Claude Sonnet 4.5
**å®æ–½æ—¥æœŸ**: 2026-02-04
**çŠ¶æ€**: âœ… å®Œæˆ
