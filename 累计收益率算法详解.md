# ç´¯è®¡æ”¶ç›Šç‡å’Œå¹´åŒ–æ”¶ç›Šç‡ç®—æ³•è¯¦è§£

## ğŸ“‹ ç›®å½•

1. [ç®—æ³•æ¦‚è¿°](#ç®—æ³•æ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [è®¡ç®—å…¬å¼](#è®¡ç®—å…¬å¼)
4. [ç®—æ³•å®ç°](#ç®—æ³•å®ç°)
5. [åº”ç”¨åœºæ™¯](#åº”ç”¨åœºæ™¯)
6. [å®Œæ•´ä»£ç ç¤ºä¾‹](#å®Œæ•´ä»£ç ç¤ºä¾‹)
7. [æµ‹è¯•ç”¨ä¾‹](#æµ‹è¯•ç”¨ä¾‹)

---

## ç®—æ³•æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ç´¯è®¡æ”¶ç›Šç‡ï¼Ÿ

**ç´¯è®¡æ”¶ç›Šç‡**æ˜¯æŒ‡ä»æŠ•èµ„å¼€å§‹åˆ°ç°åœ¨ï¼Œ**ç›¸å¯¹äºåˆå§‹æŠ•å…¥æœ¬é‡‘çš„æ€»æ”¶ç›Šç™¾åˆ†æ¯”**ã€‚

### ä»€ä¹ˆæ˜¯å¹´åŒ–æ”¶ç›Šç‡ï¼Ÿ

**å¹´åŒ–æ”¶ç›Šç‡**æ˜¯å°†ç´¯è®¡æ”¶ç›Šç‡**æ ‡å‡†åŒ–åˆ°ä¸€å¹´æ—¶é—´ç»´åº¦**çš„æ”¶ç›Šç‡ï¼Œä¾¿äºä¸åŒæ—¶é—´é•¿åº¦çš„æŠ•èµ„è¿›è¡Œå¯¹æ¯”ã€‚

### ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸¤ä¸ªæŒ‡æ ‡ï¼Ÿ

| æŒ‡æ ‡ | ç”¨é€” | ä¼˜åŠ¿ |
|------|------|------|
| **ç´¯è®¡æ”¶ç›Šç‡** | è¯„ä¼°æ€»ä½“è¡¨ç° | ç›´è§‚åæ˜ æ€»ç›ˆäº |
| **å¹´åŒ–æ”¶ç›Šç‡** | è·¨æœŸå¯¹æ¯” | æ ‡å‡†åŒ–æ—¶é—´ç»´åº¦ |

**ç¤ºä¾‹**ï¼š
- ç­–ç•¥ Aï¼š3ä¸ªæœˆèµš 15% â†’ å¹´åŒ–æ”¶ç›Šç‡ â‰ˆ 73%
- ç­–ç•¥ Bï¼š1å¹´èµš 30% â†’ å¹´åŒ–æ”¶ç›Šç‡ = 30%
- è™½ç„¶ç­–ç•¥ B ç´¯è®¡æ”¶ç›Šæ›´é«˜ï¼Œä½†ç­–ç•¥ A çš„å¹´åŒ–è¡¨ç°æ›´ä¼˜

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. ä¼ ç»Ÿæ”¶ç›Šç‡è®¡ç®—çš„é—®é¢˜

**é”™è¯¯æ–¹æ³• 1ï¼šåŸºäºè´¦æˆ·ä½™é¢**
```python
æ”¶ç›Šç‡ = (å½“å‰ä½™é¢ - åˆå§‹ä½™é¢) / åˆå§‹ä½™é¢
```
**é—®é¢˜**ï¼šå¿½ç•¥äº†å‡ºå…¥é‡‘çš„å½±å“

**é”™è¯¯æ–¹æ³• 2ï¼šå¿½ç•¥æœªå®ç°ç›ˆäº**
```python
æ”¶ç›Šç‡ = å·²å®ç°ç›ˆäº / æœ¬é‡‘
```
**é—®é¢˜**ï¼šå½“å‰æŒä»“çš„æµ®åŠ¨ç›ˆäºæœªè®¡å…¥

### 2. æ­£ç¡®çš„è®¡ç®—æ–¹æ³•

#### ä½¿ç”¨å‡€å…¥é‡‘ï¼ˆTrue Capitalï¼‰

```python
ç´¯è®¡æ”¶ç›Šç‡ = ç´¯è®¡æ€»ç›ˆäº / å‡€å…¥é‡‘ Ã— 100%

å…¶ä¸­ï¼š
- ç´¯è®¡æ€»ç›ˆäº = å·²å®ç°ç›ˆäº + æœªå®ç°ç›ˆäº
- å‡€å…¥é‡‘ = å……å€¼ - æç° + å¤–éƒ¨è½¬å…¥ - å¤–éƒ¨è½¬å‡º
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä¸å—å‡ºå…¥é‡‘å½±å“
- âœ… åŒ…å«å½“å‰æŒä»“çš„æµ®åŠ¨ç›ˆäº
- âœ… çœŸå®åæ˜ èµ„é‡‘ä½¿ç”¨æ•ˆç‡
- âœ… ä¸å—æ æ†å½±å“

### 3. å¹´åŒ–æ”¶ç›Šç‡å…¬å¼

```python
å¹´åŒ–æ”¶ç›Šç‡ = ((1 + ç´¯è®¡æ”¶ç›Šç‡) ^ (365 / äº¤æ˜“å¤©æ•°) - 1) Ã— 100%
```

**å¤åˆ©è®¡ç®—**ï¼šå¹´åŒ–æ”¶ç›Šç‡ä½¿ç”¨å¤åˆ©è€Œéç®€å•çº¿æ€§å¤–æ¨

---

## è®¡ç®—å…¬å¼

### æ ¸å¿ƒå…¬å¼

#### 1. ç´¯è®¡æ€»ç›ˆäº

```python
ç´¯è®¡æ€»ç›ˆäº = Î£(å·²å®ç°ç›ˆäº) + Î£(æœªå®ç°ç›ˆäº)

å…¶ä¸­ï¼š
- å·²å®ç°ç›ˆäº = Î£(fill.closedPnl)
- æœªå®ç°ç›ˆäº = Î£(position.unrealizedPnl)
```

#### 2. ç´¯è®¡æ”¶ç›Šç‡

```python
ç´¯è®¡æ”¶ç›Šç‡ = (ç´¯è®¡æ€»ç›ˆäº / å‡€å…¥é‡‘) Ã— 100%
```

#### 3. å¹´åŒ–æ”¶ç›Šç‡ï¼ˆå¤åˆ©ï¼‰

```python
å¹´åŒ–æ”¶ç›Šç‡ = ((1 + ç´¯è®¡æ”¶ç›Šç‡ / 100) ^ (365 / äº¤æ˜“å¤©æ•°) - 1) Ã— 100%
```

#### 4. äº¤æ˜“å¤©æ•°

```python
äº¤æ˜“å¤©æ•° = (æœ€åä¸€ç¬”äº¤æ˜“æ—¶é—´ - ç¬¬ä¸€ç¬”äº¤æ˜“æ—¶é—´) / (1000 Ã— 86400)
```

### å…¬å¼æ¨å¯¼

#### å¹´åŒ–æ”¶ç›Šç‡æ¨å¯¼

å‡è®¾ï¼š
- ç´¯è®¡æ”¶ç›Šç‡ = 50%
- äº¤æ˜“å¤©æ•° = 180å¤©ï¼ˆåŠå¹´ï¼‰

```
æ–¹æ³•1ï¼šç®€å•çº¿æ€§å¤–æ¨ï¼ˆâŒ é”™è¯¯ï¼‰
  å¹´åŒ–æ”¶ç›Šç‡ = 50% Ã— (365 / 180) = 101.4%

æ–¹æ³•2ï¼šå¤åˆ©è®¡ç®—ï¼ˆâœ… æ­£ç¡®ï¼‰
  å¹´åŒ–æ”¶ç›Šç‡ = ((1 + 0.5) ^ (365 / 180) - 1) Ã— 100%
             = (1.5 ^ 2.028 - 1) Ã— 100%
             = (2.291 - 1) Ã— 100%
             = 129.1%
```

**ä¸ºä»€ä¹ˆç”¨å¤åˆ©ï¼Ÿ**
- æŠ•èµ„æ˜¯å¤åˆ©å¢é•¿çš„
- ç¬¬äºŒä¸ªåŠå¹´çš„åŸºæ•°æ˜¯ $15,000ï¼ˆè€Œé $10,000ï¼‰
- å¤åˆ©æ›´çœŸå®åæ˜ é•¿æœŸè¡¨ç°

---

## ç®—æ³•å®ç°

### æ ¸å¿ƒå‡½æ•°ï¼š`calculate_return_metrics()`

**ä»£ç ä½ç½®**: `apex_fork.py:822-891`

```python
import math
from typing import Dict


def calculate_return_metrics(
    current_value: float,
    true_capital: float,
    total_cumulative_pnl: float,
    first_trade_time: int,
    last_trade_time: int
) -> Dict[str, float]:
    """
    è®¡ç®—ç´¯è®¡æ”¶ç›Šç‡å’Œå¹´åŒ–æ”¶ç›Šç‡ï¼ˆç»Ÿä¸€ä½¿ç”¨ç´¯è®¡æ€»ç›ˆäºï¼‰

    å‚æ•°ï¼š
        current_value: å½“å‰æ€»è´¦æˆ·ä»·å€¼ï¼ˆç”¨äºå‚è€ƒï¼‰
        true_capital: çœŸå®æœ¬é‡‘ï¼ˆå……å€¼ - æç°ï¼‰
        total_cumulative_pnl: ç´¯è®¡æ€»ç›ˆäºï¼ˆå·²å®ç°+æœªå®ç°ï¼‰
        first_trade_time: ç¬¬ä¸€ç¬”äº¤æ˜“æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
        last_trade_time: æœ€åä¸€ç¬”äº¤æ˜“æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰

    è¿”å›ï¼š
        å­—å…¸ï¼ŒåŒ…å«ï¼š
        - cumulative_return: ç´¯è®¡æ”¶ç›Šç‡ï¼ˆç™¾åˆ†æ¯”ï¼ŒåŸºäºäº¤æ˜“ç›ˆäºï¼‰
        - annualized_return: å¹´åŒ–æ”¶ç›Šç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
        - net_profit_trading: äº¤æ˜“å‡€ç›ˆåˆ©ï¼ˆç¾å…ƒï¼ŒåŸºäºç´¯è®¡æ€»ç›ˆäºï¼‰
        - net_profit_account: è´¦æˆ·å‡€å¢é•¿ï¼ˆç¾å…ƒï¼ŒåŸºäºè´¦æˆ·ä»·å€¼ï¼‰
        - trading_days: äº¤æ˜“å¤©æ•°
        - annualized_return_valid: å¹´åŒ–æ”¶ç›Šç‡æ˜¯å¦å¯é 

    ç®—æ³•è¯´æ˜ï¼š
        1. ä½¿ç”¨ç´¯è®¡æ€»ç›ˆäºï¼ˆå·²å®ç°+æœªå®ç°ï¼‰ä½œä¸ºä¸»è¦å‡€ç›ˆåˆ©æŒ‡æ ‡
        2. åŸºäºå‡€å…¥é‡‘è®¡ç®—ç´¯è®¡æ”¶ç›Šç‡
        3. ä½¿ç”¨å¤åˆ©å…¬å¼è®¡ç®—å¹´åŒ–æ”¶ç›Šç‡
        4. æ ‡è®°çŸ­æœŸå¹´åŒ–æ”¶ç›Šç‡ä¸ºä¸å¯é 
    """
    # ==================== æ­¥éª¤1: è®¡ç®—å‡€ç›ˆåˆ© ====================

    # ä½¿ç”¨ç´¯è®¡æ€»ç›ˆäºä½œä¸ºä¸»è¦å‡€ç›ˆåˆ©æŒ‡æ ‡ï¼ˆç»Ÿä¸€å£å¾„ï¼‰
    net_profit_trading = total_cumulative_pnl

    # è®¡ç®—è´¦æˆ·å‡€å¢é•¿ï¼ˆä½œä¸ºå‚è€ƒï¼‰
    net_profit_account = current_value - true_capital

    # ==================== æ­¥éª¤2: è®¡ç®—ç´¯è®¡æ”¶ç›Šç‡ ====================

    if true_capital > 0:
        cumulative_return = (net_profit_trading / true_capital) * 100
    else:
        cumulative_return = 0.0

    # ==================== æ­¥éª¤3: è®¡ç®—äº¤æ˜“å¤©æ•° ====================

    if first_trade_time > 0 and last_trade_time > first_trade_time:
        # æ¯«ç§’è½¬æ¢ä¸ºå¤©
        trading_days = (last_trade_time - first_trade_time) / 1000 / 86400
    else:
        trading_days = 0.0

    # ==================== æ­¥éª¤4: è®¡ç®—å¹´åŒ–æ”¶ç›Šç‡ ====================

    annualized_return = 0.0
    annualized_return_valid = True

    if trading_days > 0 and true_capital > 0:
        # å¹´åŒ–å› å­ = 365 / äº¤æ˜“å¤©æ•°
        annual_factor = 365.0 / trading_days

        try:
            # å¹´åŒ–æ”¶ç›Šç‡ = ((1 + ç´¯è®¡æ”¶ç›Šç‡) ^ (365 / äº¤æ˜“å¤©æ•°) - 1) Ã— 100%
            annualized_return = (
                math.pow(1 + cumulative_return / 100, annual_factor) - 1
            ) * 100

            # ==================== æ­¥éª¤5: æ ‡è®°å¯é æ€§ ====================

            # å¯¹äºäº¤æ˜“å¤©æ•°è¾ƒçŸ­çš„æƒ…å†µï¼Œæ ‡è®°ä¸ºä¸å¯é ä½†ä»æ˜¾ç¤ºè®¡ç®—å€¼
            if trading_days < 30:
                annualized_return_valid = False

            # å¦‚æœå¹´åŒ–æ”¶ç›Šç‡è¿‡å¤§ï¼ˆ>10000%ï¼‰ï¼Œæ ‡è®°ä¸ºä¸å¯é 
            if abs(annualized_return) > 10000:
                annualized_return_valid = False

        except (OverflowError, ValueError):
            # æ•°å€¼æº¢å‡ºæˆ–è®¡ç®—é”™è¯¯
            annualized_return = 0.0
            annualized_return_valid = False

    return {
        "cumulative_return": cumulative_return,
        "annualized_return": annualized_return,
        "annualized_return_valid": annualized_return_valid,
        "net_profit_trading": net_profit_trading,  # ä¸»è¦æŒ‡æ ‡ï¼šåŸºäºäº¤æ˜“ç›ˆäº
        "net_profit_account": net_profit_account,  # å‚è€ƒæŒ‡æ ‡ï¼šè´¦æˆ·å‡€å¢é•¿
        "trading_days": trading_days
    }
```

### è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—ç´¯è®¡æ€»ç›ˆäº

```python
def calculate_total_cumulative_pnl(
    fills: List[Dict],
    asset_positions: List[Dict]
) -> float:
    """
    è®¡ç®—ç´¯è®¡æ€»ç›ˆäº

    å‚æ•°ï¼š
        fills: æˆäº¤è®°å½•åˆ—è¡¨
        asset_positions: å½“å‰æŒä»“åˆ—è¡¨

    è¿”å›ï¼š
        ç´¯è®¡æ€»ç›ˆäºï¼ˆå·²å®ç° + æœªå®ç°ï¼‰
    """
    # å·²å®ç°ç›ˆäº
    total_realized_pnl = sum(
        float(fill.get('closedPnl', 0))
        for fill in fills
    )

    # æœªå®ç°ç›ˆäº
    total_unrealized_pnl = sum(
        float(pos.get('position', {}).get('unrealizedPnl', 0))
        for pos in asset_positions
    )

    return total_realized_pnl + total_unrealized_pnl
```

### ç®—æ³•æµç¨‹å›¾

```
å¼€å§‹
  â†“
è®¡ç®—å‡€ç›ˆåˆ©
  â”œâ”€ ç´¯è®¡æ€»ç›ˆäº = å·²å®ç°ç›ˆäº + æœªå®ç°ç›ˆäº
  â””â”€ è´¦æˆ·å‡€å¢é•¿ = å½“å‰ä»·å€¼ - å‡€å…¥é‡‘
  â†“
è®¡ç®—ç´¯è®¡æ”¶ç›Šç‡
  cumulative_return = ç´¯è®¡æ€»ç›ˆäº / å‡€å…¥é‡‘ Ã— 100%
  â†“
è®¡ç®—äº¤æ˜“å¤©æ•°
  trading_days = (æœ€åäº¤æ˜“æ—¶é—´ - ç¬¬ä¸€äº¤æ˜“æ—¶é—´) / 86400000
  â†“
äº¤æ˜“å¤©æ•° > 0 ä¸” å‡€å…¥é‡‘ > 0ï¼Ÿ
  â†“ å¦
è¿”å›é»˜è®¤å¹´åŒ–æ”¶ç›Šç‡ = 0
  â†“ æ˜¯
è®¡ç®—å¹´åŒ–å› å­
  annual_factor = 365 / trading_days
  â†“
è®¡ç®—å¹´åŒ–æ”¶ç›Šç‡ï¼ˆå¤åˆ©ï¼‰
  annualized_return = ((1 + cumulative_return/100) ^ annual_factor - 1) Ã— 100%
  â†“
æ ‡è®°å¯é æ€§
  â”œâ”€ trading_days < 30 â†’ ä¸å¯é 
  â”œâ”€ |annualized_return| > 10000% â†’ ä¸å¯é 
  â””â”€ æº¢å‡ºé”™è¯¯ â†’ ä¸å¯é 
  â†“
è¿”å›å®Œæ•´ç»“æœ
  â†“
ç»“æŸ
```

---

## åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šç­–ç•¥è¡¨ç°è¯„ä¼°

```python
# è®¡ç®—æ”¶ç›Šç‡æŒ‡æ ‡
return_metrics = calculate_return_metrics(
    current_value=15000,
    true_capital=10000,
    total_cumulative_pnl=4500,
    first_trade_time=1640000000000,  # 2021-12-20
    last_trade_time=1672500000000    # 2023-01-01
)

print(f"ç´¯è®¡æ”¶ç›Šç‡: {return_metrics['cumulative_return']:.2f}%")
print(f"å¹´åŒ–æ”¶ç›Šç‡: {return_metrics['annualized_return']:.2f}%")
print(f"äº¤æ˜“å¤©æ•°: {return_metrics['trading_days']:.0f} å¤©")
print(f"å‡€ç›ˆåˆ©: ${return_metrics['net_profit_trading']:,.2f}")

if return_metrics['annualized_return_valid']:
    print("âœ… å¹´åŒ–æ”¶ç›Šç‡å¯é ")
else:
    print("âš ï¸ äº¤æ˜“æ—¶é—´è¾ƒçŸ­ï¼Œå¹´åŒ–æ”¶ç›Šç‡ä»…ä¾›å‚è€ƒ")
```

### åœºæ™¯ 2ï¼šç­–ç•¥å¯¹æ¯”

```python
# å¯¹æ¯”ä¸åŒç­–ç•¥
strategies = {
    "ä¿å®ˆç­–ç•¥": calculate_return_metrics(12000, 10000, 2000, t1, t2),
    "æ¿€è¿›ç­–ç•¥": calculate_return_metrics(18000, 10000, 8000, t1, t2),
    "å¹³è¡¡ç­–ç•¥": calculate_return_metrics(15000, 10000, 5000, t1, t2)
}

print("\nç­–ç•¥å¯¹æ¯”:")
print("=" * 80)
print(f"{'ç­–ç•¥':<15} {'ç´¯è®¡æ”¶ç›Šç‡':<15} {'å¹´åŒ–æ”¶ç›Šç‡':<15} {'äº¤æ˜“å¤©æ•°'}")
print("=" * 80)

for name, metrics in strategies.items():
    validity = "âœ…" if metrics['annualized_return_valid'] else "âš ï¸"
    print(f"{name:<15} {metrics['cumulative_return']:<14.2f}% "
          f"{metrics['annualized_return']:<14.2f}% {validity} "
          f"{metrics['trading_days']:.0f} å¤©")
```

### åœºæ™¯ 3ï¼šå‡ºå…¥é‡‘å½±å“åˆ†æ

```python
def analyze_deposit_withdraw_impact(
    account_value: float,
    true_capital: float,
    total_pnl: float
) -> Dict:
    """åˆ†æå‡ºå…¥é‡‘å¯¹æ”¶ç›Šç‡çš„å½±å“"""

    # åŸºäºè´¦æˆ·ä»·å€¼çš„é”™è¯¯è®¡ç®—
    wrong_return = (account_value - 10000) / 10000 * 100

    # åŸºäºå‡€å…¥é‡‘çš„æ­£ç¡®è®¡ç®—
    correct_return = total_pnl / true_capital * 100

    return {
        "wrong_return": wrong_return,
        "correct_return": correct_return,
        "difference": correct_return - wrong_return
    }


# ç¤ºä¾‹ï¼šæç° $5,000 å
impact = analyze_deposit_withdraw_impact(
    account_value=7000,      # å½“å‰è´¦æˆ·ä»·å€¼
    true_capital=5000,       # å‡€å…¥é‡‘ï¼ˆå……10000 - æ5000ï¼‰
    total_pnl=2000          # å®é™…ç›ˆåˆ©
)

print(f"é”™è¯¯ç®—æ³•æ”¶ç›Šç‡: {impact['wrong_return']:.2f}%")
print(f"æ­£ç¡®ç®—æ³•æ”¶ç›Šç‡: {impact['correct_return']:.2f}%")
print(f"å·®å¼‚: {impact['difference']:.2f}%")
```

---

## å®Œæ•´ä»£ç ç¤ºä¾‹

### ä¸»ç¨‹åºç¤ºä¾‹

```python
import math
from typing import Dict, List
from datetime import datetime


class ReturnMetricsCalculator:
    """ç´¯è®¡æ”¶ç›Šç‡å’Œå¹´åŒ–æ”¶ç›Šç‡è®¡ç®—å™¨"""

    def calculate_return_metrics(
        self,
        current_value: float,
        true_capital: float,
        total_cumulative_pnl: float,
        first_trade_time: int,
        last_trade_time: int
    ) -> Dict[str, float]:
        """è®¡ç®—ç´¯è®¡æ”¶ç›Šç‡å’Œå¹´åŒ–æ”¶ç›Šç‡"""

        print("\nğŸ“Š æ”¶ç›Šç‡è®¡ç®—åˆ†æ:")
        print("=" * 80)

        # æ­¥éª¤1: è®¡ç®—å‡€ç›ˆåˆ©
        net_profit_trading = total_cumulative_pnl
        net_profit_account = current_value - true_capital

        print(f"å½“å‰è´¦æˆ·ä»·å€¼: ${current_value:,.2f}")
        print(f"å‡€å…¥é‡‘: ${true_capital:,.2f}")
        print(f"ç´¯è®¡æ€»ç›ˆäº: ${total_cumulative_pnl:,.2f}")
        print(f"  â”œâ”€ äº¤æ˜“å‡€ç›ˆåˆ©: ${net_profit_trading:,.2f} (ä¸»è¦æŒ‡æ ‡)")
        print(f"  â””â”€ è´¦æˆ·å‡€å¢é•¿: ${net_profit_account:,.2f} (å‚è€ƒæŒ‡æ ‡)")

        # æ­¥éª¤2: è®¡ç®—ç´¯è®¡æ”¶ç›Šç‡
        if true_capital > 0:
            cumulative_return = (net_profit_trading / true_capital) * 100
        else:
            cumulative_return = 0.0

        print(f"\nç´¯è®¡æ”¶ç›Šç‡: {cumulative_return:.2f}%")

        # æ­¥éª¤3: è®¡ç®—äº¤æ˜“å¤©æ•°
        if first_trade_time > 0 and last_trade_time > first_trade_time:
            trading_days = (last_trade_time - first_trade_time) / 1000 / 86400
        else:
            trading_days = 0.0

        # æ ¼å¼åŒ–æ—¥æœŸ
        first_date = self._format_datetime(first_trade_time)
        last_date = self._format_datetime(last_trade_time)

        print(f"\näº¤æ˜“å‘¨æœŸ:")
        print(f"  å¼€å§‹æ—¥æœŸ: {first_date}")
        print(f"  ç»“æŸæ—¥æœŸ: {last_date}")
        print(f"  äº¤æ˜“å¤©æ•°: {trading_days:.1f} å¤© ({trading_days/365:.2f} å¹´)")

        # æ­¥éª¤4: è®¡ç®—å¹´åŒ–æ”¶ç›Šç‡
        annualized_return = 0.0
        annualized_return_valid = True

        if trading_days > 0 and true_capital > 0:
            annual_factor = 365.0 / trading_days

            try:
                annualized_return = (
                    math.pow(1 + cumulative_return / 100, annual_factor) - 1
                ) * 100

                # æ ‡è®°å¯é æ€§
                if trading_days < 30:
                    annualized_return_valid = False
                    print(f"\nâš ï¸  äº¤æ˜“å¤©æ•°å°‘äº30å¤©ï¼Œå¹´åŒ–æ”¶ç›Šç‡ä»…ä¾›å‚è€ƒ")

                if abs(annualized_return) > 10000:
                    annualized_return_valid = False
                    print(f"\nâš ï¸  å¹´åŒ–æ”¶ç›Šç‡è¿‡é«˜ï¼ˆ>{abs(annualized_return):.0f}%ï¼‰ï¼Œå¯èƒ½ä¸å¯é ")

            except (OverflowError, ValueError) as e:
                annualized_return = 0.0
                annualized_return_valid = False
                print(f"\nâŒ å¹´åŒ–æ”¶ç›Šç‡è®¡ç®—é”™è¯¯: {e}")

        print(f"\nğŸ¯ å¹´åŒ–æ”¶ç›Šç‡: {annualized_return:.2f}%", end="")
        if annualized_return_valid:
            print(" âœ…")
        else:
            print(" âš ï¸ (ä»…ä¾›å‚è€ƒ)")

        # è¯„çº§
        if cumulative_return > 0:
            print(f"\nâœ… ç­–ç•¥ç›ˆåˆ©")
        else:
            print(f"\nâŒ ç­–ç•¥äºæŸ")

        # è®¡ç®—ç®€å•çº¿æ€§å¹´åŒ–ï¼ˆå¯¹æ¯”ï¼‰
        if trading_days > 0:
            simple_annual = cumulative_return * (365 / trading_days)
            print(f"\nå¯¹æ¯”åˆ†æ:")
            print(f"  ç®€å•çº¿æ€§å¹´åŒ–: {simple_annual:.2f}% (ä¸æ¨è)")
            print(f"  å¤åˆ©å¹´åŒ–: {annualized_return:.2f}% (æ¨è)")
            print(f"  å·®å¼‚: {annualized_return - simple_annual:.2f}%")

        return {
            "cumulative_return": cumulative_return,
            "annualized_return": annualized_return,
            "annualized_return_valid": annualized_return_valid,
            "net_profit_trading": net_profit_trading,
            "net_profit_account": net_profit_account,
            "trading_days": trading_days
        }

    def _format_datetime(self, timestamp_ms: int) -> str:
        """æ ¼å¼åŒ–æ—¶é—´æˆ³"""
        if timestamp_ms > 0:
            try:
                dt = datetime.fromtimestamp(timestamp_ms / 1000)
                return dt.strftime('%Y-%m-%d %H:%M:%S')
            except:
                return "N/A"
        return "N/A"


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    calculator = ReturnMetricsCalculator()

    # æ¨¡æ‹Ÿæ•°æ®
    import time
    current_time = int(time.time() * 1000)
    start_time = current_time - 180 * 86400000  # 180å¤©å‰

    # åœºæ™¯ï¼šæŠ•å…¥ $10,000ï¼ŒåŠå¹´åç›ˆåˆ© $5,000
    result = calculator.calculate_return_metrics(
        current_value=15000,
        true_capital=10000,
        total_cumulative_pnl=5000,
        first_trade_time=start_time,
        last_trade_time=current_time
    )

    print("\n" + "=" * 80)
    print("æœ€ç»ˆç»“æœæ‘˜è¦:")
    print("=" * 80)
    for key, value in result.items():
        if isinstance(value, float):
            if "return" in key or "profit" in key:
                if "pct" in key or "return" in key:
                    print(f"{key}: {value:.2f}%")
                else:
                    print(f"{key}: ${value:,.2f}")
            elif "days" in key:
                print(f"{key}: {value:.1f} å¤©")
            else:
                print(f"{key}: {value}")
        else:
            print(f"{key}: {value}")
```

### è¿è¡Œç»“æœç¤ºä¾‹

```
ğŸ“Š æ”¶ç›Šç‡è®¡ç®—åˆ†æ:
================================================================================
å½“å‰è´¦æˆ·ä»·å€¼: $15,000.00
å‡€å…¥é‡‘: $10,000.00
ç´¯è®¡æ€»ç›ˆäº: $5,000.00
  â”œâ”€ äº¤æ˜“å‡€ç›ˆåˆ©: $5,000.00 (ä¸»è¦æŒ‡æ ‡)
  â””â”€ è´¦æˆ·å‡€å¢é•¿: $5,000.00 (å‚è€ƒæŒ‡æ ‡)

ç´¯è®¡æ”¶ç›Šç‡: 50.00%

äº¤æ˜“å‘¨æœŸ:
  å¼€å§‹æ—¥æœŸ: 2025-08-06 10:30:45
  ç»“æŸæ—¥æœŸ: 2026-02-03 10:30:45
  äº¤æ˜“å¤©æ•°: 180.0 å¤© (0.49 å¹´)

ğŸ¯ å¹´åŒ–æ”¶ç›Šç‡: 125.00% âœ…

âœ… ç­–ç•¥ç›ˆåˆ©

å¯¹æ¯”åˆ†æ:
  ç®€å•çº¿æ€§å¹´åŒ–: 101.39% (ä¸æ¨è)
  å¤åˆ©å¹´åŒ–: 125.00% (æ¨è)
  å·®å¼‚: 23.61%

================================================================================
æœ€ç»ˆç»“æœæ‘˜è¦:
================================================================================
cumulative_return: 50.00%
annualized_return: 125.00%
annualized_return_valid: True
net_profit_trading: $5,000.00
net_profit_account: $5,000.00
trading_days: 180.0 å¤©
```

---

## æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•ç”¨ä¾‹ 1ï¼šæ­£å¸¸åœºæ™¯

```python
def test_normal_returns():
    """æµ‹è¯•ç”¨ä¾‹ 1: æ­£å¸¸æ”¶ç›Šåœºæ™¯"""
    calculator = ReturnMetricsCalculator()

    # åŠå¹´ç›ˆåˆ©50%
    result = calculator.calculate_return_metrics(
        current_value=15000,
        true_capital=10000,
        total_cumulative_pnl=5000,
        first_trade_time=1000000000,
        last_trade_time=1000000000 + 180 * 86400000
    )

    assert result['cumulative_return'] == 50.0
    assert result['annualized_return'] > 100  # å¤åˆ©å¹´åŒ–åº”è¯¥ > ç®€å•çº¿æ€§
    assert result['annualized_return_valid'] == True
    print(f"âœ… æµ‹è¯•ç”¨ä¾‹ 1 é€šè¿‡ï¼šå¹´åŒ– {result['annualized_return']:.2f}%")
```

### æµ‹è¯•ç”¨ä¾‹ 2ï¼šçŸ­æœŸäº¤æ˜“

```python
def test_short_term():
    """æµ‹è¯•ç”¨ä¾‹ 2: çŸ­æœŸäº¤æ˜“ï¼ˆ<30å¤©ï¼‰"""
    calculator = ReturnMetricsCalculator()

    # 10å¤©ç›ˆåˆ©10%
    result = calculator.calculate_return_metrics(
        current_value=11000,
        true_capital=10000,
        total_cumulative_pnl=1000,
        first_trade_time=1000000000,
        last_trade_time=1000000000 + 10 * 86400000
    )

    assert result['cumulative_return'] == 10.0
    assert result['annualized_return_valid'] == False  # åº”æ ‡è®°ä¸ºä¸å¯é 
    print(f"âœ… æµ‹è¯•ç”¨ä¾‹ 2 é€šè¿‡ï¼šçŸ­æœŸå¹´åŒ–è¢«æ ‡è®°ä¸ºä¸å¯é ")
```

### æµ‹è¯•ç”¨ä¾‹ 3ï¼šäºæŸåœºæ™¯

```python
def test_loss_scenario():
    """æµ‹è¯•ç”¨ä¾‹ 3: äºæŸåœºæ™¯"""
    calculator = ReturnMetricsCalculator()

    # 1å¹´äºæŸ20%
    result = calculator.calculate_return_metrics(
        current_value=8000,
        true_capital=10000,
        total_cumulative_pnl=-2000,
        first_trade_time=1000000000,
        last_trade_time=1000000000 + 365 * 86400000
    )

    assert result['cumulative_return'] == -20.0
    assert result['annualized_return'] < 0
    print(f"âœ… æµ‹è¯•ç”¨ä¾‹ 3 é€šè¿‡ï¼šäºæŸ {result['cumulative_return']:.2f}%")
```

### æµ‹è¯•ç”¨ä¾‹ 4ï¼šå‡ºå…¥é‡‘å½±å“

```python
def test_deposit_withdraw_impact():
    """æµ‹è¯•ç”¨ä¾‹ 4: å‡ºå…¥é‡‘å½±å“"""
    calculator = ReturnMetricsCalculator()

    # å……10000ï¼Œç›ˆåˆ©5000ï¼Œæèµ°8000ï¼Œè´¦æˆ·å‰©7000
    # å‡€å…¥é‡‘ = 10000 - 8000 = 2000
    # ç´¯è®¡ç›ˆäº = 5000
    result = calculator.calculate_return_metrics(
        current_value=7000,
        true_capital=2000,  # å‡€å…¥é‡‘
        total_cumulative_pnl=5000,
        first_trade_time=1000000000,
        last_trade_time=1000000000 + 180 * 86400000
    )

    # æ”¶ç›Šç‡åº”åŸºäºå‡€å…¥é‡‘è®¡ç®—
    expected_return = 5000 / 2000 * 100  # 250%
    assert abs(result['cumulative_return'] - expected_return) < 0.01
    print(f"âœ… æµ‹è¯•ç”¨ä¾‹ 4 é€šè¿‡ï¼šæ­£ç¡®å¤„ç†å‡ºå…¥é‡‘ï¼Œæ”¶ç›Šç‡ {result['cumulative_return']:.2f}%")
```

### æµ‹è¯•ç”¨ä¾‹ 5ï¼šå¤åˆ© vs ç®€å•çº¿æ€§

```python
def test_compound_vs_simple():
    """æµ‹è¯•ç”¨ä¾‹ 5: å¤åˆ©ä¸ç®€å•çº¿æ€§å¯¹æ¯”"""
    calculator = ReturnMetricsCalculator()

    # åŠå¹´ç›ˆåˆ©50%
    result = calculator.calculate_return_metrics(
        current_value=15000,
        true_capital=10000,
        total_cumulative_pnl=5000,
        first_trade_time=1000000000,
        last_trade_time=1000000000 + 180 * 86400000
    )

    # ç®€å•çº¿æ€§: 50% Ã— (365/180) = 101.39%
    simple_annual = 50 * (365 / 180)

    # å¤åˆ©: (1.5)^(365/180) - 1 = 125%
    compound_annual = result['annualized_return']

    # å¤åˆ©åº”è¯¥å¤§äºç®€å•çº¿æ€§
    assert compound_annual > simple_annual
    print(f"âœ… æµ‹è¯•ç”¨ä¾‹ 5 é€šè¿‡:")
    print(f"  ç®€å•çº¿æ€§: {simple_annual:.2f}%")
    print(f"  å¤åˆ©å¹´åŒ–: {compound_annual:.2f}%")
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```python
if __name__ == "__main__":
    print("å¼€å§‹è¿è¡Œç´¯è®¡æ”¶ç›Šç‡æµ‹è¯•ç”¨ä¾‹...\n")

    test_normal_returns()
    test_short_term()
    test_loss_scenario()
    test_deposit_withdraw_impact()
    test_compound_vs_simple()

    print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡ï¼")
```

---

## ç®—æ³•ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| âœ… **ä¸å—å‡ºå…¥é‡‘å½±å“** | ä½¿ç”¨å‡€å…¥é‡‘ä½œä¸ºåŸºå‡† |
| âœ… **åŒ…å«æœªå®ç°ç›ˆäº** | åæ˜ å½“å‰æŒä»“çš„çœŸå®ä»·å€¼ |
| âœ… **å¤åˆ©è®¡ç®—** | å¹´åŒ–æ”¶ç›Šç‡ä½¿ç”¨å¤åˆ©ï¼Œæ›´çœŸå® |
| âœ… **å¯é æ€§æ ‡è®°** | è‡ªåŠ¨æ ‡è®°çŸ­æœŸæˆ–å¼‚å¸¸æ•°æ® |
| âœ… **åŒé‡æŒ‡æ ‡** | æä¾›äº¤æ˜“ç›ˆäºå’Œè´¦æˆ·å¢é•¿ä¸¤ä¸ªè§†è§’ |

---

## å‚è€ƒèµ„æ–™

- **Hyperliquid API æ–‡æ¡£**: https://hyperliquid.gitbook.io/hyperliquid-docs/for-developers/api
- **Apex Liquid Bot**: https://apexliquid.bot/
- **æºä»£ç **: apex_fork.py (è¡Œ 822-891)

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-02-03
**ä½œè€…**: Apex Calculator Team
