# èƒœç‡ç»Ÿè®¡ï¼ˆWin Rateï¼‰ç®—æ³•è¯¦è§£

## ğŸ“‹ ç›®å½•

1. [ç®—æ³•æ¦‚è¿°](#ç®—æ³•æ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [è®¡ç®—å…¬å¼](#è®¡ç®—å…¬å¼)
4. [ç®—æ³•å®ç°](#ç®—æ³•å®ç°)
5. [åº”ç”¨åœºæ™¯](#åº”ç”¨åœºæ™¯)
6. [å®Œæ•´ä»£ç ç¤ºä¾‹](#å®Œæ•´ä»£ç ç¤ºä¾‹)
7. [æµ‹è¯•ç”¨ä¾‹](#æµ‹è¯•ç”¨ä¾‹)

---

## ç®—æ³•æ¦‚è¿°

### ä»€ä¹ˆæ˜¯èƒœç‡ï¼ˆWin Rateï¼‰ï¼Ÿ

**èƒœç‡**æ˜¯æŒ‡åœ¨æ‰€æœ‰äº¤æ˜“ä¸­ï¼Œ**ç›ˆåˆ©äº¤æ˜“å æ€»äº¤æ˜“çš„ç™¾åˆ†æ¯”**ï¼Œæ˜¯è¯„ä¼°äº¤æ˜“ç­–ç•¥å‡†ç¡®æ€§çš„å…³é”®æŒ‡æ ‡ã€‚

### æŒ‡æ ‡æ„ä¹‰

- **Win Rate > 50%**: ç›ˆåˆ©äº¤æ˜“å¤šäºäºæŸäº¤æ˜“
- **Win Rate = 50%**: ç›ˆäºäº¤æ˜“æ•°é‡ç›¸ç­‰
- **Win Rate < 50%**: äºæŸäº¤æ˜“å¤šäºç›ˆåˆ©äº¤æ˜“

### ä¸ºä»€ä¹ˆéœ€è¦èƒœç‡ï¼Ÿ

èƒœç‡åæ˜ äº†äº¤æ˜“ç­–ç•¥çš„**æˆåŠŸç‡**ï¼Œä½†éœ€è¦ä¸ç›ˆäºæ¯”ç»“åˆåˆ†æï¼š

| èƒœç‡ | ç›ˆäºæ¯” | è¯„ä¼° |
|------|-------|------|
| 80% | 1:5 | âŒ é«˜èƒœç‡ä½†ç›ˆäºæ¯”å·® |
| 40% | 5:1 | âœ… ä½èƒœç‡ä½†ç›ˆäºæ¯”ä¼˜ç§€ |
| 60% | 3:1 | ğŸ† ç†æƒ³ç»„åˆ |

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. èƒœç‡ï¼ˆWin Rateï¼‰

```python
win_rate = (winning_trades / total_trades) * 100
```

**ç¤ºä¾‹**ï¼š
- æ€»äº¤æ˜“ï¼š100 ç¬”
- ç›ˆåˆ©äº¤æ˜“ï¼š65 ç¬”
- äºæŸäº¤æ˜“ï¼š35 ç¬”
- **èƒœç‡**: 65%

### 2. æ–¹å‘åå¥½ï¼ˆBiasï¼‰

è¡¡é‡äº¤æ˜“è€…åå‘åšå¤šè¿˜æ˜¯åšç©ºï¼ŒèŒƒå›´ 0-100ï¼š

- **Bias = 50**: ä¸­æ€§ï¼Œå¤šç©ºå¹³è¡¡
- **Bias > 50**: åå¤šå¤´ï¼ˆLong Biasï¼‰
- **Bias < 50**: åç©ºå¤´ï¼ˆShort Biasï¼‰

```python
bias = ((long_trades - short_trades) / total_trades * 100 + 100) / 2
```

**ç¤ºä¾‹**ï¼š
- æ€»äº¤æ˜“ï¼š100 ç¬”
- å¤šå¤´äº¤æ˜“ï¼š70 ç¬”
- ç©ºå¤´äº¤æ˜“ï¼š30 ç¬”
- **æ–¹å‘åå¥½**: ((70-30)/100*100+100)/2 = 70ï¼ˆåå¤šï¼‰

### 3. äº¤æ˜“æ–¹å‘è¯†åˆ«

Hyperliquid äº¤æ˜“æ–¹å‘å­—æ®µï¼ˆ`dir`ï¼‰æ ¼å¼ï¼š

| æ–¹å‘å­—æ®µ | å«ä¹‰ | åˆ†ç±» |
|---------|------|------|
| `"Open Long"` | å¼€å¤šä»“ | å¤šå¤´ |
| `"Close Long"` | å¹³å¤šä»“ | å¤šå¤´ |
| `"Open Short"` | å¼€ç©ºä»“ | ç©ºå¤´ |
| `"Close Short"` | å¹³ç©ºä»“ | ç©ºå¤´ |
| `"Short > Long"` | ä»ç©ºç¿»å¤š | å¤šå¤´ |
| `"Long > Short"` | ä»å¤šç¿»ç©º | ç©ºå¤´ |

---

## è®¡ç®—å…¬å¼

### æ ¸å¿ƒå…¬å¼

#### 1. èƒœç‡è®¡ç®—

```python
win_rate = (winning_trades / total_pnl_trades) * 100

å…¶ä¸­ï¼š
- winning_trades: ç›ˆåˆ©äº¤æ˜“æ¬¡æ•°ï¼ˆclosedPnl > 0ï¼‰
- total_pnl_trades: æœ‰ç›ˆäºçš„äº¤æ˜“æ€»æ•°ï¼ˆæ’é™¤ closedPnl = 0ï¼‰
```

#### 2. æ–¹å‘åå¥½è®¡ç®—

```python
bias = ((long_trades - short_trades) / total_trades * 100 + 100) / 2

å…¶ä¸­ï¼š
- long_trades: å¤šå¤´äº¤æ˜“æ¬¡æ•°
- short_trades: ç©ºå¤´äº¤æ˜“æ¬¡æ•°
- total_trades: æ€»äº¤æ˜“æ¬¡æ•°
```

### å…¬å¼æ¨å¯¼

#### æ–¹å‘åå¥½æ¨å¯¼

```
å‡è®¾ï¼š
- æ€»äº¤æ˜“æ•° = 100
- å¤šå¤´äº¤æ˜“ = 70
- ç©ºå¤´äº¤æ˜“ = 30

è®¡ç®—æ­¥éª¤ï¼š
1. å¤šç©ºå·®å€¼ = 70 - 30 = 40
2. å·®å€¼å æ¯” = 40 / 100 = 0.4 = 40%
3. è½¬æ¢åˆ° 0-100 èŒƒå›´ = (40 + 100) / 2 = 70

ç»“æœï¼šbias = 70ï¼ˆåå¤š 20%ï¼‰
```

**è¾¹ç•Œæƒ…å†µ**ï¼š
- å…¨éƒ¨å¤šå¤´ï¼šbias = ((100-0)/100*100+100)/2 = 100
- å…¨éƒ¨ç©ºå¤´ï¼šbias = ((0-100)/100*100+100)/2 = 0
- å¤šç©ºå¹³è¡¡ï¼šbias = ((50-50)/100*100+100)/2 = 50

---

## ç®—æ³•å®ç°

### æ ¸å¿ƒå‡½æ•°ï¼š`calculate_win_rate()`

**ä»£ç ä½ç½®**: `apex_fork.py:285-356`

```python
from typing import List, Dict
from decimal import Decimal


def calculate_win_rate(fills: List[Dict]) -> Dict[str, float]:
    """
    è®¡ç®—èƒœç‡å’Œäº¤æ˜“ç»Ÿè®¡ä¿¡æ¯

    å‚æ•°ï¼š
        fills: æˆäº¤è®°å½•åˆ—è¡¨ï¼ŒåŒ…å« 'closedPnl' å’Œ 'dir' å­—æ®µ

    è¿”å›ï¼š
        å­—å…¸ï¼ŒåŒ…å«ï¼š
        - winRate: èƒœç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
        - bias: æ–¹å‘åå¥½ï¼ˆ0-100ï¼Œ50ä¸ºä¸­æ€§ï¼Œ>50åå¤šï¼Œ<50åç©ºï¼‰
        - totalTrades: æ€»äº¤æ˜“æ¬¡æ•°

    ç®—æ³•è¯´æ˜ï¼š
        1. ç»Ÿè®¡ç›ˆåˆ©å’ŒäºæŸäº¤æ˜“æ¬¡æ•°
        2. ç»Ÿè®¡å¤šå¤´å’Œç©ºå¤´äº¤æ˜“æ¬¡æ•°
        3. è®¡ç®—èƒœç‡ = ç›ˆåˆ©æ¬¡æ•° / æ€»æ¬¡æ•°
        4. è®¡ç®—æ–¹å‘åå¥½ = (å¤šå¤´-ç©ºå¤´) / æ€»æ•°
    """
    # è¾¹ç•Œæ¡ä»¶ï¼šæ— äº¤æ˜“æ•°æ®
    if not fills:
        return {"winRate": 0, "bias": 50, "totalTrades": 0}

    # åˆå§‹åŒ–è®¡æ•°å™¨
    long_trades = 0      # å¤šå¤´äº¤æ˜“æ¬¡æ•°
    short_trades = 0     # ç©ºå¤´äº¤æ˜“æ¬¡æ•°
    winning_trades = 0   # ç›ˆåˆ©äº¤æ˜“æ¬¡æ•°
    losing_trades = 0    # äºæŸäº¤æ˜“æ¬¡æ•°

    # éå†æ‰€æœ‰æˆäº¤è®°å½•
    for fill in fills:
        # å®‰å…¨è·å–å·²å®ç°ç›ˆäº
        closed_pnl_value = fill.get('closedPnl')
        if closed_pnl_value is None:
            continue

        closed_pnl = Decimal(str(closed_pnl_value))
        direction = fill.get('dir', '').strip()

        # æ ‡å‡†åŒ–æ–¹å‘åˆ¤æ–­ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
        direction_lower = direction.lower()

        # ==================== ç»Ÿè®¡äº¤æ˜“æ–¹å‘ ====================

        # åˆ¤æ–­å¤šå¤´äº¤æ˜“
        if any(term in direction_lower for term in ['open long', 'close long']):
            # æ’é™¤ "Short > Long" è¿™ç§åŒ…å« long ä½†å®é™…æ˜¯ä»ç©ºç¿»å¤šçš„æƒ…å†µ
            if 'short' not in direction_lower or direction_lower.endswith('long'):
                long_trades += 1
        # ç‰¹æ®Šå¤„ç†ï¼šä»ç©ºç¿»å¤š
        elif 'short > long' in direction_lower or 'short>long' in direction_lower:
            long_trades += 1

        # åˆ¤æ–­ç©ºå¤´äº¤æ˜“
        elif any(term in direction_lower for term in ['open short', 'close short']):
            # æ’é™¤ "Long > Short" è¿™ç§åŒ…å« short ä½†å®é™…æ˜¯ä»å¤šç¿»ç©ºçš„æƒ…å†µ
            if 'long' not in direction_lower or direction_lower.endswith('short'):
                short_trades += 1
        # ç‰¹æ®Šå¤„ç†ï¼šä»å¤šç¿»ç©º
        elif 'long > short' in direction_lower or 'long>short' in direction_lower:
            short_trades += 1

        # ==================== ç»Ÿè®¡ç›ˆäºæ¬¡æ•° ====================

        # æ’é™¤é›¶ç›ˆäºäº¤æ˜“ï¼ˆå¯èƒ½æ˜¯ä»“ä½è°ƒæ•´ï¼Œä¸ç®—çœŸæ­£çš„å¹³ä»“ï¼‰
        if closed_pnl != 0:
            if closed_pnl > 0:
                winning_trades += 1
            else:
                losing_trades += 1

    # ==================== è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡ ====================

    total_trades = len(fills)
    total_pnl_trades = winning_trades + losing_trades

    # è®¡ç®—èƒœç‡
    win_rate = (winning_trades / total_pnl_trades * 100) if total_pnl_trades > 0 else 0

    # è®¡ç®—æ–¹å‘åå¥½
    bias = ((long_trades - short_trades) / total_trades * 100 + 100) / 2 if total_trades > 0 else 50

    return {
        "winRate": win_rate,
        "bias": bias,
        "totalTrades": total_trades
    }
```

### æ–¹å‘è¯†åˆ«è¯¦ç»†å®ç°

```python
def identify_trade_direction(direction: str) -> str:
    """
    è¯†åˆ«äº¤æ˜“æ–¹å‘

    å‚æ•°ï¼š
        direction: äº¤æ˜“æ–¹å‘å­—ç¬¦ä¸²ï¼ˆå¦‚ "Open Long", "Close Short"ï¼‰

    è¿”å›ï¼š
        "long", "short", æˆ– "unknown"
    """
    direction_lower = direction.lower().strip()

    # å¤šå¤´äº¤æ˜“åˆ¤æ–­
    if any(term in direction_lower for term in ['open long', 'close long']):
        if 'short' not in direction_lower or direction_lower.endswith('long'):
            return "long"

    # ä»ç©ºç¿»å¤š
    if 'short > long' in direction_lower or 'short>long' in direction_lower:
        return "long"

    # ç©ºå¤´äº¤æ˜“åˆ¤æ–­
    if any(term in direction_lower for term in ['open short', 'close short']):
        if 'long' not in direction_lower or direction_lower.endswith('short'):
            return "short"

    # ä»å¤šç¿»ç©º
    if 'long > short' in direction_lower or 'long>short' in direction_lower:
        return "short"

    return "unknown"
```

### ç®—æ³•æµç¨‹å›¾

```
å¼€å§‹
  â†“
æ£€æŸ¥æ•°æ®æ˜¯å¦ä¸ºç©ºï¼Ÿ
  â†“ æ˜¯
è¿”å›é»˜è®¤å€¼ {winRate: 0, bias: 50, totalTrades: 0}
  â†“ å¦
åˆå§‹åŒ–è®¡æ•°å™¨
  â†“
éå†æˆäº¤è®°å½•ï¼ˆfillsï¼‰
  â†“
å¯¹æ¯æ¡è®°å½•ï¼š
  â”œâ”€ è·å– closedPnl
  â”‚  â”œâ”€ > 0 â†’ winning_trades++
  â”‚  â”œâ”€ < 0 â†’ losing_trades++
  â”‚  â””â”€ = 0 â†’ è·³è¿‡ï¼ˆä¸è®¡å…¥èƒœç‡ï¼‰
  â”‚
  â””â”€ è·å– direction
     â”œâ”€ åŒ…å« "Open Long" æˆ– "Close Long" â†’ long_trades++
     â”œâ”€ åŒ…å« "Open Short" æˆ– "Close Short" â†’ short_trades++
     â”œâ”€ åŒ…å« "Short > Long" â†’ long_trades++
     â””â”€ åŒ…å« "Long > Short" â†’ short_trades++
  â†“
è®¡ç®—èƒœç‡ = winning_trades / (winning_trades + losing_trades) * 100
  â†“
è®¡ç®—æ–¹å‘åå¥½ = ((long_trades - short_trades) / total_trades * 100 + 100) / 2
  â†“
è¿”å›ç»“æœ
  â†“
ç»“æŸ
```

---

## åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šç­–ç•¥è¯„ä¼°

```python
# è®¡ç®—èƒœç‡
win_stats = calculate_win_rate(fills)

print(f"èƒœç‡: {win_stats['winRate']:.2f}%")
print(f"æ–¹å‘åå¥½: {win_stats['bias']:.2f}")
print(f"æ€»äº¤æ˜“æ¬¡æ•°: {win_stats['totalTrades']}")

# è¯„ä¼°ç­–ç•¥
if win_stats['winRate'] > 60:
    print("âœ… é«˜èƒœç‡ç­–ç•¥")
elif win_stats['winRate'] > 50:
    print("âœ… æ­£èƒœç‡ç­–ç•¥")
else:
    print("âš ï¸ ä½èƒœç‡ç­–ç•¥ï¼Œéœ€æé«˜ç›ˆäºæ¯”")

# è¯„ä¼°æ–¹å‘åå¥½
if win_stats['bias'] > 60:
    print("ğŸ“ˆ åå¤šå¤´ç­–ç•¥")
elif win_stats['bias'] < 40:
    print("ğŸ“‰ åç©ºå¤´ç­–ç•¥")
else:
    print("âš–ï¸ å¤šç©ºå¹³è¡¡ç­–ç•¥")
```

### åœºæ™¯ 2ï¼šç­–ç•¥ä¼˜åŒ–å»ºè®®

```python
def get_strategy_advice(win_rate: float, profit_factor: float, bias: float) -> str:
    """æ ¹æ®èƒœç‡ã€ç›ˆäºå› å­å’Œæ–¹å‘åå¥½ç»™å‡ºå»ºè®®"""

    if win_rate > 50 and profit_factor > 1.5:
        return "ğŸ† ç­–ç•¥è¡¨ç°ä¼˜ç§€ï¼Œç»§ç»­ä¿æŒ"

    elif win_rate > 50 and profit_factor < 1.2:
        return "âš ï¸ é«˜èƒœç‡ä½†ç›ˆäºæ¯”ä¸è¶³ï¼Œéœ€è¦æé«˜å•ç¬”ç›ˆåˆ©"

    elif win_rate < 50 and profit_factor > 2.0:
        return "âœ… ä½èƒœç‡é«˜ç›ˆäºæ¯”ç­–ç•¥ï¼Œé£æ ¼åˆç†"

    elif win_rate < 50 and profit_factor < 1.5:
        return "âŒ ä½èƒœç‡ä½ç›ˆäºæ¯”ï¼Œéœ€è¦å…¨é¢ä¼˜åŒ–"

    # æ–¹å‘åå¥½å»ºè®®
    if abs(bias - 50) > 30:
        return "âš ï¸ æ–¹å‘åå¥½è¿‡äºæç«¯ï¼Œå»ºè®®å¢åŠ å¤šæ ·æ€§"

    return "ç»§ç»­è§‚å¯Ÿå’Œä¼˜åŒ–"


# ä½¿ç”¨ç¤ºä¾‹
advice = get_strategy_advice(
    win_rate=55,
    profit_factor=1.8,
    bias=65
)
print(advice)
```

### åœºæ™¯ 3ï¼šå¸‚åœºè¶‹åŠ¿åˆ†æ

```python
def analyze_market_trend(win_stats: Dict, time_period: str) -> str:
    """åˆ†æå¸‚åœºè¶‹åŠ¿"""
    bias = win_stats['bias']

    if bias > 70:
        return f"{time_period}: å¼ºçƒˆçœ‹å¤šæƒ…ç»ª ğŸš€"
    elif bias > 55:
        return f"{time_period}: åå¤šå¤´å¸‚åœº ğŸ“ˆ"
    elif bias < 30:
        return f"{time_period}: å¼ºçƒˆçœ‹ç©ºæƒ…ç»ª ğŸ“‰"
    elif bias < 45:
        return f"{time_period}: åç©ºå¤´å¸‚åœº ğŸ“‰"
    else:
        return f"{time_period}: å¸‚åœºå¹³è¡¡ âš–ï¸"


# åˆ†æä¸åŒæ—¶æœŸçš„è¶‹åŠ¿
recent_fills = [f for f in fills if f['time'] > recent_timestamp]
win_stats_recent = calculate_win_rate(recent_fills)
print(analyze_market_trend(win_stats_recent, "æœ€è¿‘7å¤©"))
```

---

## å®Œæ•´ä»£ç ç¤ºä¾‹

### ä¸»ç¨‹åºç¤ºä¾‹

```python
from typing import List, Dict
from decimal import Decimal
from datetime import datetime


class WinRateCalculator:
    """èƒœç‡ç»Ÿè®¡è®¡ç®—å™¨"""

    def calculate_win_rate(self, fills: List[Dict]) -> Dict[str, float]:
        """è®¡ç®—èƒœç‡å’Œäº¤æ˜“ç»Ÿè®¡"""
        if not fills:
            return {"winRate": 0, "bias": 50, "totalTrades": 0}

        long_trades = 0
        short_trades = 0
        winning_trades = 0
        losing_trades = 0

        print("\nğŸ“Š äº¤æ˜“è¯¦ç»†åˆ†æ:")
        print("=" * 80)
        print(f"{'åºå·':<6} {'æ–¹å‘':<15} {'ç›ˆäº':<12} {'é‡‘é¢':<15} {'åˆ†ç±»'}")
        print("=" * 80)

        for i, fill in enumerate(fills, 1):
            closed_pnl_value = fill.get('closedPnl')
            if closed_pnl_value is None:
                continue

            closed_pnl = Decimal(str(closed_pnl_value))
            direction = fill.get('dir', '').strip()
            direction_lower = direction.lower()

            # è¯†åˆ«äº¤æ˜“æ–¹å‘
            trade_type = "Unknown"
            if any(term in direction_lower for term in ['open long', 'close long']):
                if 'short' not in direction_lower or direction_lower.endswith('long'):
                    long_trades += 1
                    trade_type = "Long"
            elif 'short > long' in direction_lower or 'short>long' in direction_lower:
                long_trades += 1
                trade_type = "Long"
            elif any(term in direction_lower for term in ['open short', 'close short']):
                if 'long' not in direction_lower or direction_lower.endswith('short'):
                    short_trades += 1
                    trade_type = "Short"
            elif 'long > short' in direction_lower or 'long>short' in direction_lower:
                short_trades += 1
                trade_type = "Short"

            # ç»Ÿè®¡ç›ˆäº
            pnl_status = "Zero"
            result_emoji = "âšª"
            if closed_pnl != 0:
                if closed_pnl > 0:
                    winning_trades += 1
                    pnl_status = "Win"
                    result_emoji = "âœ…"
                else:
                    losing_trades += 1
                    pnl_status = "Loss"
                    result_emoji = "âŒ"

            # æ‰“å°è¯¦æƒ…
            pnl_str = f"${float(closed_pnl):,.2f}"
            print(f"{i:<6} {direction:<15} {pnl_status:<12} {pnl_str:<15} {result_emoji} {trade_type}")

        print("=" * 80)

        # è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
        total_trades = len(fills)
        total_pnl_trades = winning_trades + losing_trades
        win_rate = (winning_trades / total_pnl_trades * 100) if total_pnl_trades > 0 else 0
        bias = ((long_trades - short_trades) / total_trades * 100 + 100) / 2 if total_trades > 0 else 50

        # æ‰“å°ç»Ÿè®¡ç»“æœ
        print("\nğŸ“ˆ ç»Ÿè®¡æ‘˜è¦:")
        print("=" * 80)
        print(f"æ€»äº¤æ˜“æ¬¡æ•°: {total_trades}")
        print(f"æœ‰æ•ˆäº¤æ˜“æ¬¡æ•°: {total_pnl_trades} (æ’é™¤é›¶ç›ˆäº)")
        print(f"ç›ˆåˆ©äº¤æ˜“: {winning_trades} ç¬”")
        print(f"äºæŸäº¤æ˜“: {losing_trades} ç¬”")
        print(f"å¤šå¤´äº¤æ˜“: {long_trades} ç¬”")
        print(f"ç©ºå¤´äº¤æ˜“: {short_trades} ç¬”")
        print("=" * 80)
        print(f"èƒœç‡: {win_rate:.2f}%")
        print(f"æ–¹å‘åå¥½: {bias:.2f} ", end="")

        if bias > 60:
            print("(åå¤š ğŸ“ˆ)")
        elif bias < 40:
            print("(åç©º ğŸ“‰)")
        else:
            print("(å¹³è¡¡ âš–ï¸)")

        return {
            "winRate": win_rate,
            "bias": bias,
            "totalTrades": total_trades,
            "winningTrades": winning_trades,
            "losingTrades": losing_trades,
            "longTrades": long_trades,
            "shortTrades": short_trades
        }

    def get_detailed_breakdown(self, fills: List[Dict]) -> Dict:
        """è·å–è¯¦ç»†åˆ†ç±»ç»Ÿè®¡"""
        long_wins = 0
        long_losses = 0
        short_wins = 0
        short_losses = 0

        for fill in fills:
            closed_pnl = float(fill.get('closedPnl', 0))
            direction = fill.get('dir', '').lower()

            is_long = any(term in direction for term in ['open long', 'close long', 'short > long', 'short>long'])
            is_short = any(term in direction for term in ['open short', 'close short', 'long > short', 'long>short'])

            if closed_pnl > 0:
                if is_long:
                    long_wins += 1
                elif is_short:
                    short_wins += 1
            elif closed_pnl < 0:
                if is_long:
                    long_losses += 1
                elif is_short:
                    short_losses += 1

        long_total = long_wins + long_losses
        short_total = short_wins + short_losses

        return {
            "long": {
                "wins": long_wins,
                "losses": long_losses,
                "total": long_total,
                "win_rate": (long_wins / long_total * 100) if long_total > 0 else 0
            },
            "short": {
                "wins": short_wins,
                "losses": short_losses,
                "total": short_total,
                "win_rate": (short_wins / short_total * 100) if short_total > 0 else 0
            }
        }


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    calculator = WinRateCalculator()

    # æ¨¡æ‹Ÿäº¤æ˜“æ•°æ®
    fills = [
        {"dir": "Open Long", "closedPnl": "0"},      # å¼€ä»“ï¼Œä¸è®¡å…¥èƒœç‡
        {"dir": "Close Long", "closedPnl": "500"},   # å¤šå¤´ç›ˆåˆ©
        {"dir": "Open Short", "closedPnl": "0"},     # å¼€ä»“ï¼Œä¸è®¡å…¥èƒœç‡
        {"dir": "Close Short", "closedPnl": "-200"}, # ç©ºå¤´äºæŸ
        {"dir": "Open Long", "closedPnl": "0"},      # å¼€ä»“ï¼Œä¸è®¡å…¥èƒœç‡
        {"dir": "Close Long", "closedPnl": "300"},   # å¤šå¤´ç›ˆåˆ©
        {"dir": "Open Short", "closedPnl": "0"},     # å¼€ä»“ï¼Œä¸è®¡å…¥èƒœç‡
        {"dir": "Close Short", "closedPnl": "150"},  # ç©ºå¤´ç›ˆåˆ©
        {"dir": "Short > Long", "closedPnl": "-100"},# ç¿»ä»“ï¼Œå¤šå¤´äºæŸ
        {"dir": "Close Long", "closedPnl": "250"},   # å¤šå¤´ç›ˆåˆ©
    ]

    # è®¡ç®—èƒœç‡
    win_stats = calculator.calculate_win_rate(fills)

    # è·å–è¯¦ç»†åˆ†ç±»
    print("\n" + "=" * 80)
    print("åˆ†æ–¹å‘ç»Ÿè®¡:")
    print("=" * 80)

    breakdown = calculator.get_detailed_breakdown(fills)

    print(f"\nå¤šå¤´äº¤æ˜“:")
    print(f"  ç›ˆåˆ©: {breakdown['long']['wins']} ç¬”")
    print(f"  äºæŸ: {breakdown['long']['losses']} ç¬”")
    print(f"  èƒœç‡: {breakdown['long']['win_rate']:.2f}%")

    print(f"\nç©ºå¤´äº¤æ˜“:")
    print(f"  ç›ˆåˆ©: {breakdown['short']['wins']} ç¬”")
    print(f"  äºæŸ: {breakdown['short']['losses']} ç¬”")
    print(f"  èƒœç‡: {breakdown['short']['win_rate']:.2f}%")
```

### è¿è¡Œç»“æœç¤ºä¾‹

```
ğŸ“Š äº¤æ˜“è¯¦ç»†åˆ†æ:
================================================================================
åºå·   æ–¹å‘            ç›ˆäº         é‡‘é¢            åˆ†ç±»
================================================================================
1      Open Long       Zero         $0.00           âšª Long
2      Close Long      Win          $500.00         âœ… Long
3      Open Short      Zero         $0.00           âšª Short
4      Close Short     Loss         $-200.00        âŒ Short
5      Open Long       Zero         $0.00           âšª Long
6      Close Long      Win          $300.00         âœ… Long
7      Open Short      Zero         $0.00           âšª Short
8      Close Short     Win          $150.00         âœ… Short
9      Short > Long    Loss         $-100.00        âŒ Long
10     Close Long      Win          $250.00         âœ… Long
================================================================================

ğŸ“ˆ ç»Ÿè®¡æ‘˜è¦:
================================================================================
æ€»äº¤æ˜“æ¬¡æ•°: 10
æœ‰æ•ˆäº¤æ˜“æ¬¡æ•°: 5 (æ’é™¤é›¶ç›ˆäº)
ç›ˆåˆ©äº¤æ˜“: 4 ç¬”
äºæŸäº¤æ˜“: 2 ç¬”
å¤šå¤´äº¤æ˜“: 6 ç¬”
ç©ºå¤´äº¤æ˜“: 4 ç¬”
================================================================================
èƒœç‡: 66.67%
æ–¹å‘åå¥½: 60.00 (åå¤š ğŸ“ˆ)

================================================================================
åˆ†æ–¹å‘ç»Ÿè®¡:
================================================================================

å¤šå¤´äº¤æ˜“:
  ç›ˆåˆ©: 3 ç¬”
  äºæŸ: 1 ç¬”
  èƒœç‡: 75.00%

ç©ºå¤´äº¤æ˜“:
  ç›ˆåˆ©: 1 ç¬”
  äºæŸ: 1 ç¬”
  èƒœç‡: 50.00%
```

---

## æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•ç”¨ä¾‹ 1ï¼šé«˜èƒœç‡

```python
def test_high_win_rate():
    """æµ‹è¯•ç”¨ä¾‹ 1: é«˜èƒœç‡åœºæ™¯"""
    calculator = WinRateCalculator()

    fills = [
        {"dir": "Close Long", "closedPnl": "100"},
        {"dir": "Close Long", "closedPnl": "200"},
        {"dir": "Close Short", "closedPnl": "150"},
        {"dir": "Close Long", "closedPnl": "300"},
        {"dir": "Close Short", "closedPnl": "-50"},  # å”¯ä¸€äºæŸ
    ]

    result = calculator.calculate_win_rate(fills)

    # é¢„æœŸï¼š4ç›ˆ1äºï¼Œèƒœç‡ = 80%
    assert abs(result['winRate'] - 80.0) < 0.01
    print(f"âœ… æµ‹è¯•ç”¨ä¾‹ 1 é€šè¿‡ï¼šèƒœç‡ = {result['winRate']:.2f}%")
```

### æµ‹è¯•ç”¨ä¾‹ 2ï¼šæ–¹å‘åå¥½

```python
def test_direction_bias():
    """æµ‹è¯•ç”¨ä¾‹ 2: æ–¹å‘åå¥½æµ‹è¯•"""
    calculator = WinRateCalculator()

    # å…¨éƒ¨å¤šå¤´
    fills_long = [
        {"dir": "Open Long", "closedPnl": "0"},
        {"dir": "Close Long", "closedPnl": "100"},
        {"dir": "Open Long", "closedPnl": "0"},
        {"dir": "Close Long", "closedPnl": "200"},
    ]

    result_long = calculator.calculate_win_rate(fills_long)
    assert result_long['bias'] > 90  # åº”è¯¥æ¥è¿‘ 100
    print(f"âœ… å¤šå¤´åå¥½æµ‹è¯•é€šè¿‡ï¼šbias = {result_long['bias']:.2f}")

    # å…¨éƒ¨ç©ºå¤´
    fills_short = [
        {"dir": "Open Short", "closedPnl": "0"},
        {"dir": "Close Short", "closedPnl": "100"},
        {"dir": "Open Short", "closedPnl": "0"},
        {"dir": "Close Short", "closedPnl": "200"},
    ]

    result_short = calculator.calculate_win_rate(fills_short)
    assert result_short['bias'] < 10  # åº”è¯¥æ¥è¿‘ 0
    print(f"âœ… ç©ºå¤´åå¥½æµ‹è¯•é€šè¿‡ï¼šbias = {result_short['bias']:.2f}")
```

### æµ‹è¯•ç”¨ä¾‹ 3ï¼šç¿»ä»“äº¤æ˜“

```python
def test_flip_trades():
    """æµ‹è¯•ç”¨ä¾‹ 3: ç¿»ä»“äº¤æ˜“è¯†åˆ«"""
    calculator = WinRateCalculator()

    fills = [
        {"dir": "Short > Long", "closedPnl": "100"},   # åº”è¯†åˆ«ä¸ºå¤šå¤´
        {"dir": "Long > Short", "closedPnl": "200"},   # åº”è¯†åˆ«ä¸ºç©ºå¤´
        {"dir": "short>long", "closedPnl": "150"},     # æ— ç©ºæ ¼æ ¼å¼
        {"dir": "long>short", "closedPnl": "-50"},     # æ— ç©ºæ ¼æ ¼å¼
    ]

    result = calculator.calculate_win_rate(fills)

    # åº”è¯¥æœ‰2ä¸ªå¤šå¤´å’Œ2ä¸ªç©ºå¤´
    assert result['longTrades'] == 2
    assert result['shortTrades'] == 2
    assert abs(result['bias'] - 50.0) < 0.01  # åº”è¯¥å¹³è¡¡
    print("âœ… æµ‹è¯•ç”¨ä¾‹ 3 é€šè¿‡ï¼šç¿»ä»“è¯†åˆ«æ­£ç¡®")
```

### æµ‹è¯•ç”¨ä¾‹ 4ï¼šé›¶ç›ˆäºè¿‡æ»¤

```python
def test_zero_pnl_filtering():
    """æµ‹è¯•ç”¨ä¾‹ 4: é›¶ç›ˆäºäº¤æ˜“ä¸è®¡å…¥èƒœç‡"""
    calculator = WinRateCalculator()

    fills = [
        {"dir": "Open Long", "closedPnl": "0"},     # ä¸è®¡å…¥
        {"dir": "Close Long", "closedPnl": "100"},  # ç›ˆåˆ©
        {"dir": "Open Short", "closedPnl": "0"},    # ä¸è®¡å…¥
        {"dir": "Close Short", "closedPnl": "0"},   # ä¸è®¡å…¥ï¼ˆä»“ä½è°ƒæ•´ï¼‰
        {"dir": "Close Long", "closedPnl": "-50"},  # äºæŸ
    ]

    result = calculator.calculate_win_rate(fills)

    # æœ‰æ•ˆäº¤æ˜“åªæœ‰2ç¬”ï¼ˆ1ç›ˆ1äºï¼‰ï¼Œèƒœç‡ 50%
    assert abs(result['winRate'] - 50.0) < 0.01
    assert result['totalTrades'] == 5  # ä½†æ€»äº¤æ˜“æ•°æ˜¯5
    print(f"âœ… æµ‹è¯•ç”¨ä¾‹ 4 é€šè¿‡ï¼šé›¶ç›ˆäºè¿‡æ»¤æ­£ç¡®")
```

### æµ‹è¯•ç”¨ä¾‹ 5ï¼šæ— æ•°æ®

```python
def test_empty_data():
    """æµ‹è¯•ç”¨ä¾‹ 5: æ— äº¤æ˜“æ•°æ®"""
    calculator = WinRateCalculator()

    fills = []
    result = calculator.calculate_win_rate(fills)

    assert result['winRate'] == 0
    assert result['bias'] == 50
    assert result['totalTrades'] == 0
    print("âœ… æµ‹è¯•ç”¨ä¾‹ 5 é€šè¿‡ï¼šç©ºæ•°æ®å¤„ç†æ­£ç¡®")
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```python
if __name__ == "__main__":
    print("å¼€å§‹è¿è¡Œèƒœç‡ç»Ÿè®¡æµ‹è¯•ç”¨ä¾‹...\n")

    test_high_win_rate()
    test_direction_bias()
    test_flip_trades()
    test_zero_pnl_filtering()
    test_empty_data()

    print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡ï¼")
```

---

## ç®—æ³•ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| âœ… **æ–¹å‘è¯†åˆ«å‡†ç¡®** | æ­£ç¡®å¤„ç†æ‰€æœ‰æ–¹å‘ç±»å‹ï¼ŒåŒ…æ‹¬ç¿»ä»“ |
| âœ… **é›¶ç›ˆäºè¿‡æ»¤** | åˆç†æ’é™¤å¼€ä»“å’Œä»“ä½è°ƒæ•´äº¤æ˜“ |
| âœ… **æ–¹å‘åå¥½åˆ†æ** | æä¾›å¤šç©ºå€¾å‘æ€§åˆ†æ |
| âœ… **å¤§å°å†™å…¼å®¹** | ä¸åŒºåˆ†å¤§å°å†™çš„æ–¹å‘åˆ¤æ–­ |
| âœ… **å®Œæ•´ç»Ÿè®¡** | æä¾›æ€»äº¤æ˜“æ•°ã€æœ‰æ•ˆäº¤æ˜“æ•°ç­‰è¯¦ç»†ä¿¡æ¯ |

---

## å‚è€ƒèµ„æ–™

- **Hyperliquid API æ–‡æ¡£**: https://hyperliquid.gitbook.io/hyperliquid-docs/for-developers/api
- **Apex Liquid Bot**: https://apexliquid.bot/
- **æºä»£ç **: apex_fork.py (è¡Œ 285-356)

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-02-03
**ä½œè€…**: Apex Calculator Team
