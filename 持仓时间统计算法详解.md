# æŒä»“æ—¶é—´ç»Ÿè®¡ç®—æ³•è¯¦è§£

## ğŸ“‹ ç›®å½•

1. [ç®—æ³•æ¦‚è¿°](#ç®—æ³•æ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
3. [è®¡ç®—å…¬å¼](#è®¡ç®—å…¬å¼)
4. [ç®—æ³•å®ç°](#ç®—æ³•å®ç°)
5. [åº”ç”¨åœºæ™¯](#åº”ç”¨åœºæ™¯)
6. [å®Œæ•´ä»£ç ç¤ºä¾‹](#å®Œæ•´ä»£ç ç¤ºä¾‹)
7. [æµ‹è¯•ç”¨ä¾‹](#æµ‹è¯•ç”¨ä¾‹)

---

## ç®—æ³•æ¦‚è¿°

### ä»€ä¹ˆæ˜¯æŒä»“æ—¶é—´ç»Ÿè®¡ï¼Ÿ

**æŒä»“æ—¶é—´ç»Ÿè®¡**æ˜¯è®¡ç®—äº¤æ˜“è€…ä»**å¼€ä»“åˆ°å¹³ä»“**çš„å¹³å‡æŒä»“æ—¶é•¿ï¼Œåæ˜ äº¤æ˜“é£æ ¼å’Œç­–ç•¥ç‰¹ç‚¹ã€‚

### æŒ‡æ ‡æ„ä¹‰

| å¹³å‡æŒä»“æ—¶é—´ | äº¤æ˜“é£æ ¼ | ç‰¹ç‚¹ |
|-------------|---------|------|
| < 1 å°æ—¶ | è¶…çŸ­çº¿ / é«˜é¢‘ | å¿«è¿›å¿«å‡ºï¼Œé¢‘ç¹äº¤æ˜“ |
| 1-24 å°æ—¶ | æ—¥å†…äº¤æ˜“ | å½“æ—¥å¹³ä»“ï¼Œä¸è¿‡å¤œ |
| 1-7 å¤© | çŸ­çº¿äº¤æ˜“ | æ•æ‰çŸ­æœŸè¶‹åŠ¿ |
| 7-30 å¤© | ä¸­çº¿äº¤æ˜“ | æŠŠæ¡ä¸­æœŸæ³¢åŠ¨ |
| > 30 å¤© | é•¿çº¿äº¤æ˜“ | é•¿æœŸæŒæœ‰ï¼Œä»·å€¼æŠ•èµ„ |

### ä¸ºä»€ä¹ˆéœ€è¦æŒä»“æ—¶é—´ç»Ÿè®¡ï¼Ÿ

- **äº†è§£äº¤æ˜“é£æ ¼**ï¼šæ˜ç¡®è‡ªå·±çš„äº¤æ˜“åå¥½
- **ä¼˜åŒ–ç­–ç•¥**ï¼šæ ¹æ®æŒä»“æ—¶é—´è°ƒæ•´ç­–ç•¥å‚æ•°
- **é£é™©ç®¡ç†**ï¼šé•¿çŸ­çº¿é£é™©ç‰¹å¾ä¸åŒ
- **èµ„é‡‘æ•ˆç‡**ï¼šè¯„ä¼°èµ„é‡‘å‘¨è½¬ç‡

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. äº¤æ˜“æ–¹å‘è¯†åˆ«

Hyperliquid äº¤æ˜“æ–¹å‘åˆ†ä¸ºï¼š
- **å¤šå¤´ï¼ˆLongï¼‰**ï¼šçœ‹æ¶¨ï¼Œä¹°å…¥å¼€ä»“
- **ç©ºå¤´ï¼ˆShortï¼‰**ï¼šçœ‹è·Œï¼Œå–å‡ºå¼€ä»“

### 2. å¼€ä»“ä¸å¹³ä»“

| æ“ä½œç±»å‹ | å¤šå¤´ | ç©ºå¤´ |
|---------|------|------|
| **å¼€ä»“** | Open Long | Open Short |
| **å¹³ä»“** | Close Long | Close Short |
| **ç¿»ä»“** | Short > Long | Long > Short |

### 3. éƒ¨åˆ†å¹³ä»“

æ”¯æŒéƒ¨åˆ†å¹³ä»“ï¼Œéœ€è¦æŒ‰æ¯”ä¾‹åŒ¹é…å¼€ä»“è®°å½•ï¼š

**ç¤ºä¾‹**ï¼š
```
å¼€å¤š BTC 10 ä¸ª @ $40,000
å¹³å¤š BTC 6 ä¸ª @ $42,000  â†’ éƒ¨åˆ†å¹³ä»“ 6 ä¸ª
å¹³å¤š BTC 4 ä¸ª @ $43,000  â†’ å‰©ä½™ 4 ä¸ªå…¨éƒ¨å¹³ä»“
```

### 4. FIFO åŸåˆ™

**å…ˆè¿›å…ˆå‡º**ï¼ˆFirst In First Outï¼‰ï¼š
- å¹³ä»“æ—¶ä¼˜å…ˆåŒ¹é…æœ€æ—©çš„å¼€ä»“è®°å½•
- ç¡®ä¿æŒä»“æ—¶é—´è®¡ç®—å‡†ç¡®

---

## è®¡ç®—å…¬å¼

### æ ¸å¿ƒå…¬å¼

#### 1. å•ç¬”æŒä»“æ—¶é—´

```python
hold_time_seconds = close_time - open_time
hold_time_days = hold_time_seconds / 86400
```

#### 2. å¹³å‡æŒä»“æ—¶é—´

```python
average_hold_time = Î£(hold_time_i) / n

å…¶ä¸­ n ä¸ºå·²å¹³ä»“çš„äº¤æ˜“æ•°é‡
```

#### 3. æ—¶é—´æ®µç»Ÿè®¡

```python
ä»Šæ—¥å¹³å‡ = Î£(ä»Šæ—¥å¹³ä»“çš„æŒä»“æ—¶é—´) / ä»Šæ—¥å¹³ä»“æ•°é‡
æœ€è¿‘7å¤©å¹³å‡ = Î£(æœ€è¿‘7å¤©å¹³ä»“çš„æŒä»“æ—¶é—´) / æœ€è¿‘7å¤©å¹³ä»“æ•°é‡
æœ€è¿‘30å¤©å¹³å‡ = Î£(æœ€è¿‘30å¤©å¹³ä»“çš„æŒä»“æ—¶é—´) / æœ€è¿‘30å¤©å¹³ä»“æ•°é‡
å…¨éƒ¨æ—¶é—´å¹³å‡ = Î£(æ‰€æœ‰å¹³ä»“çš„æŒä»“æ—¶é—´) / æ‰€æœ‰å¹³ä»“æ•°é‡
```

---

## ç®—æ³•å®ç°

### æ”¹è¿›ç‰ˆç®—æ³•ç‰¹ç‚¹

**ä»£ç ä½ç½®**: `apex_fork.py:430-585`

**å…³é”®æ”¹è¿›**ï¼š
1. âœ… åŒºåˆ†å¤šå¤´å’Œç©ºå¤´ä»“ä½ï¼Œåˆ†åˆ«é…å¯¹
2. âœ… æ”¯æŒéƒ¨åˆ†å¹³ä»“çš„åŠ æƒè®¡ç®—
3. âœ… ä½¿ç”¨ FIFO åŸåˆ™è¿›è¡Œé…å¯¹
4. âœ… æ­£ç¡®å¤„ç†ç¿»ä»“äº¤æ˜“ï¼ˆLong > Short, Short > Longï¼‰

### æ ¸å¿ƒå‡½æ•°ï¼š`calculate_hold_time_stats()`

```python
from typing import List, Dict
from datetime import datetime, timedelta
from collections import defaultdict


def calculate_hold_time_stats(fills: List[Dict]) -> Dict[str, float]:
    """
    è®¡ç®—å¹³å‡æŒä»“æ—¶é—´ç»Ÿè®¡ï¼ˆæ”¹è¿›ç‰ˆï¼šåŒºåˆ†å¤šç©ºæ–¹å‘ï¼Œæ”¯æŒéƒ¨åˆ†å¹³ä»“ï¼‰

    å‚æ•°ï¼š
        fills: æˆäº¤è®°å½•åˆ—è¡¨ï¼ŒåŒ…å«'time'ã€'dir'ã€'coin'å’Œ'sz'å­—æ®µ

    è¿”å›ï¼š
        å­—å…¸ï¼ŒåŒ…å«ä¸åŒæ—¶é—´æ®µçš„å¹³å‡æŒä»“æ—¶é—´ï¼ˆå¤©æ•°ï¼‰ï¼š
        - todayCount: ä»Šæ—¥å¹³å‡æŒä»“æ—¶é—´
        - last7DaysAverage: æœ€è¿‘7å¤©å¹³å‡æŒä»“æ—¶é—´
        - last30DaysAverage: æœ€è¿‘30å¤©å¹³å‡æŒä»“æ—¶é—´
        - allTimeAverage: å…¨éƒ¨æ—¶é—´å¹³å‡æŒä»“æ—¶é—´

    ç®—æ³•æ”¹è¿›ï¼š
        1. åŒºåˆ†å¤šå¤´(Long)å’Œç©ºå¤´(Short)ä»“ä½ï¼Œåˆ†åˆ«é…å¯¹
        2. æ”¯æŒéƒ¨åˆ†å¹³ä»“çš„åŠ æƒè®¡ç®—
        3. ä½¿ç”¨FIFOåŸåˆ™è¿›è¡Œé…å¯¹
        4. æ­£ç¡®å¤„ç†ç¿»ä»“äº¤æ˜“(Long > Short, Short > Long)

    ç®—æ³•è¯´æ˜ï¼š
        1. ä¸ºæ¯ä¸ªå¸ç§ç»´æŠ¤ç‹¬ç«‹çš„å¤šå¤´å’Œç©ºå¤´å¼€ä»“é˜Ÿåˆ—
        2. å¹³ä»“æ—¶ä»å¯¹åº”æ–¹å‘çš„é˜Ÿåˆ—ä¸­æŒ‰FIFOåŸåˆ™åŒ¹é…
        3. æ”¯æŒéƒ¨åˆ†å¹³ä»“ï¼šæŒ‰æ•°é‡æ¯”ä¾‹åŒ¹é…å¼€ä»“è®°å½•
        4. è®¡ç®—æ¯å¯¹äº¤æ˜“çš„æŒä»“æ—¶é•¿å¹¶æŒ‰æ—¶é—´æ®µç»Ÿè®¡
    """
    # è¾¹ç•Œæ¡ä»¶æ£€æŸ¥
    if not fills:
        return {
            "todayCount": 0,
            "last7DaysAverage": 0,
            "last30DaysAverage": 0,
            "allTimeAverage": 0
        }

    # æ—¶é—´åŸºå‡†ç‚¹
    now = datetime.now()
    today_start = datetime(now.year, now.month, now.day)
    week_ago = today_start - timedelta(days=7)
    month_ago = today_start - timedelta(days=30)

    # ==================== æ•°æ®ç»“æ„åˆå§‹åŒ– ====================

    # ä¸ºæ¯ä¸ªå¸ç§ç»´æŠ¤å¤šå¤´å’Œç©ºå¤´çš„å¼€ä»“é˜Ÿåˆ—
    # é˜Ÿåˆ—ä¸­å­˜å‚¨ [å¼€ä»“æ—¶é—´, å‰©ä½™æ•°é‡]
    long_open_positions = defaultdict(list)
    short_open_positions = defaultdict(list)

    # å­˜å‚¨æ‰€æœ‰å·²é…å¯¹çš„æŒä»“è®°å½• (å¼€ä»“æ—¶é—´, å¹³ä»“æ—¶é—´, æŒä»“æ•°é‡)
    completed_positions = []

    # æŒ‰æ—¶é—´æ’åº
    sorted_fills = sorted(fills, key=lambda x: x.get('time', 0))

    # ==================== ä¸»å¾ªç¯ï¼šéå†æ‰€æœ‰æˆäº¤è®°å½• ====================

    for fill in sorted_fills:
        coin = fill.get('coin', '')
        direction = fill.get('dir', '').strip()
        timestamp = fill.get('time', 0)
        size = abs(float(fill.get('sz', 0)))

        if not coin or not timestamp or size == 0:
            continue

        # æ ‡å‡†åŒ–æ–¹å‘å­—ç¬¦ä¸²ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
        dir_lower = direction.lower()

        # ==================== å¤„ç†å¼€å¤šä»“äº¤æ˜“ ====================
        if 'open long' in dir_lower and 'short' not in dir_lower:
            long_open_positions[coin].append([timestamp, size])

        # ==================== å¤„ç†å¼€ç©ºä»“äº¤æ˜“ ====================
        elif 'open short' in dir_lower and 'long' not in dir_lower:
            short_open_positions[coin].append([timestamp, size])

        # ==================== å¤„ç†å¹³å¤šä»“äº¤æ˜“ï¼ˆæ”¯æŒéƒ¨åˆ†å¹³ä»“ï¼‰====================
        elif 'close long' in dir_lower and 'short' not in dir_lower:
            remaining_size = size

            # å¾ªç¯åŒ¹é…å¼€ä»“è®°å½•ï¼Œç›´åˆ°å…¨éƒ¨å¹³ä»“
            while remaining_size > 1e-9 and long_open_positions[coin]:
                open_time, open_size = long_open_positions[coin][0]

                if open_size <= remaining_size:
                    # å®Œå…¨å¹³æ‰è¿™ç¬”å¼€ä»“
                    completed_positions.append((open_time, timestamp, open_size))
                    remaining_size -= open_size
                    long_open_positions[coin].pop(0)
                else:
                    # éƒ¨åˆ†å¹³ä»“
                    completed_positions.append((open_time, timestamp, remaining_size))
                    long_open_positions[coin][0][1] -= remaining_size
                    remaining_size = 0

        # ==================== å¤„ç†å¹³ç©ºä»“äº¤æ˜“ï¼ˆæ”¯æŒéƒ¨åˆ†å¹³ä»“ï¼‰====================
        elif 'close short' in dir_lower and 'long' not in dir_lower:
            remaining_size = size

            # å¾ªç¯åŒ¹é…å¼€ä»“è®°å½•ï¼Œç›´åˆ°å…¨éƒ¨å¹³ä»“
            while remaining_size > 1e-9 and short_open_positions[coin]:
                open_time, open_size = short_open_positions[coin][0]

                if open_size <= remaining_size:
                    # å®Œå…¨å¹³æ‰è¿™ç¬”å¼€ä»“
                    completed_positions.append((open_time, timestamp, open_size))
                    remaining_size -= open_size
                    short_open_positions[coin].pop(0)
                else:
                    # éƒ¨åˆ†å¹³ä»“
                    completed_positions.append((open_time, timestamp, remaining_size))
                    short_open_positions[coin][0][1] -= remaining_size
                    remaining_size = 0

        # ==================== å¤„ç†ç¿»ä»“äº¤æ˜“ï¼šä»ç©ºç¿»å¤š (Short > Long) ====================
        elif 'short > long' in dir_lower or 'short>long' in dir_lower:
            # å…ˆå¹³æ‰æ‰€æœ‰ç©ºå¤´ä»“ä½
            while short_open_positions[coin]:
                open_time, open_size = short_open_positions[coin].pop(0)
                completed_positions.append((open_time, timestamp, open_size))
            # ç„¶åä½œä¸ºå¼€å¤šä»“å¤„ç†
            long_open_positions[coin].append([timestamp, size])

        # ==================== å¤„ç†ç¿»ä»“äº¤æ˜“ï¼šä»å¤šç¿»ç©º (Long > Short) ====================
        elif 'long > short' in dir_lower or 'long>short' in dir_lower:
            # å…ˆå¹³æ‰æ‰€æœ‰å¤šå¤´ä»“ä½
            while long_open_positions[coin]:
                open_time, open_size = long_open_positions[coin].pop(0)
                completed_positions.append((open_time, timestamp, open_size))
            # ç„¶åä½œä¸ºå¼€ç©ºä»“å¤„ç†
            short_open_positions[coin].append([timestamp, size])

    # ==================== è®¡ç®—æ‰€æœ‰é…å¯¹äº¤æ˜“çš„æŒä»“æ—¶é—´ ====================

    today_hold_times = []
    week_hold_times = []
    month_hold_times = []
    all_hold_times = []

    for open_time, close_time, position_size in completed_positions:
        open_dt = datetime.fromtimestamp(open_time / 1000)
        close_dt = datetime.fromtimestamp(close_time / 1000)

        # è®¡ç®—æŒä»“æ—¶é—´ï¼ˆå¤©æ•°ï¼‰
        hold_time_days = (close_dt - open_dt).total_seconds() / 86400
        all_hold_times.append(hold_time_days)

        # æŒ‰æ—¶é—´æ®µåˆ†ç±»
        if close_dt >= today_start:
            today_hold_times.append(hold_time_days)

        if close_dt >= week_ago:
            week_hold_times.append(hold_time_days)

        if close_dt >= month_ago:
            month_hold_times.append(hold_time_days)

    # ==================== è¿”å›ç»Ÿè®¡ç»“æœ ====================

    return {
        "todayCount": sum(today_hold_times) / len(today_hold_times) if today_hold_times else 0,
        "last7DaysAverage": sum(week_hold_times) / len(week_hold_times) if week_hold_times else 0,
        "last30DaysAverage": sum(month_hold_times) / len(month_hold_times) if month_hold_times else 0,
        "allTimeAverage": sum(all_hold_times) / len(all_hold_times) if all_hold_times else 0
    }
```

### ç®—æ³•æµç¨‹å›¾

```
å¼€å§‹
  â†“
æ£€æŸ¥æ•°æ®æ˜¯å¦ä¸ºç©ºï¼Ÿ
  â†“ æ˜¯
è¿”å›é›¶å€¼ç»“æœ
  â†“ å¦
åˆå§‹åŒ–æ•°æ®ç»“æ„
  â”œâ”€ long_open_positions: å¤šå¤´å¼€ä»“é˜Ÿåˆ—ï¼ˆæŒ‰å¸ç§ï¼‰
  â”œâ”€ short_open_positions: ç©ºå¤´å¼€ä»“é˜Ÿåˆ—ï¼ˆæŒ‰å¸ç§ï¼‰
  â””â”€ completed_positions: å·²é…å¯¹çš„æŒä»“è®°å½•
  â†“
æŒ‰æ—¶é—´æ’åºæˆäº¤è®°å½•
  â†“
éå†æ‰€æœ‰æˆäº¤è®°å½•
  â†“
å¯¹æ¯æ¡è®°å½•ï¼š
  è·å– coin, direction, timestamp, size
  â†“
  åˆ¤æ–­äº¤æ˜“ç±»å‹ï¼š
  â”œâ”€ "Open Long" â†’ æ·»åŠ åˆ° long_open_positions[coin]
  â”œâ”€ "Open Short" â†’ æ·»åŠ åˆ° short_open_positions[coin]
  â”œâ”€ "Close Long" â†’ åŒ¹é… long_open_positions[coin]ï¼ˆFIFOï¼‰
  â”‚   â”œâ”€ å®Œå…¨å¹³ä»“ â†’ è®°å½•æŒä»“ï¼Œç§»é™¤å¼€ä»“è®°å½•
  â”‚   â””â”€ éƒ¨åˆ†å¹³ä»“ â†’ è®°å½•æŒä»“ï¼Œæ›´æ–°å‰©ä½™æ•°é‡
  â”œâ”€ "Close Short" â†’ åŒ¹é… short_open_positions[coin]ï¼ˆFIFOï¼‰
  â”‚   â”œâ”€ å®Œå…¨å¹³ä»“ â†’ è®°å½•æŒä»“ï¼Œç§»é™¤å¼€ä»“è®°å½•
  â”‚   â””â”€ éƒ¨åˆ†å¹³ä»“ â†’ è®°å½•æŒä»“ï¼Œæ›´æ–°å‰©ä½™æ•°é‡
  â”œâ”€ "Short > Long" â†’ å¹³æ‰æ‰€æœ‰ç©ºå¤´ï¼Œå¼€æ–°å¤šå¤´
  â””â”€ "Long > Short" â†’ å¹³æ‰æ‰€æœ‰å¤šå¤´ï¼Œå¼€æ–°ç©ºå¤´
  â†“
æ‰€æœ‰è®°å½•å¤„ç†å®Œæ¯•
  â†“
è®¡ç®—æŒä»“æ—¶é—´
  å¯¹æ¯ä¸ª completed_position:
    - è®¡ç®— hold_time_days = (close_time - open_time) / 86400000
    - æŒ‰å¹³ä»“æ—¶é—´åˆ†ç±»åˆ°ä¸åŒæ—¶é—´æ®µ
  â†“
è®¡ç®—å„æ—¶é—´æ®µå¹³å‡æŒä»“æ—¶é—´
  â”œâ”€ todayCount: ä»Šæ—¥å¹³å‡
  â”œâ”€ last7DaysAverage: æœ€è¿‘7å¤©å¹³å‡
  â”œâ”€ last30DaysAverage: æœ€è¿‘30å¤©å¹³å‡
  â””â”€ allTimeAverage: å…¨éƒ¨æ—¶é—´å¹³å‡
  â†“
è¿”å›ç»Ÿè®¡ç»“æœ
  â†“
ç»“æŸ
```

---

## åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šè¯†åˆ«äº¤æ˜“é£æ ¼

```python
# è®¡ç®—æŒä»“æ—¶é—´
hold_stats = calculate_hold_time_stats(fills)

avg_hold_days = hold_stats['allTimeAverage']

print(f"å¹³å‡æŒä»“æ—¶é—´: {avg_hold_days:.2f} å¤©")

# è¯†åˆ«äº¤æ˜“é£æ ¼
if avg_hold_days < 1/24:  # < 1å°æ—¶
    print("äº¤æ˜“é£æ ¼: è¶…çŸ­çº¿ / é«˜é¢‘äº¤æ˜“")
elif avg_hold_days < 1:  # < 1å¤©
    print("äº¤æ˜“é£æ ¼: æ—¥å†…äº¤æ˜“")
elif avg_hold_days < 7:  # < 1å‘¨
    print("äº¤æ˜“é£æ ¼: çŸ­çº¿äº¤æ˜“")
elif avg_hold_days < 30:  # < 1æœˆ
    print("äº¤æ˜“é£æ ¼: ä¸­çº¿äº¤æ˜“")
else:
    print("äº¤æ˜“é£æ ¼: é•¿çº¿äº¤æ˜“")
```

### åœºæ™¯ 2ï¼šè¶‹åŠ¿åˆ†æ

```python
# å¯¹æ¯”ä¸åŒæ—¶æœŸçš„æŒä»“æ—¶é—´
hold_stats = calculate_hold_time_stats(fills)

print("\næŒä»“æ—¶é—´è¶‹åŠ¿åˆ†æ:")
print(f"ä»Šæ—¥å¹³å‡: {hold_stats['todayCount']:.2f} å¤©")
print(f"æœ€è¿‘7å¤©å¹³å‡: {hold_stats['last7DaysAverage']:.2f} å¤©")
print(f"æœ€è¿‘30å¤©å¹³å‡: {hold_stats['last30DaysAverage']:.2f} å¤©")
print(f"å…¨éƒ¨æ—¶é—´å¹³å‡: {hold_stats['allTimeAverage']:.2f} å¤©")

# åˆ¤æ–­è¶‹åŠ¿
recent = hold_stats['last7DaysAverage']
overall = hold_stats['allTimeAverage']

if recent > overall * 1.2:
    print("\nè¶‹åŠ¿: æŒä»“æ—¶é—´å»¶é•¿ ğŸ“ˆï¼ˆå¯èƒ½è½¬å‘ä¸­é•¿çº¿ï¼‰")
elif recent < overall * 0.8:
    print("\nè¶‹åŠ¿: æŒä»“æ—¶é—´ç¼©çŸ­ ğŸ“‰ï¼ˆå¯èƒ½è½¬å‘çŸ­çº¿ï¼‰")
else:
    print("\nè¶‹åŠ¿: æŒä»“æ—¶é—´ç¨³å®š âš–ï¸")
```

### åœºæ™¯ 3ï¼šç­–ç•¥ä¼˜åŒ–å»ºè®®

```python
def get_strategy_advice(hold_stats: Dict, win_rate: float, profit_factor: float) -> str:
    """æ ¹æ®æŒä»“æ—¶é—´å’Œå…¶ä»–æŒ‡æ ‡ç»™å‡ºå»ºè®®"""
    avg_hold = hold_stats['allTimeAverage']

    if avg_hold < 1:
        # æ—¥å†…äº¤æ˜“
        if win_rate < 55:
            return "âš ï¸ æ—¥å†…äº¤æ˜“èƒœç‡åä½ï¼Œå»ºè®®æé«˜äº¤æ˜“å‡†ç¡®æ€§æˆ–å»¶é•¿æŒä»“"
        elif profit_factor < 1.5:
            return "âš ï¸ æ—¥å†…äº¤æ˜“ç›ˆäºæ¯”ä¸è¶³ï¼Œå»ºè®®ä¼˜åŒ–æ­¢æŸæ­¢ç›ˆç­–ç•¥"
        else:
            return "âœ… æ—¥å†…äº¤æ˜“è¡¨ç°è‰¯å¥½"

    elif avg_hold < 7:
        # çŸ­çº¿äº¤æ˜“
        if profit_factor < 2.0:
            return "âš ï¸ çŸ­çº¿äº¤æ˜“å»ºè®®ç›ˆäºæ¯” > 2.0"
        else:
            return "âœ… çŸ­çº¿äº¤æ˜“è¡¨ç°åˆç†"

    else:
        # ä¸­é•¿çº¿äº¤æ˜“
        if profit_factor < 2.5:
            return "âš ï¸ ä¸­é•¿çº¿äº¤æ˜“å»ºè®®ç›ˆäºæ¯” > 2.5"
        else:
            return "âœ… ä¸­é•¿çº¿äº¤æ˜“è¡¨ç°ä¼˜ç§€"


# ä½¿ç”¨ç¤ºä¾‹
advice = get_strategy_advice(hold_stats, win_rate=60, profit_factor=2.2)
print(advice)
```

---

## å®Œæ•´ä»£ç ç¤ºä¾‹

### ä¸»ç¨‹åºç¤ºä¾‹

```python
from typing import List, Dict
from datetime import datetime, timedelta
from collections import defaultdict


class HoldTimeCalculator:
    """æŒä»“æ—¶é—´ç»Ÿè®¡è®¡ç®—å™¨"""

    def calculate_hold_time_stats(self, fills: List[Dict]) -> Dict[str, float]:
        """è®¡ç®—æŒä»“æ—¶é—´ç»Ÿè®¡"""

        if not fills:
            return self._zero_result()

        # æ—¶é—´åŸºå‡†
        now = datetime.now()
        today_start = datetime(now.year, now.month, now.day)
        week_ago = today_start - timedelta(days=7)
        month_ago = today_start - timedelta(days=30)

        # æ•°æ®ç»“æ„
        long_open_positions = defaultdict(list)
        short_open_positions = defaultdict(list)
        completed_positions = []

        # æŒ‰æ—¶é—´æ’åº
        sorted_fills = sorted(fills, key=lambda x: x.get('time', 0))

        print("\nğŸ“Š æŒä»“æ—¶é—´é…å¯¹åˆ†æ:")
        print("=" * 90)
        print(f"{'åºå·':<6} {'å¸ç§':<8} {'æ–¹å‘':<15} {'æ“ä½œ':<15} {'æ•°é‡':<10} {'çŠ¶æ€'}")
        print("=" * 90)

        # éå†å¤„ç†
        for i, fill in enumerate(sorted_fills, 1):
            coin = fill.get('coin', '')
            direction = fill.get('dir', '').strip()
            timestamp = fill.get('time', 0)
            size = abs(float(fill.get('sz', 0)))

            if not coin or not timestamp or size == 0:
                continue

            dir_lower = direction.lower()
            operation = ""
            status = ""

            # å¼€å¤šä»“
            if 'open long' in dir_lower and 'short' not in dir_lower:
                long_open_positions[coin].append([timestamp, size])
                operation = "å¼€å¤šä»“"
                status = f"âœ… é˜Ÿåˆ—+1"

            # å¼€ç©ºä»“
            elif 'open short' in dir_lower and 'long' not in dir_lower:
                short_open_positions[coin].append([timestamp, size])
                operation = "å¼€ç©ºä»“"
                status = f"âœ… é˜Ÿåˆ—+1"

            # å¹³å¤šä»“
            elif 'close long' in dir_lower and 'short' not in dir_lower:
                remaining_size = size
                matched_count = 0

                while remaining_size > 1e-9 and long_open_positions[coin]:
                    open_time, open_size = long_open_positions[coin][0]

                    matched_size = min(open_size, remaining_size)
                    completed_positions.append((open_time, timestamp, matched_size))

                    if open_size <= remaining_size:
                        remaining_size -= open_size
                        long_open_positions[coin].pop(0)
                    else:
                        long_open_positions[coin][0][1] -= remaining_size
                        remaining_size = 0

                    matched_count += 1

                operation = "å¹³å¤šä»“"
                status = f"âœ… é…å¯¹ {matched_count} ç¬”"

            # å¹³ç©ºä»“
            elif 'close short' in dir_lower and 'long' not in dir_lower:
                remaining_size = size
                matched_count = 0

                while remaining_size > 1e-9 and short_open_positions[coin]:
                    open_time, open_size = short_open_positions[coin][0]

                    matched_size = min(open_size, remaining_size)
                    completed_positions.append((open_time, timestamp, matched_size))

                    if open_size <= remaining_size:
                        remaining_size -= open_size
                        short_open_positions[coin].pop(0)
                    else:
                        short_open_positions[coin][0][1] -= remaining_size
                        remaining_size = 0

                    matched_count += 1

                operation = "å¹³ç©ºä»“"
                status = f"âœ… é…å¯¹ {matched_count} ç¬”"

            # ä»ç©ºç¿»å¤š
            elif 'short > long' in dir_lower or 'short>long' in dir_lower:
                closed_count = len(short_open_positions[coin])
                while short_open_positions[coin]:
                    open_time, open_size = short_open_positions[coin].pop(0)
                    completed_positions.append((open_time, timestamp, open_size))
                long_open_positions[coin].append([timestamp, size])
                operation = "ä»ç©ºç¿»å¤š"
                status = f"âœ… å¹³{closed_count}ç©º å¼€1å¤š"

            # ä»å¤šç¿»ç©º
            elif 'long > short' in dir_lower or 'long>short' in dir_lower:
                closed_count = len(long_open_positions[coin])
                while long_open_positions[coin]:
                    open_time, open_size = long_open_positions[coin].pop(0)
                    completed_positions.append((open_time, timestamp, open_size))
                short_open_positions[coin].append([timestamp, size])
                operation = "ä»å¤šç¿»ç©º"
                status = f"âœ… å¹³{closed_count}å¤š å¼€1ç©º"

            # æ‰“å°è¯¦æƒ…
            print(f"{i:<6} {coin:<8} {direction:<15} {operation:<15} {size:<10.4f} {status}")

        print("=" * 90)

        # è®¡ç®—æŒä»“æ—¶é—´
        today_hold_times = []
        week_hold_times = []
        month_hold_times = []
        all_hold_times = []

        print("\nğŸ“ˆ æŒä»“æ—¶é—´è¯¦ç»†åˆ†æ:")
        print("=" * 90)
        print(f"{'åºå·':<6} {'å¼€ä»“æ—¶é—´':<20} {'å¹³ä»“æ—¶é—´':<20} {'æŒä»“å¤©æ•°':<12} {'åˆ†ç±»'}")
        print("=" * 90)

        for idx, (open_time, close_time, position_size) in enumerate(completed_positions, 1):
            open_dt = datetime.fromtimestamp(open_time / 1000)
            close_dt = datetime.fromtimestamp(close_time / 1000)

            hold_time_days = (close_dt - open_dt).total_seconds() / 86400
            all_hold_times.append(hold_time_days)

            # åˆ†ç±»
            categories = []
            if close_dt >= today_start:
                today_hold_times.append(hold_time_days)
                categories.append("ä»Šæ—¥")

            if close_dt >= week_ago:
                week_hold_times.append(hold_time_days)
                if "ä»Šæ—¥" not in categories:
                    categories.append("æœ¬å‘¨")

            if close_dt >= month_ago:
                month_hold_times.append(hold_time_days)
                if not categories:
                    categories.append("æœ¬æœˆ")

            if not categories:
                categories.append("å†å²")

            category_str = "/".join(categories)

            # æ ¼å¼åŒ–æ—¶é—´
            open_str = open_dt.strftime('%Y-%m-%d %H:%M:%S')
            close_str = close_dt.strftime('%Y-%m-%d %H:%M:%S')

            # æ‰“å°ï¼ˆåªæ˜¾ç¤ºå‰20ç¬”ï¼‰
            if idx <= 20:
                print(f"{idx:<6} {open_str:<20} {close_str:<20} {hold_time_days:<11.2f}å¤© {category_str}")

        if len(completed_positions) > 20:
            print(f"... çœç•¥ {len(completed_positions) - 20} ç¬” ...")

        print("=" * 90)

        # è®¡ç®—ç»Ÿè®¡ç»“æœ
        result = {
            "todayCount": sum(today_hold_times) / len(today_hold_times) if today_hold_times else 0,
            "last7DaysAverage": sum(week_hold_times) / len(week_hold_times) if week_hold_times else 0,
            "last30DaysAverage": sum(month_hold_times) / len(month_hold_times) if month_hold_times else 0,
            "allTimeAverage": sum(all_hold_times) / len(all_hold_times) if all_hold_times else 0
        }

        # æ‰“å°ç»Ÿè®¡ç»“æœ
        print(f"\nğŸ¯ æŒä»“æ—¶é—´ç»Ÿè®¡:")
        print("=" * 90)
        print(f"ä»Šæ—¥å¹³å‡æŒä»“: {result['todayCount']:.2f} å¤© ({len(today_hold_times)} ç¬”)")
        print(f"æœ€è¿‘7å¤©å¹³å‡: {result['last7DaysAverage']:.2f} å¤© ({len(week_hold_times)} ç¬”)")
        print(f"æœ€è¿‘30å¤©å¹³å‡: {result['last30DaysAverage']:.2f} å¤© ({len(month_hold_times)} ç¬”)")
        print(f"å…¨éƒ¨æ—¶é—´å¹³å‡: {result['allTimeAverage']:.2f} å¤© ({len(all_hold_times)} ç¬”)")

        # äº¤æ˜“é£æ ¼åˆ¤æ–­
        avg_hold = result['allTimeAverage']
        if avg_hold < 1/24:
            style = "è¶…çŸ­çº¿ / é«˜é¢‘äº¤æ˜“"
        elif avg_hold < 1:
            style = "æ—¥å†…äº¤æ˜“"
        elif avg_hold < 7:
            style = "çŸ­çº¿äº¤æ˜“"
        elif avg_hold < 30:
            style = "ä¸­çº¿äº¤æ˜“"
        else:
            style = "é•¿çº¿äº¤æ˜“"

        print(f"\näº¤æ˜“é£æ ¼: {style}")

        return result

    def _zero_result(self) -> Dict[str, float]:
        """è¿”å›é›¶å€¼ç»“æœ"""
        return {
            "todayCount": 0,
            "last7DaysAverage": 0,
            "last30DaysAverage": 0,
            "allTimeAverage": 0
        }


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    calculator = HoldTimeCalculator()

    # æ¨¡æ‹Ÿäº¤æ˜“æ•°æ®
    import time
    current_time = int(time.time() * 1000)

    fills = [
        # ç¬¬1ç»„ï¼šBTC å¤šå¤´äº¤æ˜“
        {"coin": "BTC", "dir": "Open Long", "time": current_time - 10 * 86400000, "sz": "1.0"},
        {"coin": "BTC", "dir": "Close Long", "time": current_time - 8 * 86400000, "sz": "0.5"},  # éƒ¨åˆ†å¹³ä»“
        {"coin": "BTC", "dir": "Close Long", "time": current_time - 7 * 86400000, "sz": "0.5"},  # å‰©ä½™å¹³ä»“

        # ç¬¬2ç»„ï¼šETH ç©ºå¤´äº¤æ˜“
        {"coin": "ETH", "dir": "Open Short", "time": current_time - 6 * 86400000, "sz": "10.0"},
        {"coin": "ETH", "dir": "Close Short", "time": current_time - 4 * 86400000, "sz": "10.0"},

        # ç¬¬3ç»„ï¼šBTC ç¿»ä»“äº¤æ˜“
        {"coin": "BTC", "dir": "Open Short", "time": current_time - 3 * 86400000, "sz": "2.0"},
        {"coin": "BTC", "dir": "Short > Long", "time": current_time - 1 * 86400000, "sz": "1.5"},  # ç¿»ä»“

        # ç¬¬4ç»„ï¼šSOL æ—¥å†…äº¤æ˜“
        {"coin": "SOL", "dir": "Open Long", "time": current_time - 12 * 3600000, "sz": "100.0"},
        {"coin": "SOL", "dir": "Close Long", "time": current_time - 6 * 3600000, "sz": "100.0"},
    ]

    # è®¡ç®—æŒä»“æ—¶é—´
    result = calculator.calculate_hold_time_stats(fills)
```

---

## æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•ç”¨ä¾‹ 1ï¼šç®€å•å¼€å¹³ä»“

```python
def test_simple_open_close():
    """æµ‹è¯•ç”¨ä¾‹ 1: ç®€å•å¼€å¹³ä»“"""
    calculator = HoldTimeCalculator()

    fills = [
        {"coin": "BTC", "dir": "Open Long", "time": 1000000, "sz": "1.0"},
        {"coin": "BTC", "dir": "Close Long", "time": 1000000 + 86400000, "sz": "1.0"},  # 1å¤©å
    ]

    result = calculator.calculate_hold_time_stats(fills)

    assert abs(result['allTimeAverage'] - 1.0) < 0.01  # åº”è¯¥æ˜¯1å¤©
    print("âœ… æµ‹è¯•ç”¨ä¾‹ 1 é€šè¿‡ï¼šç®€å•å¼€å¹³ä»“")
```

### æµ‹è¯•ç”¨ä¾‹ 2ï¼šéƒ¨åˆ†å¹³ä»“

```python
def test_partial_close():
    """æµ‹è¯•ç”¨ä¾‹ 2: éƒ¨åˆ†å¹³ä»“"""
    calculator = HoldTimeCalculator()

    fills = [
        {"coin": "BTC", "dir": "Open Long", "time": 1000000, "sz": "2.0"},
        {"coin": "BTC", "dir": "Close Long", "time": 1000000 + 86400000, "sz": "1.0"},  # 1å¤©åå¹³ä¸€åŠ
        {"coin": "BTC", "dir": "Close Long", "time": 1000000 + 2 * 86400000, "sz": "1.0"},  # 2å¤©åå¹³å‰©ä½™
    ]

    result = calculator.calculate_hold_time_stats(fills)

    # å¹³å‡æŒä»“ = (1å¤© + 2å¤©) / 2 = 1.5å¤©
    assert abs(result['allTimeAverage'] - 1.5) < 0.01
    print("âœ… æµ‹è¯•ç”¨ä¾‹ 2 é€šè¿‡ï¼šéƒ¨åˆ†å¹³ä»“")
```

### æµ‹è¯•ç”¨ä¾‹ 3ï¼šå¤šç©ºåˆ†ç¦»

```python
def test_long_short_separation():
    """æµ‹è¯•ç”¨ä¾‹ 3: å¤šç©ºåˆ†ç¦»é…å¯¹"""
    calculator = HoldTimeCalculator()

    fills = [
        {"coin": "BTC", "dir": "Open Long", "time": 1000000, "sz": "1.0"},
        {"coin": "BTC", "dir": "Open Short", "time": 2000000, "sz": "2.0"},
        {"coin": "BTC", "dir": "Close Long", "time": 3000000, "sz": "1.0"},  # åº”åŒ¹é…ç¬¬1ç¬”
        {"coin": "BTC", "dir": "Close Short", "time": 4000000, "sz": "2.0"},  # åº”åŒ¹é…ç¬¬2ç¬”
    ]

    result = calculator.calculate_hold_time_stats(fills)

    # ä¸¤ç¬”äº¤æ˜“çš„å¹³å‡æŒä»“æ—¶é—´
    assert result['allTimeAverage'] > 0
    print("âœ… æµ‹è¯•ç”¨ä¾‹ 3 é€šè¿‡ï¼šå¤šç©ºåˆ†ç¦»é…å¯¹")
```

### æµ‹è¯•ç”¨ä¾‹ 4ï¼šç¿»ä»“äº¤æ˜“

```python
def test_flip_positions():
    """æµ‹è¯•ç”¨ä¾‹ 4: ç¿»ä»“äº¤æ˜“"""
    calculator = HoldTimeCalculator()

    fills = [
        {"coin": "BTC", "dir": "Open Short", "time": 1000000, "sz": "1.0"},
        {"coin": "BTC", "dir": "Short > Long", "time": 2000000, "sz": "2.0"},  # ç¿»ä»“
        {"coin": "BTC", "dir": "Close Long", "time": 3000000, "sz": "2.0"},
    ]

    result = calculator.calculate_hold_time_stats(fills)

    # åº”è¯¥æœ‰2ç¬”å®Œæˆçš„æŒä»“è®°å½•
    assert result['allTimeAverage'] > 0
    print("âœ… æµ‹è¯•ç”¨ä¾‹ 4 é€šè¿‡ï¼šç¿»ä»“äº¤æ˜“")
```

### æµ‹è¯•ç”¨ä¾‹ 5ï¼šFIFO åŸåˆ™

```python
def test_fifo_principle():
    """æµ‹è¯•ç”¨ä¾‹ 5: FIFO å…ˆè¿›å…ˆå‡ºåŸåˆ™"""
    calculator = HoldTimeCalculator()

    fills = [
        {"coin": "BTC", "dir": "Open Long", "time": 1000000, "sz": "1.0"},  # ç¬¬1ç¬”å¼€ä»“
        {"coin": "BTC", "dir": "Open Long", "time": 2000000, "sz": "1.0"},  # ç¬¬2ç¬”å¼€ä»“
        {"coin": "BTC", "dir": "Close Long", "time": 3000000, "sz": "1.0"},  # åº”å…ˆåŒ¹é…ç¬¬1ç¬”
    ]

    # ç”±äº FIFOï¼Œåº”è¯¥åŒ¹é…ç¬¬1ç¬”ï¼ˆæŒä»“2å¤©ï¼‰
    # è€Œä¸æ˜¯ç¬¬2ç¬”ï¼ˆæŒä»“1å¤©ï¼‰
    # ä½†è¿™ä¸ªæµ‹è¯•éœ€è¦æŸ¥çœ‹å†…éƒ¨é€»è¾‘ï¼Œè¿™é‡ŒåªéªŒè¯æœ‰ç»“æœ
    result = calculator.calculate_hold_time_stats(fills)

    assert result['allTimeAverage'] > 0
    print("âœ… æµ‹è¯•ç”¨ä¾‹ 5 é€šè¿‡ï¼šFIFO åŸåˆ™")
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```python
if __name__ == "__main__":
    print("å¼€å§‹è¿è¡ŒæŒä»“æ—¶é—´ç»Ÿè®¡æµ‹è¯•ç”¨ä¾‹...\n")

    test_simple_open_close()
    test_partial_close()
    test_long_short_separation()
    test_flip_positions()
    test_fifo_principle()

    print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡ï¼")
```

---

## ç®—æ³•ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| âœ… **å¤šç©ºåˆ†ç¦»** | æ­£ç¡®åŒºåˆ†å¤šå¤´å’Œç©ºå¤´ä»“ä½ |
| âœ… **éƒ¨åˆ†å¹³ä»“** | æ”¯æŒéƒ¨åˆ†å¹³ä»“çš„å‡†ç¡®è®¡ç®— |
| âœ… **FIFO åŸåˆ™** | å…ˆè¿›å…ˆå‡ºï¼Œç¡®ä¿é…å¯¹å‡†ç¡® |
| âœ… **ç¿»ä»“å¤„ç†** | æ­£ç¡®å¤„ç†ç¿»ä»“äº¤æ˜“ |
| âœ… **æ—¶é—´æ®µç»Ÿè®¡** | æä¾›å¤šä¸ªæ—¶é—´ç»´åº¦çš„åˆ†æ |

---

## å‚è€ƒèµ„æ–™

- **Hyperliquid API æ–‡æ¡£**: https://hyperliquid.gitbook.io/hyperliquid-docs/for-developers/api
- **Apex Liquid Bot**: https://apexliquid.bot/
- **æºä»£ç **: apex_fork.py (è¡Œ 430-585)

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-02-03
**ä½œè€…**: Apex Calculator Team
